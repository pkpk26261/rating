<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ“Š</text></svg>">
  <title>æˆç¸¾ç®¡ç†ç³»çµ±</title>
  <style>
    /* ===== ä½ˆæ™¯ä¸»é¡Œ ===== */
    /* â˜… æ—‹è½‰æ™‚çš„ä¿åº•åº•è‰²ï¼Œé¿å…éœ²ç™½ï¼ˆæ”¾åœ¨ htmlï¼Œä¸æ”¾ bodyï¼‰ */
    html{ background: var(--bg); }
    body{ background: transparent; }


    :root{
      --bg:#0b1220; --fg:#e2e8f0; --muted:#94a3b8;
      --card:#0f172a; --line:#1f2a44;
      --seat:#0ea5e9; --scorechip:#0b1220;
      --gold:#f59e0b; --silver:#9ca3af; --bronze:#d97706; --rank4:#60a5fa; --rank5:#34d399;
      --accent:#7c3aed; --accent-2:#22d3ee; --ok:#16a34a; --bad:#dc2626;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --chip-fz:14px;
      --chip-py:8

    /* â˜… åˆªé™¤å­¸ç”Ÿæ¸…å–®ï¼šåº§è™Ÿ/å§“åå°é½Šï¼ˆç­‰å¯¬å­—ï¼‹è¡¨æ ¼æ•¸å­—ï¼‰ */
    #del-stu-select{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-variant-numeric: tabular-nums;
      white-space: pre; /* è®“ padStart/padEnd ç”¨çš„ç©ºç™½èƒ½é¡¯ç¤º */
    }
    #del-stu-select option{
      font-family: inherit;
      white-space: pre;
    }
px;
      --chip-px:12px;
      --page-x: 10px;
      --list-cols: 6;
      --sidebar-w: 320px; /* â˜… æ–°å¢ï¼šå´æ¬„å±•é–‹å¯¬åº¦ */
    }

    /* â˜… æ·ºè‰²ä¸»é¡Œè¦†å¯«ï¼šç•¶ <html data-theme="light"> æ™‚å¥—ç”¨ */
    :root[data-theme="light"]{
      --bg:#f7fafc;                  /* é é¢èƒŒæ™¯åŸºåº• */
      --fg:#0f172a;                  /* å…§æ–‡å­—è‰² */
      --muted:#475569;               /* æ¬¡è¦æ–‡å­— */
      --card:#ffffff;                /* å¡ç‰‡/æŒ‰éˆ•åº•è‰² */
      --line:#e2e8f0;                /* é‚Šæ¡†è‰² */
      --seat:#0284c7;                /* åº§è™Ÿå¾½ç« ä¸»è‰² */
      --scorechip:#f1f5f9;           /* åˆ†æ•¸è§’æ¨™åº•è‰² */
      --gold:#eab308; --silver:#94a3b8; --bronze:#d97706; --rank4:#3b82f6; --rank5:#10b981;
      --accent:#7c3aed; --accent-2:#06b6d4;
      --ok:#16a34a; --bad:#dc2626;
      --shadow: 0 8px 24px rgba(0,0,0,.08);
    }

    /* â˜… æ·ºè‰²ä¸»é¡Œï¼šå°‘æ•¸ä½¿ç”¨ç¡¬ç·¨é¡è‰²çš„å…ƒä»¶åšé¡å¤–è¦†å¯« */
    /* ===== å‹•æ…‹èƒŒæ™¯ï¼ˆæ·ºè‰²ï¼‰è¦†å¯« ===== */
        /* ===== å‹•æ…‹èƒŒæ™¯ï¼ˆæ·ºè‰²ï¼‰è¦†å¯« ===== */
    :root[data-theme="light"] body::before{
      background:
        radial-gradient(40% 45% at 18% 22%, rgba(124,58,237,.18), transparent 68%),
        radial-gradient(55% 55% at 84% 18%, rgba(6,182,212,.14), transparent 70%),
        radial-gradient(50% 55% at 58% 88%, rgba(2,132,199,.12), transparent 72%),
        radial-gradient(60% 60% at 45% 55%, rgba(15,23,42,.05), transparent 70%),
        linear-gradient(180deg, #f8fafc 0%, #eef2ff 100%);
      background-repeat:no-repeat;
      background-size: 190% 190%, 180% 180%, 200% 200%, 160% 160%, 100% 100%;
      background-position: 18% 22%, 84% 18%, 58% 88%, 50% 55%, 50% 0%;
      filter: blur(34px) saturate(1.05);
      opacity:1;
    }

:root[data-theme="light"] body::after{
      opacity:.6;
      mix-blend-mode: multiply;
    }

    :root[data-theme="light"] .topbar{
      background: rgba(255,255,255,.82);
      border-bottom-color: var(--line);
    }
    :root[data-theme="light"] .seg{
      background: rgba(2,6,23,.04);
    }
    :root[data-theme="light"] .hwtbl th{
      background: rgba(255,255,255,.9);
    }
    :root[data-theme="light"] .dropmask{
      background: rgba(15,23,42,.15);
    }
    :root[data-theme="light"] .modal{ width:min(760px, 92vw); max-height: 82vh; overflow:auto; border:1px solid var(--line); border-radius:18px; box-shadow: 0 18px 70px rgba(0,0,0,.35); background: var(--card); }
    :root[data-theme="light"] .unassigned .list::-webkit-scrollbar-track{
      background: rgba(2,6,23,.06);
    }

    /* â˜… æ·ºè‰²ä¸»é¡Œï¼šè¬›å°æ”¹ç‚ºå–®è‰²ï¼ˆå»é™¤æ¼¸å±¤ï¼‰ */
    :root[data-theme="light"] .stage{
      /* å–®è‰²åº•ï¼šç”¨ä¸»è‰²ç³»èª¿ç™½ï¼Œç„¡æ¼¸å±¤ */
      background: color-mix(in oklab, var(--accent) 14%, white);
      /* é‚Šæ¡†ä¹Ÿå¸¶é»ä¸»è‰²ï¼Œç¶­æŒè¼•é‡å°æ¯” */
      border-color: color-mix(in oklab, var(--accent) 22%, var(--line));
      /* æ–‡å­—èˆ‡å°åœ“é»è·Ÿè‘—ä¸»è‰²ç³»ï¼Œæå‡è¾¨è­˜ */
      color: color-mix(in oklab, var(--accent) 66%, black);
      /* è¦–è¦ºæ›´ä¹¾æ·¨ï¼Œå¯ä¿ç•™æˆ–èª¿æ·¡æŠ•å½± */
      box-shadow: 0 6px 18px rgba(0,0,0,.06);
    }


    *{box-sizing:border-box}
    html,body{height:100%}
    html,body{overflow-x:hidden}
    body{margin:0; color:var(--fg); font-family: ui-sans-serif,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans TC","Helvetica Neue",Arial;}

        /* ===== å‹•æ…‹èƒŒæ™¯ï¼ˆæ·±è‰²ï¼‰â€” Aurora ç‰ˆï¼ˆä½å¹²æ“¾ï¼‰ ===== */
    body::before{
      content:"";
      position:fixed;
      inset:-28vmax;                 /* è¦†è“‹åˆ°å°è§’ï¼Œé¿å…éœ²é‚Š */
      z-index:-2;
      pointer-events:none;
      background:
        radial-gradient(40% 45% at 18% 22%, rgba(124,58,237,.36), transparent 68%),
        radial-gradient(55% 55% at 84% 18%, rgba(34,211,238,.26), transparent 70%),
        radial-gradient(50% 55% at 58% 88%, rgba(14,165,233,.18), transparent 72%),
        radial-gradient(60% 60% at 45% 55%, rgba(255,255,255,.03), transparent 70%),
        linear-gradient(180deg, #0b1220 0%, #08101e 100%);
      background-repeat:no-repeat;
      background-size: 190% 190%, 180% 180%, 200% 200%, 160% 160%, 100% 100%;
      background-position: 18% 22%, 84% 18%, 58% 88%, 50% 55%, 50% 0%;
      filter: blur(42px) saturate(1.15);
      opacity:.95;
      transform: translate3d(0,0,0) scale(1.08);
      animation:
        auroraDrift 26s ease-in-out infinite alternate,
        auroraBreathe 78s ease-in-out infinite alternate;
      will-change: transform, background-size, background-position;
      backface-visibility: hidden;
    }

/* å™ªé»å±¤ï¼ˆè¦†åœ¨æ¼¸å±¤ä¸Šæ–¹ï¼‰ */
    body::after{
      content:"";
      position:fixed;
      inset:0;
      z-index:-1;                 /* æ¯” ::before é«˜ä¸€å±¤ */
      pointer-events:none;
      background-image:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" opacity="0.05"><filter id="n"><feTurbulence baseFrequency="0.75" numOctaves="4"/></filter><rect width="100%" height="100%" filter="url(%23n)"/></svg>');
      background-size:300px 300px;
      mix-blend-mode:soft-light;
    }


        @keyframes auroraDrift{
      0%{
        transform: translate3d(-2%, -1%, 0) scale(1.06);
        background-position: 18% 22%, 84% 18%, 58% 88%, 50% 55%, 50% 0%;
      }
      100%{
        transform: translate3d(2%, 1%, 0) scale(1.10);
        background-position: 24% 30%, 76% 10%, 62% 82%, 48% 50%, 50% 0%;
      }
    }

}
        @keyframes auroraBreathe{
      0%  { background-size: 175% 175%, 165% 165%, 185% 185%, 150% 150%, 100% 100%; }
      100%{ background-size: 205% 205%, 185% 185%, 215% 215%, 170% 170%, 100% 100%; }
    }

100%{ background-size: 190% 190%, 170% 170%, 100% 100%; }
    }

    /* å‹•æ…‹æ¸›å¼±åå¥½æ™‚åœç”¨å‹•ç•« */
    @media (prefers-reduced-motion: reduce){
      body::before{ animation:none; transform:none; }
    }


    /* æ¸›å°‘å‹•æ…‹åå¥½æ™‚ï¼Œåœç”¨å‹•ç•« */
    @media (prefers-reduced-motion: reduce){
      body::before{ animation:none; }
    }
    /* ===== é ‚éƒ¨åˆ— ===== */
    .topbar{
      position:sticky; top:0; z-index:20;
      display:grid; grid-template-columns: 1fr auto 1fr; align-items:center;
      min-height:78px; height:auto; padding-block:10px; border-bottom:1px solid var(--line);
      background:rgba(15,23,42,.75); backdrop-filter: blur(8px);
      padding-inline: var(--page-x);
    }
    .topbar__left, .topbar__right{ display:flex; gap:8px; align-items:center; padding-inline: var(--page-x); }
    .dt-display{ display:flex; flex-direction:column; align-items:flex-end; gap:2px; font-size:12px; line-height:1.1; opacity:.92; user-select:none; }
    
    /* ===== åŒ¯å…¥å€ï¼šç‹€æ…‹é¡¯ç¤ºåœ¨åŒ¯å…¥æŒ‰éˆ•ä¸‹æ–¹ï¼ˆé«˜åº¦ä¸å®œéé«˜ï¼‰ ===== */
    .import-block{ display:flex; flex-direction:column; gap:4px; }
    .status-inline{
      font-size:12px;
      line-height:1.2;
      opacity:.88;
      max-width: 340px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      padding:0;
      margin:0 0 0 2px;
    }
.topbar__left{ justify-self:start; }
    .topbar__right{ justify-self:end; }
    .title-stack{ grid-column:2; display:flex; flex-direction:column; align-items:center; gap:6px; line-height:1.1; }
    .title{ font-weight:900; letter-spacing:0.06em; margin:0; font-size:20px; }
    .title::after{ content:""; display:block; margin:6px auto 0; width:64px; height:2px; border-radius:2px; background: linear-gradient(90deg, var(--accent), var(--accent-2)); opacity:.6; }
    /* ===== å®¹å™¨ ===== */
    .app{ width:100%; margin:0; height:100svh; display:grid; grid-template-rows: auto 1fr; }
    .layout{
      position: relative;                     /* â˜… è®“æ”¶åˆæŒ‰éˆ•å¯çµ•å°å®šä½æ–¼ layout å…§ */
      display:grid;
      grid-template-columns: var(--sidebar-w) 1fr;  /* â˜… ç”¨è®Šæ•¸æ§åˆ¶å´æ¬„å¯¬ */
      gap:16px;
      padding: var(--page-x);
      grid-template-rows: 1fr;
      align-items: stretch;
      min-height:0; height:100%;
      transition: grid-template-columns .25s ease;  /* å¹³æ»‘ä¼¸ç¸® */
    }

    /* å´æ¬„å¯ä»¥è¢«éš±è—ï¼æ»‘å‹• */
    .sidebar{
      overflow:hidden;
      transition: transform .25s ease, opacity .2s ease;
      will-change: transform;
    }

    /* â˜… æ”¶åˆç‹€æ…‹ï¼šæŠŠç¬¬ä¸€æ¬„å¯¬åº¦è®Š 0ï¼Œä¸»å€å¡«æ»¿ */
    .layout.is-collapsed{
      grid-template-columns: 0px 1fr;
    }
    .layout.is-collapsed .sidebar{
      opacity:0;
      pointer-events:none;
      transform: translateX(calc(-1 * var(--sidebar-w))); /* æ”¶åˆæ™‚æ»‘å‡ºå»ä¸€é»ï¼Œè¦–è¦ºæ›´è‡ªç„¶ */
    }
    /* â˜… å·¦å´ç´°é•·æŒ‰éˆ•ï¼ˆå›ºå®šåœ¨ layout å·¦é‚Šç•Œï¼‰ */
    .side-toggle{
      position:absolute;
      z-index:25;
      /* å±•é–‹æ™‚ï¼ŒæŒ‰éˆ•é åœ¨ã€Œå´æ¬„èˆ‡ä¸»å€ã€çš„äº¤ç•Œï¼›+6px è®“å®ƒç•¥å¾®å‡¸å‡º */
      left: calc(var(--sidebar-w) + 6px);
      top: 50%;
      transform: translate(-50%, -50%);  /* å‚ç›´ç½®ä¸­ï¼Œæ°´å¹³å¾€å·¦åŠå€‹å¯¬ */
      width: 26px;
      height: 160px;        /* é•·æ¢æ„Ÿ */
      display:flex; align-items:center; justify-content:center;
      border:1px solid var(--line);
      border-radius:12px;
      background: var(--card);
      color: var(--fg);
      box-shadow: var(--shadow);
      cursor:pointer; user-select:none;
      font-size:18px; font-weight:900;   /* é¡¯çœ¼çš„ç®­é ­ */
      transition: left .25s ease, transform .25s ease, box-shadow .2s ease;
    }
    .side-toggle:hover{ box-shadow:0 10px 24px rgba(0,0,0,.28); }

    /* æ”¶åˆå¾Œï¼ŒæŠŠæŒ‰éˆ•ç§»åˆ°æœ€å·¦é‚Š 8px è™•ï¼ˆæ–¹ä¾¿é»é–‹ï¼‰ */
    .layout.is-collapsed .side-toggle{
      left: 8px;
    }

    

    /* â˜… åªæœ‰ã€ŒåŠ æ‰£åˆ†(åˆ—è¡¨)ã€æ¨¡å¼é¡¯ç¤º sidebarï¼›å…¶ä»–æ¨¡å¼å®Œå…¨éš±è— sidebar */
    .layout.sidebar-off{
      grid-template-columns: 1fr !important;
    }
    .layout.sidebar-off .sidebar{ display:none !important; }
    .layout.sidebar-off .side-toggle{ display:none !important; }

    /* æ‰‹æ©Ÿä¸€æ¬„å¼æ™‚ï¼Œé€™é¡†æŒ‰éˆ•é€šå¸¸ä¸éœ€è¦ï¼Œç›´æ¥éš±è—ï¼ˆè¦ä¿ç•™å°±åˆªæ‰é€™æ®µï¼‰ */
    @media (max-width: 880px){
      .side-toggle{ display:none; }
    }

    .sidebar,.main{
      border:1px solid var(--line); border-radius:16px; padding:16px;
      background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01)); box-shadow: var(--shadow);
      min-height:0;
      min-width: 0;
    }
    /* ===== é¡¯ç¤ºæ¨¡å¼åˆ—ï¼ˆåœ¨ main å¤–ã€ä¸Šæ–¹å³ä¸Šè§’ï¼‰ ===== */
    .main-col{
      min-height:0;
      min-width:0;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .modebar{
      display:flex;
      justify-content:center;
      align-items:center;
      flex-wrap:wrap;
      gap:8px;
      margin-top:4px;
    }
    /* è®“ main åœ¨ main-col å…§æ’æ»¿å‰©é¤˜é«˜åº¦ */
    .main-col > .main{
      flex:1;
      min-height:0;
    }
    /* å°è¢å¹•æ™‚ï¼Œå³ä¸Šè§’å®¹æ˜“æ“ ï¼šæ”¹ç‚ºé å·¦ã€è‡ªç„¶æ›è¡Œ */
    @media (max-width: 880px){
      .modebar{ justify-content:center; }
    }
    /* è®“ main æœ¬èº«ä¸è¢«å…§å®¹æ’ç ´ï¼›ä¸‹é¢çš„å…§å®¹å€æœƒå„è‡ªæ»¾å‹• */
    .main{
      display:flex;
      flex-direction:column;
      min-height:0;   /* é—œéµï¼šå…è¨±ç¸®åˆ°å¯ç”¨é«˜åº¦ */
      min-width:0;
      overflow:hidden; /* é˜»æ­¢è¶…å‡ºé‚Šç•Œï¼›çœŸæ­£çš„æ²å‹•äº¤çµ¦å­å€å¡Š */
    }
    /* è®“ä¸‰å€‹æ¨¡å¼çš„å…§å®¹å€å¡Šå¡«æ»¿å‰©é¤˜é«˜åº¦ï¼Œä¸¦åœ¨å€å¡Šå…§æ²å‹• */
    .main > .grid,
    .main > .seatwrap{
      flex:1 1 auto; min-height:0; overflow:auto;
    }
    .main > #hw-pane{
      display:flex;
      flex-direction:column;
      flex:1 1 auto;
      min-height:0;
      overflow:hidden; /* æ²å‹•åªåœ¨ .hwtbl-wrap */
    }
    /* è®“ã€ŒæŠ½è™Ÿã€é è·Ÿä½œæ¥­é ä¸€æ¨£åƒæ»¿ main çš„å¯ç”¨é«˜åº¦ */
    .main > #draw-pane{
      display: flex;
      flex-direction: column;
      flex: 1 1 auto;
      min-height: 0;      /* é—œéµï¼šå…è¨±ç¸®åˆ°å¯ç”¨é«˜åº¦ */
      overflow: hidden;   /* è£¡é¢è‡ªå·±æ»¾å‹• */
    }

    /* è®“å…§å±¤ grid å¡«æ»¿çˆ¶å±¤é«˜åº¦ï¼›éœ€è¦æ™‚åœ¨å®ƒè£¡é¢æ²å‹• */
    #draw-pane .draw-wrap{
      flex: 1 1 auto;
      min-height: 0;
      height: 100%;
      overflow: auto;     /* è‹¥ä¸æƒ³æ•´å¼µé æ²å‹•ï¼ŒæŠŠæ»¾å‹•äº¤çµ¦é€™å±¤ */
    }

    #draw-pane .draw-history-wrap{
      flex: 1 1 auto;
      min-height: 0;
      overflow: auto;
    }


    .sidebar{ display:flex; flex-direction:column; gap:16px; padding-bottom:0; }
    .statusbar{ margin-top:auto; }
    .statusbar .hint{ display:block; margin:0; padding:12px 0; border-top:1px solid var(--line); }

    /* ===== æ§åˆ¶åˆ— / Segmented ===== */
    .controls-row{ display:flex; gap:12px; align-items:center; flex-wrap:wrap; padding-inline: 0px; padding-top: 0px; }
    .controls-row .seg{ margin-left:auto; }
    .select,.input{ appearance:none; background:var(--card); color:var(--fg); border:1px solid var(--line); border-radius:12px; padding:10px 14px; }
    .select{ min-width:220px; } .input{ min-width:240px; outline:none; box-shadow: inset 0 0 0 1px rgba(255,255,255,.03); }
    .input:focus{ border-color: color-mix(in oklab, var(--accent) 60%, #000); box-shadow: 0 0 0 4px rgba(124,58,237,.15); }

    .seg{ display:flex; gap:8px; border:1px solid var(--line); border-radius:12px; padding:4px; background:rgba(255,255,255,.04); }
    .seg-btn{ appearance:none; border:0; background:transparent; color:var(--fg); padding:8px 12px; border-radius:8px; cursor:pointer; font-weight:800; font-size:13px; }
    .seg-btn.active{ background:rgba(124,58,237,.25); box-shadow: inset 0 0 0 1px rgba(255,255,255,.06); }

    /* ===== é€šç”¨æŒ‰éˆ• + Ripple ===== */
    .btn{ position:relative; overflow:hidden; display:inline-flex; align-items:center; justify-content:center; gap:8px; border:1px solid var(--line); padding:10px 14px; border-radius:12px; cursor:pointer; transition: transform .06s, background .2s, border-color .2s, box-shadow .2s; user-select:none; font-size:14px; color:var(--fg); background:var(--card); }
    .btn:hover{ box-shadow:0 6px 18px rgba(0,0,0,.28), inset 0 0 0 1px rgba(255,255,255,.03); }
    .btn:active{ transform: translateY(1px); }
    .btn.add{ background-color:color-mix(in oklab, var(--ok) 22%, black); border-color: color-mix(in oklab, var(--ok) 60%, black); color:white; }
    .btn.add:hover{ background-color: color-mix(in oklab, var(--ok) 36%, black); }
    .btn.sub{ background-color:color-mix(in oklab, var(--bad) 24%, black); border-color: color-mix(in oklab, var(--bad) 60%, black); color:white; }

    /* ä½œæ¥­æˆç¸¾ï¼šå­¸ç”Ÿå‚™è¨»æŒ‰éˆ•ï¼ˆåº§è™Ÿå‰ï¼‰ */
    .note-btn{
      display:inline-flex; align-items:center; justify-content:center;
      width:22px; height:22px; margin-right:6px;
      border:1px solid var(--line); background:rgba(255,255,255,.02);
      border-radius:8px; cursor:pointer;
      user-select:none;
    }
    .note-btn:hover{ filter:brightness(1.1); }
    .hw-seatcell{ display:flex; align-items:center; gap:6px; }
    .hw-seattext{ display:inline-block; min-width: 24px; }

    /* ä½œæ¥­æˆç¸¾ï¼šå­¸ç”Ÿå‚™è¨»å½ˆçª—ï¼ˆåŠ å¤§è¼¸å…¥æ¬„ä½ï¼‰ */
    #note-mask .modal{ width:min(920px, 96vw); max-height: 88vh; }

    /* æ“ä½œèªªæ˜å½ˆçª—ï¼šå¯¬åº¦å†åŠ å¯¬ä¸€é»ï¼Œå­—æ¯”è¼ƒå¥½æ’ */
    #help-mask .modal{ width:min(980px, 96vw); max-height: 88vh; }
    #note-mask .content{ display:flex; flex-direction:column; gap:10px; }
    #note-mask .note-meta{ display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
    #note-mask .note-help{ font-size:12px; opacity:.8; }
    #note-mask .note-count{ margin-left:auto; font-size:12px; opacity:.8; }
    #note-text{
      width:100%;
      min-height: 240px;
      height: 300px;
      resize: vertical;
      padding: 12px 14px;
      border-radius: 14px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      color: var(--fg);
      font-size: 15px;
      line-height: 1.65;
      outline:none;
      box-sizing:border-box;
    }
    #note-text:focus{
      border-color: color-mix(in oklab, var(--accent) 55%, white);
      box-shadow: 0 0 0 3px color-mix(in oklab, var(--accent) 22%, transparent);
    }
    #note-mask .note-actions{ display:flex; gap:10px; justify-content:flex-end; margin-top:6px; }
    @media (max-width: 520px){
      #note-text{ min-height: 220px; height: 260px; }
      #note-mask .note-count{ width:100%; margin-left:0; text-align:right; }
    }

    .btn.sub:hover{ background-color: color-mix(in oklab, var(--bad) 36%, black); }
    .ripple{ position:absolute; border-radius:999px; transform:translate(-50%,-50%); pointer-events:none; width:12px; height:12px; opacity:.55; background:radial-gradient(circle, rgba(255,255,255,.9) 0%, rgba(255,255,255,.0) 60%); animation:ripple .45s ease-out forwards; }
    @keyframes ripple{ to{ opacity:0; width:240px; height:240px; } }

    /* ===== åˆ—è¡¨æ¨¡å¼å¡ç‰‡ ===== */
    .grid{ display:grid; grid-template-columns: repeat(var(--list-cols), minmax(0, 1fr)); gap:8px; margin-top:12px; align-items:stretch; justify-items:stretch; }
    .card{ position:relative; border:1px solid var(--line); background:linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.0)); border-radius:14px; padding:8px; display:flex; flex-direction:column; gap:6px; min-height:72px; box-shadow: var(--shadow); transform: translateY(6px); opacity:0; width:auto; }
    .card.show{ opacity:1; transform: translateY(0); transition: transform .5s cubic-bezier(.2,.8,.2,1), opacity .5s ease; }
    .card:hover{ outline:1px solid rgba(124,58,237,.35); box-shadow: 0 12px 30px rgba(124,58,237,.12); }
    .name{ display:flex; align-items:center; gap:6px; font-weight:800; letter-spacing:.02em; line-height:1.05; min-width:0; }
    .name .student-name{ display:inline-block; max-width:100%; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; font-size:14px; }
    .seat-badge{ background: color-mix(in oklab, var(--seat) 22%, black); border:1px solid color-mix(in oklab, var(--seat) 60%, black); color:white; font-weight:800; font-variant-numeric: tabular-nums; padding:1px 6px; border-radius:999px; line-height:1.2; font-size:10px; flex:0 0 auto; }
    .card.placeholder{ border:1px dashed var(--line); background: repeating-linear-gradient(45deg, rgba(255,255,255,.015), rgba(255,255,255,.015) 8px, rgba(255,255,255,.02) 8px, rgba(255,255,255,.02) 16px); color: var(--muted); align-items:center; justify-content:center; gap:6px; min-height:72px; }
    .placeholder .seat-ind{ font-size:12px; opacity:.85; }
    .placeholder .empty-text{ font-weight:800; letter-spacing:.04em; }
    .actions{ display:flex; gap:6px; margin-top:auto; }
    .actions .btn{ flex:1; font-weight:900; font-size:12px; padding:6px 8px; border-width:1.5px; letter-spacing:.02em; border-radius:10px; }
    .actions .btn.add{ background: linear-gradient(180deg, #22c55e, #16a34a); border-color:#15803d; color:white; box-shadow: 0 8px 18px rgba(34,197,94,.28), 0 0 0 1px rgba(255,255,255,.06) inset; }
    .actions .btn.sub{ background: linear-gradient(180deg, #ef4444, #dc2626); border-color:#b91c1c; color:white; box-shadow: 0 8px 18px rgba(220,38,38,.28), 0 0 0 1px rgba(255,255,255,.06) inset; }
    .score-chip{ position:absolute; top:4px; right:4px; padding:2px 6px; background:var(--scorechip); border:1px solid var(--line); border-radius:10px; font-weight:800; font-variant-numeric: tabular-nums; min-width:25px; text-align:center; font-size:12px; box-shadow: inset 0 0 0 1px rgba(255,255,255,.04); }
    .score-chip.bump{ animation: bump .35s ease; }
    @keyframes bump{ 0%{ transform:scale(1)} 30%{ transform:scale(1.18)} 60%{ transform:scale(0.96)} 100%{ transform:scale(1)} }
    .float-mark{ position:absolute; right:10px; bottom:30px; font-weight:900; pointer-events:none; opacity:0; transform: translateY(8px); filter: drop-shadow(0 4px 12px rgba(0,0,0,.4)); }
    .float-mark.show{ animation: floatUp .6s ease-out forwards; }
    @keyframes floatUp{ to{ opacity:1; transform: translateY(-24px); opacity:0; } }

    /* ===== æ’è¡Œæ¦œ ===== */
    .board{ border:1px solid var(--line); background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01)); border-radius:14px; padding:12px; display:flex; flex-direction:column; gap:8px; box-shadow: var(--shadow); flex:1 1 auto; min-height:0; overflow:hidden; }
    .board h3{ margin:0; font-size:16px; display:flex; align-items:center; gap:8px; }
    .badge{ display:inline-block; padding:2px 6px; border-radius:999px; border:1px solid var(--line); font-size:12px; color:var(--muted); }
    #leaderboard{ flex: 1 1 0; min-height: 0; overflow: auto; padding-right: 4px; -webkit-overflow-scrolling: touch; }
    .board .row{ display:grid; grid-template-columns: 38px 1fr 64px; gap:8px; padding:8px 8px; border-radius:10px; align-items:center; transition: background .3s ease; }
    .board .row:nth-child(odd){ background:rgba(255,255,255,0.02); }
    .board .rank{ display:flex; align-items:center; justify-content:center; }
    .board .score{ text-align:right; font-variant-numeric: tabular-nums; font-weight:800; }
    .empty{ color:var(--muted); padding:8px; text-align:center; }
    .medal{ display:inline-flex; align-items:center; justify-content:center; min-width:26px; height:26px; padding:0 6px; border-radius:999px; font-weight:900; font-size:13px; color:#0b1220; border:1px solid var(--line); background:linear-gradient(180deg,rgba(255,255,255,0.2),rgba(255,255,255,0)); box-shadow: inset 0 0 0 1px rgba(255,255,255,.12); }
    .rank-1 .medal{ background:var(--gold); color:#1a1300; } .rank-2 .medal{ background:var(--silver); color:#0b0e10; } .rank-3 .medal{ background:var(--bronze); color:#1a1200; } .rank-4 .medal{ background:var(--rank4); color:#031225; } .rank-5 .medal{ background:var(--rank5); color:#03150f; }
    .rank-1, .rank-2, .rank-3{ box-shadow: 0 0 0 1px rgba(255,255,255,0.06) inset; }
    .rank-1{ background: linear-gradient(180deg, rgba(245,158,11,0.12), rgba(245,158,11,0.08)) !important; }
    .rank-2{ background: linear-gradient(180deg, rgba(156,163,175,0.12), rgba(156,163,175,0.06)) !important; }
    .rank-3{ background: linear-gradient(180deg, rgba(217,119,6,0.12), rgba(217,119,6,0.08)) !important; }

    /* ===== æ‹–æ”¾ä¸Šå‚³æç¤º ===== */
    .dropmask{ position:fixed; inset:0; z-index:50; display:none; align-items:center; justify-content:center; background:rgba(2,6,23,.6); backdrop-filter: blur(4px); outline:2px dashed rgba(124,58,237,.6); outline-offset:-2px; box-sizing:border-box; pointer-events:none; }
    .dropmask.show{ display:flex; animation: fadeIn .15s ease; }
    .dropmask .msg{ display:flex; gap:12px; align-items:center; padding:18px 22px; border-radius:16px; border:1px solid var(--line); background:rgba(15,23,42,.9); box-shadow: var(--shadow); font-weight:700; }
    @keyframes fadeIn{ from{ opacity:0 } to{ opacity:1 } }

    /* ==== åº§ä½è¡¨ UI ==== */
    .hidden{ display:none !important; }
    body[data-mode="progress"] .controls-row{ display:none !important; }
    .seat-controls{ display:flex; gap:12px; align-items:center; margin-top:10px; flex-wrap:wrap; }
    .seat-controls .input{ min-width:auto; width:70px; text-align:center; padding:8px 10px; }

    .seatwrap{ display:grid; grid-template-columns: 1fr 220px; gap:16px; margin-top:12px; }
    /* 1) seatboard ç­‰é«˜ï¼‹è‡ªæ»¾å‹•ï¼šä¸å†ç”¨å›ºå®š 68px åˆ—é«˜ */
    .seatboard{
      --rows:6; --cols:6;
      display:grid;
      /* å¯¬åº¦è·Ÿæ¬„æ•¸èµ°ï¼Œä¿ç•™æœ€å°æ ¼å¯¬é¿å…å¤ªæ“  */
      grid-template-columns: repeat(var(--cols), minmax(48px,1fr));
      /* é«˜åº¦è·Ÿåˆ—æ•¸èµ°ï¼Œæœ€å¾Œå¤šä¸€åˆ—ç•™çµ¦è¬›å° */
      grid-template-rows: repeat(var(--rows), minmax(0,1fr)) auto;
      grid-auto-rows: minmax(0,1fr);

      gap:8px; padding:12px;

      /* é—œéµï¼šè‡ªå·±æ»¾ï¼Œä¸æŠŠ main æ’ç ´ */
      height:100%;
      min-height:0;
      overflow:auto;

      border:1px solid var(--line);
      border-radius:14px;
      background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01));
      box-shadow: var(--shadow);
    }

    /* 2) è¬›å°é»åœ¨åº•éƒ¨ï¼Œå…§å®¹å¤šæ™‚ä»å›ºå®šåœ¨æœ€ä¸‹ç·£ */
    .stage{
      position: sticky;
      bottom: 0;
      z-index: 1;        /* å£“åœ¨æ ¼å­ä¹‹ä¸Šï¼Œé¿å…è¢«è“‹ä½ */
    }

    /* 3) åº§ä½æ ¼å…§çš„å§“ååœ¨åº§ä½æ¨¡å¼ä¹Ÿç¨å¾®è‡ªé©æ‡‰ */
    .seat-cell .student-name{ font-size: clamp(10px, 0.9vw, 12px); }

    /* 4) 8Ã—8 ä»¥ä¸Šè‡ªå‹•ç·Šæ¹Šä¸€é»ï¼ˆå¯èª¿æ•´é–€æª»èˆ‡æ•¸å€¼ï¼‰ */
    .seatboard[data-dense="1"]{ gap:6px; padding:8px; }
    .seatboard[data-dense="1"] .tile{ padding:4px 6px; }
    .seatboard[data-dense="1"] .seat-badge{ font-size:9px; }
    .seatboard[data-dense="1"] .student-name{ font-size:11px; }

    .seat-cell{ position:relative; border:1px dashed var(--line); border-radius:12px; display:flex; align-items:center; justify-content:center; background:rgba(255,255,255,.02); overflow:hidden; }
    .seat-cell.dragover{ outline:2px solid var(--accent); outline-offset:-2px; border-color:transparent; }
    .seat-cell.filled{ border-style:solid; }
    .seat-no{ position:absolute; top:6px; left:8px; font-size:10px; color:var(--muted); opacity:.9; z-index:2; pointer-events:none; }
    .seat-cell .tile{ position:absolute; inset:0; width:100%; height:100%; border-radius:inherit; padding:6px 8px; display:flex; align-items:center; justify-content:center; gap:6px; border:1px solid var(--line); background:var(--card); box-shadow: var(--shadow); cursor:grab; user-select:none; transition: transform .15s ease; }
    .tile:active{ cursor:grabbing; }
    .tile .seat-badge{ transform:scale(.95); }

    /* è§¸æ§ï¼šé¿å…æ²å‹•æ””æˆªæ‹–æ›³ï¼›åŠ ä¸Šé¸å–é«˜äº® */
    .tile{ touch-action: none; }              /* æ¸›å°‘ã€Œæ‹–å°±æ²é ã€ */
    .seat-cell{ touch-action: manipulation; } /* è§¸æ§é»æ“Šæ›´éˆæ• */

    .tile.picked{
      outline:3px solid color-mix(in oklab, var(--accent) 75%, black);
      box-shadow: 0 0 0 3px rgba(124,58,237,.25) inset, 0 16px 36px rgba(124,58,237,.25);
      transform: scale(1.03);
    }

    /* ç²—æŒ‡æ¨™ï¼ˆå¹³æ¿/æ‰‹æ©Ÿï¼‰æŠŠé»æ“Šé¢ç©æ”¾å¤§ä¸€é» */
    @media (pointer: coarse){
      .seatboard{ gap:10px; }
      .seat-cell .tile{ padding:10px 12px; }
    }


    .unassigned{ border:1px solid var(--line); border-radius:12px; padding:12px; background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01)); height: 68vh; max-height: 540px; min-height: 200px; display:flex; flex-direction:column; overflow:hidden; }
    @media (max-width: 880px){ .unassigned{ height: 52vh; max-height: 420px; } }
    .unassigned h4{ margin:0 0 8px 0; font-size:14px; color:var(--muted); position: sticky; top: 0; padding-bottom:8px; z-index: 1; text-align:center; }
    .unassigned .list{ display:flex; flex-direction:column; gap:8px; min-height:80px; overflow: auto; padding-right: 4px; flex: 1 1 auto; }
    .unassigned.dragover{ outline:2px dashed var(--accent); outline-offset:-4px; }
    .unassigned .list::-webkit-scrollbar{ width:10px; }
    .unassigned .list::-webkit-scrollbar-track{ background:rgba(255,255,255,0.04); border-radius:10px; }
    .unassigned .list::-webkit-scrollbar-thumb{ background:#2b3447; border-radius:10px; border:2px solid rgba(0,0,0,0); background-clip:padding-box; }

    .stage { grid-column: 1 / -1; height: 44px; border: 1px solid var(--line); border-radius: 10px; background: linear-gradient(180deg, rgba(124,58,237,.18), rgba(124,58,237,.10)); display: flex; align-items: center; justify-content: center; gap: 8px; font-weight: 900; letter-spacing: .06em; box-shadow: var(--shadow); }
    .stage .dot { width: 8px; height: 8px; border-radius: 999px; background: currentColor; opacity: .8; }

    @media (max-width: 880px){
      .layout{ grid-template-columns: 1fr; }
      .sidebar{ order:2; }
      .main{ order:1; }
      .seatwrap{ grid-template-columns: 1fr; }
    }

    /* ===== ğŸ” èªªæ˜å½ˆçª— ===== */
    .modal-mask{ position:fixed; inset:0; z-index:60; display:none; background: rgba(2,6,23,.62); backdrop-filter: blur(8px); }
    .modal-mask.show{ display:flex; align-items:center; justify-content:center; animation: fadeIn .12s ease; }
    .modal{ width:min(720px, 92vw); max-height: 80vh; overflow:auto; border:1px solid var(--line); border-radius:16px; box-shadow: var(--shadow); background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02)); }
    .modal header{ display:flex; align-items:center; justify-content:space-between; padding:12px 16px; border-bottom:1px solid var(--line); position:sticky; top:0; background: var(--card); }
    .modal h3{ margin:0; font-size:16px; display:flex; gap:8px; align-items:center; }
    .modal .content{ padding:12px 16px; }
    .modal .content ol{ margin:0 0 8px 18px; }
    .modal .content li{ margin:6px 0; }
    .modal .close{ cursor:pointer; border:1px solid var(--line); border-radius:10px; padding:6px 10px; background:var(--card); }
    .hint{ font-size:13px; color:var(--muted); }
    /* â˜… æ‡‰éœ€æ±‚ï¼šç§»é™¤æç¤º(hint)èˆ‡å·¥å…·åˆ— */
    .hint{ display:none !important; }

    .divider{ height:1px; background:var(--line); margin:10px 0; }
    .help-actions{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .note{ font-size:13px; color:var(--muted); }


    /* ===== â˜… ä½œæ¥­æˆç¸¾ï¼ˆè¡¨æ ¼ï¼‰ ===== */
    .hw-controls{ display:flex; gap:8px; align-items:center; margin-top:12px; flex-wrap:wrap; }
    .hw-title{ font-weight:900; letter-spacing:.04em; margin:6px 0 2px 0; display:flex; align-items:center; gap:8px; }
    .hwtbl-wrap{
      margin-top:10px; border:1px solid var(--line); border-radius:0px;
      background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01));
      box-shadow: var(--shadow);
      flex: 1 1 auto;
      width: 100%;
      max-width: 100%;
      min-height: 0;
      overscroll-behavior: contain;
      -webkit-overflow-scrolling: touch;
      overflow-x:auto; overflow-y:auto;
      cursor: grab;
    }
    .hwtbl-wrap.grabbing{ cursor: grabbing; }

    /* è®“ä½œæ¥­é æˆç‚ºç›´å‘ flex å®¹å™¨ */
    #hw-pane{
      display: flex;
      flex-direction: column;
      min-height: 0;      /* å…è¨±ç¸®åˆ°å¯ç”¨é«˜åº¦ */
      overflow: hidden;   /* æ²å‹•äº¤çµ¦å…§å±¤ .hwtbl-wrap */
    }

    table.hwtbl{
      width: max-content;
      min-width: 100%;
      border-collapse:separate; border-spacing:0;
      table-layout: auto;
    }
    .hwtbl th,.hwtbl td{
      border-bottom:1px solid var(--line); padding:8px 10px; font-size:13px;
      white-space: nowrap;
    }
    .hwtbl th{ position:sticky; top:0; background:rgba(15,23,42,.9); backdrop-filter: blur(4px); text-align:left; }
    .hwtbl tr:last-child td{ border-bottom:0; }
    .hwtbl .num{ text-align:right; font-variant-numeric: tabular-nums; }
    .hwtbl th.hw-col{ min-width:96px; }
    .hwtbl input[type="number"]{ width:76px; background:var(--card); color:var(--fg); border:1px solid var(--line); border-radius:8px; padding:6px 8px; text-align:center; outline:none; }
    .hwtbl input[type="number"]:focus{ border-color: color-mix(in oklab, var(--accent) 60%, #000); box-shadow: 0 0 0 3px rgba(124,58,237,.18); }
    .pill{ display:inline-block; padding:2px 8px; border:1px solid var(--line); border-radius:999px; font-size:12px; color:var(--muted); }

    .hw-col{ position:relative; white-space:nowrap; }
    .hw-col .mini-btn{
      margin-left:6px; padding:2px 6px; font-size:12px; line-height:1.2;
      border:1px solid var(--line); border-radius:8px; background:var(--card); color:var(--fg);
      cursor:pointer;
    }
    .hw-col .mini-btn:hover{ box-shadow:0 2px 10px rgba(0,0,0,.2); }

    /* ğŸ” æœå°‹å‘½ä¸­é«˜äº®ï¼ˆåˆ—è¡¨å¡ç‰‡ï¼‰ */
    .card.match{
      outline:2px solid color-mix(in oklab, var(--accent) 65%, black);
      box-shadow: 0 12px 34px rgba(124,58,237,.22);
      position: relative;
    }
    .card.match::after,
    .tile.match::after{
      content:""; position:absolute; inset:-2px; border-radius:inherit; pointer-events:none;
      animation: searchPulse 1.2s ease-out 0s 1;
      box-shadow: 0 0 0 0 rgba(124,58,237,.25);
    }
    @keyframes searchPulse{ to{ box-shadow: 0 0 0 14px rgba(124,58,237,0); } }

    /* ğŸ” å‘½ä¸­æ–‡å­—æ¨£å¼ï¼ˆé€šç”¨ï¼‰ */
    .hl{
      background: linear-gradient(180deg, rgba(124,58,237,.35), rgba(124,58,237,.12));
      border-radius:4px; padding:0 2px;
      box-shadow: 0 0 0 1px rgba(124,58,237,.35) inset;
    }
    .seat-badge .hl{ padding:0 3px; border-radius:6px; }

    /* ğŸ” å®‰æ’åº§ä½æ¨¡å¼çš„ç£ç£šé«˜äº®ï¼ˆåŠ å¼·ï¼‰ */
    .tile.match{
      outline:3px solid color-mix(in oklab, var(--accent) 75%, black);
      box-shadow: 0 0 0 3px rgba(124,58,237,.25) inset, 0 16px 36px rgba(124,58,237,.25);
      background:
        linear-gradient(180deg, rgba(124,58,237,.18), rgba(124,58,237,.08)),
        var(--card);
      transform: scale(1.03);
    }
    .tile.match::before{
      content:"ğŸ”";
      position:absolute; top:6px; right:6px;
      font-size:14px; filter: drop-shadow(0 2px 6px rgba(0,0,0,.45));
    }
    /* å‘½ä¸­æ‰€åœ¨çš„åº§ä½æ ¼ä¹Ÿä¸€èµ·é«˜äº® */
    .seat-cell.hit{
      outline:2px solid color-mix(in oklab, var(--accent) 75%, black);
      box-shadow: 0 0 0 4px rgba(124,58,237,.22), 0 12px 30px rgba(124,58,237,.25);
      border-color: transparent;
    }

    /* ğŸ” ä½œæ¥­æˆç¸¾æ¨¡å¼åˆ—é«˜äº® */
    .hwtbl tr.match{
      background: linear-gradient(180deg, rgba(124,58,237,.12), rgba(124,58,237,.06));
    }
    .hwtbl tr.match td:first-child{
      border-left:4px solid color-mix(in oklab, var(--accent) 70%, black);
    }
    .hwtbl tr.match td{
      border-bottom-color: color-mix(in oklab, var(--accent) 38%, var(--line));
    }
    /* è®“ seatwrap çš„é‚£ä¸€åˆ—åƒæ»¿ main çš„å¯ç”¨é«˜åº¦ï¼Œä¸¦è®“æ ¼å­ç­‰é«˜ */
    .seatwrap{
      grid-template-rows: minmax(0, 1fr);
      align-items: stretch;   /* ä¿è­‰å…©æ¬„æ‹‰åˆ°åŒé«˜ */
      min-height: 0;          /* é˜²æ­¢ min-content æ’ç ´ */
    }

    /* å…©æ¬„éƒ½å…è¨±ç¸®æ”¾åˆ°å®¹å™¨é«˜åº¦ï¼Œåº•ç·£è‡ªç„¶å°é½Š */
    .seatboard,
    .unassigned{
      height: 100%;
      min-height: 0;
    }

    /* ç§»é™¤åŸæœ¬çš„å›ºå®š vh é«˜åº¦ï¼Œæ”¹æˆè·Ÿå®¹å™¨åŒæ­¥ç­‰é«˜ */
    .unassigned{
      height: 100%;     /* å–ä»£åŸæœ¬çš„ 68vh/52vh */
      max-height: none; /* é¿å…è¢«èˆŠçš„ max-height å¡ä½ */
    }

    /* æ‰‹æ©Ÿç‰ˆä¹Ÿä¸è¦å†ç”¨ 52vhï¼Œç¶­æŒè·Ÿå®¹å™¨ç­‰é«˜ */
    @media (max-width: 880px){
      .unassigned{
        height: 100%;
        max-height: none;
      }
    }

    /* ===== ğŸ² æŠ½è™Ÿæ¨¡å¼ï¼ˆæ–°ç‰ˆï¼‰ ===== */
    .draw-wrap{
      display:grid; grid-template-columns: 360px 1fr; gap:16px; margin-top:12px; align-items:stretch;
    }
    @media (max-width: 980px){ .draw-wrap{ grid-template-columns: 1fr; } }

    .controls-card,
    .spotlight-card{
      border:1px solid var(--line); border-radius:12px;
      background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01));
      box-shadow: var(--shadow);
    }

    .controls-card{ padding:12px; display:flex; flex-direction:column; gap:12px; }
    .controls-card .row{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .controls-card .presets{ display:flex; gap:8px; flex-wrap:wrap; }
    .controls-card .presets .btn{ padding:8px 10px; font-weight:900; }
    .controls-card .ops{ display:flex; gap:8px; flex-wrap:wrap; }
    .controls-card .ops .btn.add{ flex: 1 1 auto; font-size:16px; padding:12px; }
    .controls-card .hint{ margin-top:2px; }

    .spotlight-card{ padding:12px; display:flex; flex-direction:column; gap:12px; min-height:0; }
    .draw-stats{ display:flex; gap:8px; flex-wrap:wrap; }
    .draw-stats .badge b{ font-variant-numeric: tabular-nums; padding-left:4px; }

    .draw-result-wrap,.draw-history-wrap{
      border:1px solid var(--line); border-radius:12px;
      background:var(--card); padding:12px;
      min-height:0; /* è®“å³å´å¯ä»¥å½ˆæ€§ä¼¸ç¸® */
    }
    .draw-subtitle{ font-weight:900; letter-spacing:.04em; color:var(--muted); margin-bottom:8px; }

    .draw-result{
      display:flex; flex-wrap:wrap; gap:10px; min-height:48px; align-items:center;
    }
    .chip{
      display:inline-flex; align-items:center; gap:8px;
      border:1px solid var(--line); border-radius:999px;
      padding:var(--chip-py) var(--chip-px); background:var(--card); box-shadow: var(--shadow);
      font-weight:900;font-size: var(--chip-fz);
    }
    .chip .seat-badge{ transform:scale(.95); }
    .chip.big{ font-size:var(--chip-fz); padding:var(--chip-py) var(--chip-px); }
    .chip.pop{ animation: popIn .25s ease-out; }
    @keyframes popIn{ from{ transform:scale(.88); opacity:0 } to{ transform:scale(1); opacity:1 } }

    .draw-history{ display:flex; flex-direction:column; gap:10px; }
    .draw-history.empty{ color:var(--muted); }
    .draw-row{ border:1px solid var(--line); border-radius:10px; padding:10px; background:var(--card); }
    .draw-row .time{ font-size:12px; color:var(--muted); margin-bottom:6px; }
    .draw-row .chips{ display:flex; flex-wrap:wrap; gap:8px; }

    /* æŠ½è™Ÿï¼šè®“æ­·å²å€å¡Šè²¼é½Šåº•ä¸¦åœ¨è‡ªèº«æ»¾å‹• */
    #draw-pane .spotlight-card{
      display:flex;
      flex-direction:column;
      min-height:0;
    }
    #draw-pane .draw-history-wrap{
      /* wrapper åªè² è²¬æ’ç‰ˆï¼Œä¸å†æ»¾å‹• */
      display:flex;
      flex-direction:column;
      flex:1 1 auto;
      min-height:0;
      overflow:hidden; /* è“‹æ‰å…ˆå‰çš„ overflow:auto */
    }
    #draw-pane .draw-history{
      /* ç”±å…§å®¹å€è‡ªå·±åƒæ»¿å‰©é¤˜é«˜åº¦ä¸¦æ»¾å‹• */
      flex:1 1 auto;
      min-height:0;
      overflow:auto;
      max-height:none; /* å–æ¶ˆ 36vh ä¸Šé™ */
    }
    /* ğŸ² æŠ½è™Ÿï¼šå›ºå®šã€Œæœ¬æ¬¡çµæœã€é«˜åº¦ */
    :root{ --draw-result-h: auto; } /* æƒ³èª¿é«˜ä½ï¼Œæ”¹é€™è£¡å³å¯ */

    #draw-pane .spotlight-card{
      display:flex;
      flex-direction:column;
      min-height:0;
    }

    #draw-pane .draw-result-wrap{
      flex: 0 0 var(--draw-result-h); /* å›ºå®šé«˜åº¦ */
      overflow:auto;                  /* å…§å®¹å¤ªå¤šå¯è‡ªè¡Œæ²å‹• */
    }

    #draw-pane .draw-history-wrap{
      display:flex;
      flex-direction:column;
      flex:1 1 auto;  /* åƒæ»¿å‰©é¤˜ç©ºé–“ */
      min-height:0;
      overflow:hidden;
    }

    #draw-pane .draw-history{
      flex:1 1 auto;  /* è‡ªå·±è£¡é¢æ²å‹• */
      min-height:0;
      overflow:auto;
      max-height:none; /* å–æ¶ˆèˆŠçš„ 36vh é™åˆ¶ï¼ˆè‹¥æœ‰ï¼‰ */
    }


  
    /* ===== Compact Topbar (reduce title row height) ===== */
    .topbar{ min-height: 56px; padding-block: 6px; }
    .title-stack{ gap: 3px; line-height: 1.05; }
    .title{ font-size: 18px; }
    .modebar{ margin-top: 0; gap: 6px; }
    .seg-btn{ padding: 6px 10px; }

  
    /* ===== å·¥å…·åˆ—ï¼šæ–°å¢/åˆªé™¤å­¸ç”ŸæŒ‰éˆ•èˆ‡æœå°‹æ¬„ç­‰é«˜ã€å­—é«”æ›´å° ===== */
    :root{ --ctl-h: 36px; }

    /* æœå°‹æ¬„ */
    #search-input{
      height: var(--ctl-h);
      padding-top: 0;
      padding-bottom: 0;
    }

    /* æ–°å¢/åˆªé™¤å­¸ç”Ÿï¼ˆåªå½±éŸ¿é€™å…©é¡†ï¼Œä¸æœƒå‹•åˆ° +1/-1 ç­‰å…¶ä»–æŒ‰éˆ•ï¼‰ */
    #btn-add-student, #btn-del-student{
      height: var(--ctl-h);
      padding: 0 12px;
      font-size: 12px;
      display: inline-flex;
      align-items: center;
      white-space: nowrap;
    }


    /* ===== ğŸ“š æ•™å­¸é€²åº¦ ===== */
    #progress-pane{ display:flex; flex-direction:column; flex:1 1 auto; min-height:0; overflow:hidden; }
    .prog-controls{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin-bottom:10px; }

    .prog-pagebox{
      position:relative;
      display:flex; align-items:center; gap:10px;
      padding:10px 12px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.04);
      border-radius:14px;
      box-shadow: 0 8px 20px rgba(0,0,0,.08);
    }
    :root[data-theme="light"] .prog-pagebox{ background:rgba(0,0,0,.03); }
    .prog-pagebox__title{
      font-size:12px; letter-spacing:.08em; text-transform:uppercase;
      opacity:.75; margin-right:2px; white-space:nowrap;
    }
    .prog-student-actions{ display:flex; align-items:center; gap:10px; }

    .prog-page-menuwrap{ position:relative; }
    .btn.icon{ width:42px; padding:0; justify-content:center; font-weight:700; }
    .menu{
      position:absolute;
      right:0;
      top:calc(100% + 8px);
      min-width:140px;
      padding:6px;
      border-radius:14px;
      border:1px solid var(--line);
      background: rgba(20,22,28,.92);
      backdrop-filter: blur(10px);
      box-shadow: 0 16px 40px rgba(0,0,0,.22);
      z-index: 50;
    }
    :root[data-theme="light"] .menu{ background: rgba(255,255,255,.92); }
    .menu.hidden{ display:none !important; }
    .menu-item{
      width:100%;
      text-align:left;
      padding:10px 10px;
      border-radius:12px;
      border:1px solid transparent;
      background: transparent;
      color: var(--fg);
      cursor:pointer;
      font-size:14px;
    }
    .menu-item:hover{ background: rgba(255,255,255,.06); border-color: rgba(255,255,255,.10); }
    :root[data-theme="light"] .menu-item:hover{ background: rgba(0,0,0,.06); border-color: rgba(0,0,0,.10); }
    .menu-item.danger{ color: var(--danger, #ff5a5a); }

    .btn.danger{
      border-color: rgba(255,90,90,.45);
      background: rgba(255,90,90,.10);
    }
    :root[data-theme="light"] .btn.danger{
      border-color: rgba(255,90,90,.35);
      background: rgba(255,90,90,.08);
    }
    .progtbl-wrap{ flex:1 1 auto; min-height:0; overflow:auto; border:1px solid var(--line); border-radius:14px; background:rgba(255,255,255,.02); }
    .progtbl{ width:100%; border-collapse:separate; border-spacing:0; min-width: 980px; }
    .progtbl th, .progtbl td{ border-bottom:1px solid var(--line); padding:10px 10px; text-align:center; }
    .progtbl th{ position:sticky; top:0; background:rgba(15,23,42,.92); backdrop-filter: blur(6px); z-index:1; font-size:13px; }
    :root[data-theme="light"] .progtbl th{ background: rgba(255,255,255,.92); }
    .progtbl td:first-child, .progtbl th:first-child{ text-align:left; min-width: 220px; }
    .prog-inputwrap{ display:flex; align-items:center; gap:8px; }
    .prog-row-del{
      width:22px; height:22px;
      display:inline-flex; align-items:center; justify-content:center;
      border:1px solid var(--line);
      border-radius:8px;
      background: rgba(255,255,255,.02);
      color: var(--muted);
      cursor:pointer;
      user-select:none;

      /* é è¨­éš±è—ï¼šåªæœ‰ç¢°åˆ°è¼¸å…¥åŒ¡ï¼ˆhover/focusï¼‰æ‰é¡¯ç¤º */
      opacity:0;
      pointer-events:none;
      transform: translateX(-2px);
      transition: opacity .15s ease, transform .15s ease, filter .15s ease;
    }
    .prog-inputwrap:hover .prog-row-del,
    .prog-inputwrap:focus-within .prog-row-del{
      opacity:1;
      pointer-events:auto;
      transform: translateX(0);
    }
    .prog-row-del:hover{ filter: brightness(1.15); color: var(--fg); }
    :root[data-theme="light"] .prog-row-del{ background: rgba(2,6,23,.03); }

    .prog-input{ width:100%; border:1px solid var(--line); border-radius:10px; padding:8px 10px; background: rgba(255,255,255,.03); color: var(--fg); outline:none;  min-width:20em; max-width:100%; }
    :root[data-theme="light"] .prog-input{ background: rgba(2,6,23,.03); }
    .prog-check{ width:20px; height:20px; accent-color: var(--accent); cursor:pointer; }

    /* ===== â³ å€’æ•¸è¨ˆæ™‚ ===== */
    #timer-pane{ display:flex; flex-direction:column; flex:1 1 auto; min-height:0; overflow:hidden; }
    .timer-wrap{ display:flex; flex-direction:column; gap:14px; flex:1 1 auto; min-height:0; }
    .timer-display{
      border:1px solid var(--line);
      border-radius:16px;
      background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01));
      box-shadow: var(--shadow);
      padding:18px 16px;
      text-align:center;
      font-weight: 900;
      letter-spacing: .06em;
      font-variant-numeric: tabular-nums;
      font-size: clamp(44px, 7vw, 88px);
    }
    .timer-set, .timer-actions, .timer-presets{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .timer-presets .btn{ padding:8px 10px; font-weight:900; }


    /* ===== In-app Modal ===== */
    .ui-modal.hidden{ display:none; }
    .ui-modal{ position:fixed; inset:0; z-index:9999; }
    .ui-modal__backdrop{ position:absolute; inset:0; background:rgba(0,0,0,.45); }
    .ui-modal__panel{
      position:relative;
      max-width: 360px;
      width: calc(100% - 32px);
      margin: 18vh auto 0;
      background: var(--card, #111);
      border: 1px solid rgba(255,255,255,.12);
      border-radius: 16px;
      box-shadow: 0 12px 40px rgba(0,0,0,.45);
      padding: 14px 14px 12px;
    }
    .ui-modal__title{ font-weight: 800; font-size: 16px; margin-bottom: 8px; }
    .ui-modal__msg{ line-height: 1.6; font-size: 14px; opacity: .95; white-space: pre-wrap; }
    .ui-modal__actions{ display:flex; justify-content:flex-end; gap:10px; margin-top: 12px; }


/* ==== PATCH v7: çµ±ä¸€æŒ‰éˆ•é«˜åº¦ï¼ˆä¿®æ­£æ•™å­¸é€²åº¦æŒ‰éˆ•é«˜åº¦ä¸ä¸€è‡´ï¼‰ ==== */
:root{ --btn-h: 38px; }

.btn{
  position:relative;
  overflow:hidden;
  display:inline-flex;
  align-items:center;
  justify-content:center;
  gap:8px;
  height: var(--btn-h);
  padding: 0 12px;
  border-radius: 12px;
  border: 1px solid var(--line);
  cursor: pointer;
  transition: transform .08s, background-color .2s, border-color .2s, box-shadow .2s;
  user-select:none;
  font-size:14px;
  color:var(--fg);
  background:var(--card);
}

.btn:hover{ box-shadow:0 6px 18px rgba(0,0,0,.28), inset 0 0 0 1px rgba(255,255,255,.03); }
.btn:active{ transform: translateY(1px); }

.btn.add{
  background-color: color-mix(in oklab, var(--ok) 22%, black);
  border-color: color-mix(in oklab, var(--ok) 40%, black);
  color: white;
}
.btn.add:hover{ background-color: color-mix(in oklab, var(--ok) 36%, black); }

.btn.sub{
  background-color: color-mix(in oklab, var(--bad) 24%, black);
  border-color: color-mix(in oklab, var(--bad) 45%, black);
  color: white;
}
.btn.sub:hover{ background-color: color-mix(in oklab, var(--bad) 36%, black); }

/* æ•™å­¸é€²åº¦å€æŒ‰éˆ•è·Ÿå·¥å…·åˆ—ä¸€è‡´ */
#progress-pane .prog-controls .btn{ height: var(--btn-h); padding: 0 12px; }
/* è®“æç¤ºæ–‡å­—ä¸è¢«æŒ‰éˆ•æ’é«˜ */
#progress-pane .prog-controls .hint{ line-height: var(--btn-h); }


/* æ•™å­¸é€²åº¦ï¼šç­ç´šæ¬„ä½å¯æ‹–ç§»æ’åº */
.progtbl th.prog-th-class{ cursor: grab; user-select:none; }
.progtbl th.prog-th-class.dragging{ opacity:.55; cursor: grabbing; }
.progtbl th.prog-th-class.drag-over{ outline:2px dashed var(--accent); outline-offset:-4px; }


    /* åŠ æ‰£åˆ†(åˆ—è¡¨)æ¨¡å¼ï¼š#students.grid ä¸è¦é™°å½± */
    body[data-mode="list"] #students.grid{
      box-shadow: none !important;
      background: transparent !important;
    }
    body[data-mode="list"] #students.grid .card{
      box-shadow: none !important;
    }
    body[data-mode="list"] #students.grid .card:hover{
      box-shadow: none !important;
    }

</style>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>
<body>
  <div class="app" id="app">
    <header class="topbar">
      <div class="topbar__left">
        <div class="import-block">
          <label class="btn" for="file-input" title="ä¸Šå‚³ Excel">ğŸ“‚ åŒ¯å…¥</label>
          <input id="file-input" type="file" accept=".xlsx,.xls" hidden />
        </div>
        <button id="btn-reset" class="btn" title="æ¸…é™¤æœ¬æ©Ÿæš«å­˜ï¼ˆåˆ†æ•¸/åº§ä½/ä½œæ¥­/å¿«é€Ÿé‚„åŸï¼‰">ğŸ§¹ æ¸…é™¤</button>
        <div id="status" class="status-inline">å°šæœªè¼‰å…¥åå–®ã€‚</div>
</div>

      <div class="title-stack">
        <h1 class="title">æˆç¸¾ç®¡ç†ç³»çµ±</h1>
        <div class="modebar">
          <div class="seg" role="tablist" aria-label="é¡¯ç¤ºæ¨¡å¼">
                                <button id="mode-progress" class="seg-btn" data-mode="progress">æ•™å­¸é€²åº¦</button>
                                <button id="mode-list" class="seg-btn active" data-mode="list">åŠ æ‰£åˆ†</button>
                                <button id="mode-seat" class="seg-btn" data-mode="seat">åº§ä½</button>
                                <button id="mode-hw" class="seg-btn" data-mode="hw">ä½œæ¥­æˆç¸¾</button>
                                <button id="mode-draw" class="seg-btn" data-mode="draw">æŠ½è™Ÿ</button>
                                <button id="mode-timer" class="seg-btn" data-mode="timer">å€’æ•¸è¨ˆæ™‚</button>
          
                              </div>
        </div>
      </div>

      <div class="topbar__right">
        <!-- â˜… æ–°å¢ä¸»é¡Œåˆ‡æ›æŒ‰éˆ• -->
        <!-- â˜… æ—¥æœŸæ™‚é–“ï¼ˆæ°‘åœ‹å¹´ + 24 å°æ™‚ï¼‰ -->
        <div id="dt-display" class="dt-display" aria-label="æ—¥æœŸæ™‚é–“">
          <div id="dt-date">114å¹´12æœˆ16æ—¥</div>
          <div id="dt-time">00:00:00</div>
        </div>
        <button id="btn-help" class="btn" title="é–‹å•Ÿæ“ä½œèªªæ˜">â” æ“ä½œ</button>
        <button id="btn-theme" class="btn" title="åˆ‡æ›ç‚ºæ·ºè‰²ä¸»é¡Œ" aria-pressed="false">â˜€ï¸ æ·ºè‰²</button>
        <button id="btn-export" class="btn" title="åŒ¯å‡ºç›®å‰æ‰€æœ‰ç­ç´šçš„æˆç¸¾">ğŸ’¾ åŒ¯å‡º</button>
      </div>
    </header>


    <main class="layout">
      <!-- â˜… å´æ¬„æ”¶åˆæŒ‰éˆ•ï¼ˆå›ºå®šåœ¨ layout å·¦å´ï¼‰ -->
      <button id="btn-sidebar" class="side-toggle" aria-label="æ”¶åˆå´æ¬„" aria-controls="sidebar" aria-expanded="true">â€¹</button>

      <aside id="sidebar" class="sidebar">
<section class="board">
          <h3>ğŸ† åŠ åˆ†æ’è¡Œæ¦œ <span id="board-class" class="badge">å°šæœªè¼‰å…¥</span></h3>
          <div id="leaderboard"></div>
        </section>

        <!-- éš±è—çš„èªªæ˜å…§å®¹ï¼šæä¾›å½ˆçª—è¤‡è£½ -->
        <section id="help-src" class="hint hidden" aria-hidden="true">
          <strong>æ“ä½œèªªæ˜</strong>
          <div class="divider"></div>

          <ol>
            <li><b>åŒ¯å…¥æˆç¸¾</b>ï¼šæ”¯æ´åŒ¯å…¥ Excelï¼ˆæ¯å€‹å·¥ä½œè¡¨ï¼ä¸€å€‹ç­ç´šï¼‰ã€‚å»ºè­°å…ˆç”¨ä¸‹æ–¹çš„ã€Œä¸‹è¼‰ Excel ç¯„ä¾‹æª”ã€å»ºç«‹è³‡æ–™ã€‚</li>
            <li><b>å·¦å´æ¬„</b>ï¼šé¡¯ç¤ºã€ŒğŸ† åŠ åˆ†æ’è¡Œæ¦œã€ï¼Œç”¨ä¾†æŸ¥çœ‹ç›®å‰ç­ç´šçš„åŠ åˆ†æ’åï¼ˆåœ¨åŠ æ‰£åˆ†/æˆç¸¾ç›¸é—œæ¨¡å¼æœƒæ›´æ–°ï¼‰ã€‚</li>
            <li><b>æ¨¡å¼åˆ‡æ›</b>ï¼šåœ¨é é¢ä¸Šæ–¹å¯åˆ‡æ› <b>åº§ä½å€</b>ï¼<b>å®‰æ’åº§ä½</b>ï¼<b>ä½œæ¥­æˆç¸¾</b>ï¼<b>æŠ½è™Ÿ</b>ï¼<b>å€’æ•¸è¨ˆæ™‚</b> ç­‰åŠŸèƒ½ã€‚</li>
            <li><b>æ–°å¢/åˆªé™¤å­¸ç”Ÿ</b>ï¼šåœ¨å­¸ç”Ÿåå–®/ä½œæ¥­æˆç¸¾ç­‰é é¢å¯æ–°å¢è½‰å­¸ç”Ÿï¼Œä¹Ÿå¯é–‹å•Ÿåˆªé™¤ä»‹é¢æ‰¹æ¬¡é¸å–ç§»é™¤ã€‚</li>
            <li><b>ä½œæ¥­æˆç¸¾</b>ï¼šå¯ã€Œï¼‹æ–°å¢ä½œæ¥­ã€å‹•æ…‹å¢åŠ æ¬„ä½ï¼›éœ€è¦å¤§é‡è¼¸å…¥æ™‚å¯ç”¨æ‰¹æ¬¡è¼¸å…¥åŠŸèƒ½åŠ å¿«å¡«å¯«ã€‚</li>
            <li><b>åŒ¯å‡ºæˆç¸¾</b>ï¼šå³ä¸Šè§’ã€ŒğŸ’¾ åŒ¯å‡ºæˆç¸¾ã€æœƒæŠŠç›®å‰æ‰€æœ‰ç­ç´šçš„è³‡æ–™è¼¸å‡ºæˆ Excelï¼Œä¹‹å¾Œå¯å†åŒ¯å…¥çºŒç”¨ã€‚</li>
            <li><b>æ·±è‰²/æ·ºè‰²</b>ï¼šå³ä¸Šè§’å¯åˆ‡æ›ä¸»é¡Œï¼›æ‰€æœ‰è³‡æ–™æœƒä¿ç•™ï¼Œä¸å½±éŸ¿åŒ¯å…¥/åŒ¯å‡ºã€‚</li>
          </ol>

          <div class="divider"></div>

          <div class="help-actions" style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;">
            <a href="#" id="btn-dl-sample" class="btn">ğŸ“¥ ä¸‹è¼‰ Excel ç¯„ä¾‹æª”</a>
            <span class="note">ç¯„ä¾‹åŒ…å«ã€Œç­ç´šA / ç­ç´šBã€ï¼Œå„ 30 ä½ï¼Œæ¬„ä½å«ã€Œå­¸è™Ÿï¼åº§è™Ÿï¼å§“åï¼åˆ†æ•¸ï¼ä½œæ¥­æˆç¸¾ã€ã€‚</span>
          </div>
        </section>
</aside>

            <div class="main-col">
<section class="main">
        <div class="controls-row">
          <label for="class-select">ç­ç´š</label>
          <select id="class-select" class="select" disabled>
            <option value="" selected>è«‹å…ˆä¸Šå‚³å­¸ç”Ÿåå–®</option>
          </select>
          <button id="btn-add-student" class="btn" disabled>ï¼‹ æ–°å¢å­¸ç”Ÿ</button>
          <button id="btn-del-student" class="btn" disabled>ï¼ åˆªé™¤å­¸ç”Ÿ</button>
          <input id="search-input" class="input" type="search" placeholder="æœå°‹å§“å / åº§è™Ÿ (Enter æ¸…é™¤)" disabled />
          <label id="toggle-stage-wrap" class="hidden" style="display:flex;gap:6px;align-items:center;">
            <input id="chk-show-stage" type="checkbox" checked>
            <span>é¡¯ç¤ºè¬›å°</span>
          </label>
          
        </div>

        <!-- å®‰æ’åº§ä½ -->
        <div id="seat-controls" class="seat-controls hidden">
          <span>å®‰æ’åº§ä½ï¼š</span>
          <input id="rows-input" type="number" class="input" min="1" max="9" value="6" aria-label="åˆ—æ•¸">
          <span>Ã—</span>
          <input id="cols-input" type="number" class="input" min="1" max="9" value="6" aria-label="æ¬„æ•¸">
          <button id="btn-apply-size" class="btn">å¥—ç”¨</button>
          <button id="btn-auto" class="btn">è‡ªå‹•æ’ä½</button>
          <button id="btn-clear" class="btn">æ¸…ç©º</button>
          <span id="seat-hint" class="hint"></span>
        </div>

        <div id="seatwrap" class="seatwrap hidden">
          <div id="seatboard" class="seatboard" role="grid" aria-label="å®‰æ’åº§ä½"></div>
          <aside id="unassigned" class="unassigned">
            <h4>æœªå®‰æ’åå–®</h4>
            <div id="unassigned-list" class="list"></div>
          </aside>
        </div>

        <!-- åˆ—è¡¨ï¼ˆåº§ä½é¡åƒï¼‰ -->
        <div id="students" class="grid"></div>

        <!-- â˜… ä½œæ¥­æˆç¸¾é  -->
        
        <!-- ğŸ“š æ•™å­¸é€²åº¦ -->
        <section id="progress-pane" class="hidden" aria-label="æ•™å­¸é€²åº¦">
          <h3 class="hw-title">ğŸ“š æ•™å­¸é€²åº¦ <span class="pill" id="prog-pill">å¯è·¨ç­å‹¾é¸</span></h3>
          <div class="prog-controls">
            <div class="prog-pagebox" aria-label="åˆ†é ç®¡ç†">
              <div class="prog-pagebox__title">åˆ†é </div>
              <select id="prog-page-select" class="select" style="min-width:180px;"></select>
              <div class="prog-page-menuwrap" aria-label="åˆ†é é¸å–®">
                <button id="btn-prog-page-menu" class="btn icon" type="button" aria-haspopup="menu" aria-expanded="false" title="åˆ†é é¸å–®">â‹¯</button>
                <div id="prog-page-menu" class="menu hidden" role="menu">
                  <button type="button" class="menu-item" data-action="add" role="menuitem">æ–°å¢åˆ†é </button>
                  <button type="button" class="menu-item" data-action="ren" role="menuitem">é‡æ–°å‘½ååˆ†é </button>
                  <button type="button" class="menu-item danger" data-action="del" role="menuitem">åˆªé™¤åˆ†é </button>
                </div>
              </div>
            </div>
            <div class="prog-student-actions" aria-label="å­¸ç”Ÿç®¡ç†">
                          </div>

            <button id="btn-prog-add" class="btn add">ï¼‹æ–°å¢é€²åº¦</button>
            <button id="btn-prog-del" class="btn">åˆªé™¤æœ€å¾Œä¸€åˆ—</button>
            <button id="btn-prog-addclass" class="btn">ï¼‹åŠ å…¥ç­ç´š</button>
            <button id="btn-prog-delclass" class="btn">ï¼åˆªé™¤ç­ç´š</button>
            <span class="hint">æç¤ºï¼šç¬¬ä¸€æ¬„è¼¸å…¥é€²åº¦åç¨±ï¼›æ¯å€‹ç­ç´šæ¬„ä½å¯å‹¾é¸å·²å®Œæˆã€‚</span>
          </div>
          <div class="progtbl-wrap">
            <table class="progtbl" id="prog-table" role="grid"></table>
          </div>
        </section>

        <!-- â³ å€’æ•¸è¨ˆæ™‚ -->
        <section id="timer-pane" class="hidden" aria-label="å€’æ•¸è¨ˆæ™‚">
          <h3 class="hw-title">â³ å€’æ•¸è¨ˆæ™‚</h3>
          <div class="timer-wrap">
            <div class="timer-display" id="timer-display">00:00</div>
            <div class="timer-set">
              <label>åˆ†é˜
                <input id="timer-min" type="number" class="input" min="0" value="5" style="width:90px;">
              </label>
              <label>ç§’
                <input id="timer-sec" type="number" class="input" min="0" max="59" value="0" style="width:90px;">
              </label>
              <button id="btn-timer-set" class="btn">è¨­å®š</button>
            </div>
            <div class="timer-actions">
              <button id="btn-timer-start" class="btn add">é–‹å§‹</button>
              <button id="btn-timer-pause" class="btn">æš«åœ</button>
              <button id="btn-timer-reset" class="btn">é‡ç½®</button>
            </div>
            <div class="timer-presets">
              <span class="hint">å¿«é€Ÿï¼š</span>
              <button class="btn" data-preset="60">1åˆ†</button>
              <button class="btn" data-preset="180">3åˆ†</button>
              <button class="btn" data-preset="300">5åˆ†</button>
              <button class="btn" data-preset="600">10åˆ†</button>
            </div>
            <div class="hint" id="timer-hint"></div>
          </div>
        </section>

<section id="hw-pane" class="hidden" aria-label="ä½œæ¥­æˆç¸¾é ">
          <h3 class="hw-title">ğŸ“ ä½œæ¥­æˆç¸¾ <span class="pill" id="hw-class-pill">å°šæœªè¼‰å…¥</span></h3>
          <div class="hw-controls">
            <button id="btn-hw-add" class="btn add">ï¼‹æ–°å¢ä½œæ¥­</button>
            <button id="btn-hw-del" class="btn">åˆªé™¤æœ€å¾Œä¸€å€‹ä½œæ¥­</button>
            <span class="hint">æç¤ºï¼šç›´æ¥åœ¨è¡¨æ ¼è¼¸å…¥åˆ†æ•¸ï¼Œæˆ–é»ä½œæ¥­è¡¨é ­çš„âš¡æ‰¹æ¬¡è¼¸å…¥ã€‚</span>
          </div>
          <div class="hwtbl-wrap">
            <table class="hwtbl" id="hw-table" role="grid"></table>
          </div>
        </section>
        <!-- ğŸ² æŠ½è™Ÿæ¨¡å¼ï¼ˆæ–°ç‰ˆï¼‰ -->
        <section id="draw-pane" class="hidden" aria-label="æŠ½è™Ÿæ¨¡å¼">
          <h3 class="hw-title">ğŸ² æŠ½è™Ÿ <span class="pill" id="draw-class-pill">å°šæœªè¼‰å…¥</span></h3>

          <div class="draw-wrap">
            <!-- å·¦ï¼šæ§åˆ¶å¡ -->
            <aside class="controls-card">
              <div class="row">
                <label>æœ¬æ¬¡æŠ½å¹¾äºº
                  <input id="draw-count" type="number" class="input" min="1" value="1" style="width:90px;">
                </label>
                <label style="display:flex;gap:6px;align-items:center;">
                  <input id="draw-unique" type="checkbox" checked> ä¸é‡è¦†æŠ½å–
                </label>
                <label style="display:flex;gap:6px;align-items:center;">
                  <input id="draw-auto" type="checkbox"> æŠ½åˆ°å³ +1 åˆ†
                </label>
              </div>

              <label class="row" style="flex-direction:column; align-items:flex-start;">
                <span>æ¯æ¬¡ä¸åŒï¼ˆåºåˆ—ï¼‰</span>
                <input id="draw-seq" class="input" type="text" placeholder="ä¾‹ï¼š2,3,2,4ï¼ˆç•™ç™½å‰‡ä¸ç”¨åºåˆ—ï¼‰" style="min-width:260px; width:100%;">
              </label>

              <div class="presets">
                <span class="hint">å¿«é€Ÿï¼š </span>
                <button class="btn" data-preset="1">1äºº</button>
                <button class="btn" data-preset="2">2äºº</button>
                <button class="btn" data-preset="3">3äºº</button>
                <button class="btn" data-preset="4">4äºº</button>
                <button class="btn" data-preset="5">5äºº</button>
              </div>

              <div class="ops">
                <button id="btn-draw" class="btn add">ğŸ¯ æŠ½ï¼</button>
                <button id="btn-draw-undo" class="btn" title="æ’¤éŠ·æœ€è¿‘ä¸€æ¬¡æŠ½å–">â†©ï¸ æ’¤éŠ·</button>
                <button id="btn-draw-reset" class="btn" title="æ¸…ç©ºå·²æŠ½ç´€éŒ„èˆ‡æ­·å²">é‡ç½®</button>
              </div>
              <div class="hint" id="draw-hint">å°šæœªè¼‰å…¥åå–®</div>
            </aside>

            <!-- å³ï¼šèšå…‰å€ -->
            <section class="spotlight-card">
              <div class="draw-stats">
                <span class="badge">å‰©é¤˜ <b id="draw-rem">--</b></span>
                <span class="badge">å…¨ç­ <b id="draw-total">--</b></span>
                <span class="badge">ä¸‹ä¸€æ¬¡ <b id="draw-next">--</b> äºº</span>
              </div>

              <div class="draw-result-wrap">
                <div class="draw-subtitle">æœ¬æ¬¡çµæœ</div>
                <div id="draw-result" class="draw-result"></div>
              </div>

              <div class="draw-history-wrap">
                <div class="draw-subtitle">æ­·å²ç´€éŒ„</div>
                <div id="draw-history" class="draw-history empty">å°šç„¡ç´€éŒ„</div>
              </div>
            </section>
          </div>
        </section>

      </section>
      </div>
    </main>
  </div>

  <!-- æ‹–æ”¾ä¸Šå‚³é®ç½© -->
  <div class="dropmask" id="dropmask"><div class="msg">ğŸ“¥ æ”¾é–‹ä»¥ä¸Šå‚³ Excel</div></div>

  <!-- èªªæ˜å½ˆçª— -->
  <div id="help-mask" class="modal-mask" role="dialog" aria-modal="true" aria-labelledby="help-title">
    <div class="modal" role="document">
      <header>
        <h3 id="help-title">â“ æ“ä½œèªªæ˜</h3>
        <button id="help-close" class="close" aria-label="é—œé–‰">âœ•</button>
      </header>
      <div id="help-content" class="content"></div>
    </div>
  </div>

  <!-- â˜… ä½œæ¥­æ‰¹æ¬¡è¼¸å…¥å½ˆçª— -->
  <div id="bulk-mask" class="modal-mask" role="dialog" aria-modal="true" aria-labelledby="bulk-title">
    <div class="modal" role="document">
      <header>
        <h3 id="bulk-title">âš¡ æ‰¹æ¬¡è¼¸å…¥ â€” <span id="bulk-colname"></span></h3>
        <button id="bulk-close" class="close" aria-label="é—œé–‰">âœ•</button>
      </header>
      <div class="content">
        <div class="hint">ç›®æ¨™ï¼š<span id="bulk-class" class="pill"></span> â†’ <span id="bulk-colname-2" class="pill"></span></div>
        <div class="divider"></div>

        <h4>æ–¹å¼ä¸€ï¼šæ•´æ¬„å¡«åŒåˆ†</h4>
        <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
          <label>åˆ†æ•¸ <input id="bulk-same-value" type="number" inputmode="numeric" style="width:100px; padding:6px 8px; border:1px solid var(--line); border-radius:8px; background:var(--card); color:var(--fg)"></label>
          <label style="display:flex; align-items:center; gap:6px;">
            <input id="bulk-only-empty-1" type="checkbox"> åªè¦†è“‹ç©ºç™½
          </label>
          <button id="bulk-apply-same" class="btn add">å¥—ç”¨åˆ°æ•´æ¬„</button>
        </div>

        <div class="divider"></div>

        <h4>æ–¹å¼äºŒï¼šè²¼ä¸Šå¤šç­†æˆç¸¾</h4>
        <div class="hint">æ”¯æ´å…©ç¨®å°æ‡‰æ–¹å¼ï¼š</div>
        <ol class="hint">
          <li>ä¾ç›®å‰è¡¨æ ¼é †åºï¼ˆæ¯è¡Œä¸€å€‹åˆ†æ•¸ï¼›å¿½ç•¥ç©ºè¡Œï¼‰</li>
          <li>æŒ‰åº§è™Ÿå°æ‡‰ï¼ˆæ¯è¡Œã€Œåº§è™Ÿ åˆ†æ•¸ã€æˆ–ã€Œåº§è™Ÿ,åˆ†æ•¸ã€ï¼‰</li>
        </ol>
        <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
          <label style="display:flex; align-items:center; gap:6px;">
            <input type="radio" name="bulk-mode" value="order" checked> ä¾è¡¨æ ¼é †åº
          </label>
          <label style="display:flex; align-items:center; gap:6px;">
            <input type="radio" name="bulk-mode" value="seat"> æŒ‰åº§è™Ÿå°æ‡‰
          </label>
          <label style="display:flex; align-items:center; gap:6px;">
            <input id="bulk-only-empty-2" type="checkbox"> åªè¦†è“‹ç©ºç™½
          </label>
        </div>
        <textarea id="bulk-paste" rows="8" style="width:100%; margin-top:8px; padding:10px; border:1px solid var(--line); border-radius:10px; background:var(--card); color:var(--fg);" placeholder="ä¾‹ï¼š&#10;ä¾è¡¨æ ¼é †åºï¼š&#10;78&#10;85&#10;...&#10;&#10;æŒ‰åº§è™Ÿå°æ‡‰ï¼š&#10;1 78&#10;2 85&#10;..."></textarea>
        <div style="display:flex; gap:10px; align-items:center; margin-top:8px;">
          <button id="bulk-apply-paste" class="btn add">å¥—ç”¨è²¼ä¸Šå€¼</button>
          <span class="hint">è²¼ä¸Šéæ•¸å­—å°‡å¿½ç•¥ï¼›ç©ºç™½è¡Œæœƒç•¥éã€‚</span>
        </div>
      </div>
    </div>
  </div>


  <!-- â˜… åˆªé™¤å­¸ç”Ÿå½ˆçª— -->
  <div id="del-mask" class="modal-mask" role="dialog" aria-modal="true" aria-labelledby="del-title">
    <div class="modal" role="document">
      <header>
        <h3 id="del-title">ğŸ—‘ åˆªé™¤å­¸ç”Ÿ</h3>
        <button id="del-close" class="close" aria-label="é—œé–‰">âœ•</button>
      </header>
      <div class="content">
        <div class="hint">ç›®å‰ç­ç´šï¼š<span id="del-class" class="pill"></span></div>
        <div style="margin:10px 0;">
          <label for="del-stu-select">è«‹é¸æ“‡è¦åˆªé™¤çš„å­¸ç”Ÿï¼š</label>
          <select id="del-stu-select" class="select" size="8" style="width:100%;"></select>
        </div>
        <div class="hint">åˆªé™¤å¾ŒæœƒåŒæ™‚å¾åº§ä½å®‰æ’ã€ä½œæ¥­æˆç¸¾ã€æŠ½è™Ÿç´€éŒ„ä¸­ç§»é™¤è©²å­¸ç”Ÿï¼Œä¸”ç„¡æ³•å¾©åŸã€‚</div>
        <div style="display:flex; gap:10px; justify-content:flex-end; margin-top:10px;">
          <button id="del-confirm" class="btn sub">åˆªé™¤å­¸ç”Ÿ</button>
        </div>
      </div>
    </div>
  </div>


  <!-- â˜… ä½œæ¥­æˆç¸¾ï¼šå­¸ç”Ÿå‚™è¨»å½ˆçª— -->
  <div id="note-mask" class="modal-mask" role="dialog" aria-modal="true" aria-labelledby="note-title">
    <div class="modal" role="document">
      <header>
        <h3 id="note-title">ğŸ“ å­¸ç”Ÿå‚™è¨»</h3>
        <button id="note-close" class="close" aria-label="é—œé–‰">âœ•</button>
      </header>
      <div class="content">
        <div class="note-meta">
          <div class="hint">
            ç­ç´šï¼š<span id="note-class" class="pill"></span>
            ã€€å­¸ç”Ÿï¼š<span id="note-student" class="pill"></span>
          </div>
          <div class="note-help">æç¤ºï¼šCtrl+Enter å„²å­˜ï¼ˆMac å¯ç”¨ âŒ˜+Enterï¼‰</div>
          <div class="note-count">å­—æ•¸ï¼š<span id="note-count">0</span></div>
        </div>

        <textarea id="note-text" rows="12" placeholder="è¼¸å…¥å‚™è¨»ï¼ˆä¾‹å¦‚ï¼šè£œäº¤ã€éœ€è¦é—œæ‡·ã€å®¶é•·è¯çµ¡ç´€éŒ„â€¦ï¼‰"></textarea>

        <div class="note-actions">
          <button id="note-del" class="btn sub" title="æ¸…ç©ºå‚™è¨»">æ¸…ç©º</button>
          <button id="note-cancel" class="btn" title="å–æ¶ˆï¼ˆä¸å„²å­˜ï¼‰">å–æ¶ˆ</button>
          <button id="note-save" class="btn" title="å„²å­˜å‚™è¨»">å„²å­˜</button>
        </div>
      </div>
    </div>
  </div>

</div>

  <script>
    /* ====== å…¨åŸŸç‹€æ…‹ ====== */
    const state={
      classMap:{}, classOrder:[], scores:{}, sidMap:{}, filter:"", savedScores:{}, seating:{}, mode:'list',
      hw:{}, savedHW:{}, draw:{}, showStageInList: true,
      // â˜… æ–°å¢ï¼šæ•™å­¸é€²åº¦ï¼ˆè·¨ç­å‹¾é¸ï¼‰èˆ‡å€’æ•¸è¨ˆæ™‚
      progress:{ pages:{}, order:[], active:'' },
      timer:{ setSec: 300, remainingSec: 300, running:false, endAt: 0 }
    };

    /* === è§¸æ§å‚™æ´ï¼šé»ä¸€ä¸‹é¸å– â†’ é»ä¸€ä¸‹æ”¾ç½® === */
    const IS_COARSE = window.matchMedia && window.matchMedia('(pointer: coarse)').matches;
    // æ–°å¢ï¼šåªè¦è£ç½®æœ‰è§¸æ§å°±å•Ÿç”¨ã€Œé»é¸ç§»å‹•ã€æ¨¡å¼ï¼ˆiPad/éƒ¨åˆ†å¹³æ¿æœƒå›å ± fineï¼‰
    const HAS_TOUCH = (('ontouchstart' in window) || navigator.maxTouchPoints > 0);
    const ENABLE_TAP_PICK = IS_COARSE || HAS_TOUCH;

    let pickedId = null;


    function pickTileById(id){
      if(!id) return;
      // æ¸…æ‰èˆŠçš„
      document.querySelectorAll('.tile.picked').forEach(el=> el.classList.remove('picked'));
      pickedId = id;
      const el = document.querySelector(`.tile[data-id="${CSS.escape(id)}"]`);
      el?.classList.add('picked');
      // è¦–è¦ºæç¤ºï¼ˆåœ¨åº§ä½æ¨¡å¼æ‰é¡¯ç¤ºï¼‰
      const hint = document.getElementById('seat-hint');
      if (hint) hint.textContent = 'å·²é¸å–ï¼šé»ä»»ä¸€åº§ä½æ ¼æ”¾ç½®ï¼›é»å³å´ç©ºç™½å€å¯æ”¾å›æœªå®‰æ’ã€‚';
    }

    function clearPicked(){
      pickedId = null;
      document.querySelectorAll('.tile.picked').forEach(el=> el.classList.remove('picked'));
      const hint = document.getElementById('seat-hint');
      if (hint && document.getElementById('mode-seat').classList.contains('active')){
        hint.textContent = ENABLE_TAP_PICK
          ? 'é»ä¸€ä¸‹å­¸ç”Ÿ â†’ é»åº§ä½æ”¾ç½®ï¼›å³å´ç©ºç™½å€å¯æ”¾å›æœªå®‰æ’ã€‚'
          : 'æ‹–æ›³å­¸ç”Ÿåˆ°åº§ä½ï¼›å³éµåº§ä½å¯æ¸…ç©ºï¼›ä¹Ÿå¯æ‹–å›å³å´ã€Œæœªå®‰æ’åå–®ã€ã€‚';
      }
    }


    // ===== æœ¬æ©Ÿæš«å­˜ï¼ˆæ•´ä»½ç‹€æ…‹ï¼‰ =====
    const SESSION_KEY = 'pscore_session_v1';

    function buildSession(){
      return {
        v: 1,
        classMap: state.classMap,
        classOrder: state.classOrder,
        scores: state.scores,
        sidMap: state.sidMap,
        seating: state.seating,
        hw: state.hw,
        // â˜… æ•™å­¸é€²åº¦ & å€’æ•¸è¨ˆæ™‚
        progress: state.progress,
        timer: state.timer,
        selectedClass: elSelect?.value || '',
        mode: state.mode,
        showStageInList: state.showStageInList,
        ts: Date.now()
      };
    }
    function saveSession(reason=''){
      try{
        localStorage.setItem(SESSION_KEY, JSON.stringify(buildSession()));
        // console.debug('[autosave]', reason);
      }catch(e){
        console.warn('æš«å­˜å¤±æ•—ï¼ˆå¯èƒ½è¶…éå®¹é‡ï¼‰', e);
      }
    }
    function tryRestoreSession(){
      try{
        const raw = localStorage.getItem(SESSION_KEY);
        if(!raw) return false;
        const s = JSON.parse(raw);
        if(!s || s.v!==1) return false;

        state.classMap   = s.classMap   || {};
        state.classOrder = s.classOrder || [];
        state.scores     = s.scores     || {};
        state.sidMap     = s.sidMap     || {};
        state.seating    = s.seating    || {};
        state.hw         = s.hw         || {};
        // â˜… æ•™å­¸é€²åº¦/å€’æ•¸è¨ˆæ™‚
        state.progress   = s.progress   || { items: [] };
        state.timer      = s.timer      || { setSec: 300, remainingSec: 300, running:false, endAt: 0 };

        // è‹¥å€’æ•¸è¨ˆæ™‚æ­£åœ¨é€²è¡Œï¼Œè®“å®ƒåœ¨èƒŒæ™¯ç¹¼çºŒè·‘
        try{
          ensureTimerState();
          syncTimerFromEndAt();
          if(state.timer?.running) startTimerInterval();
        }catch(e){ /* ignore */ }

        state.mode       = s.mode       || 'list';

        state.showStageInList = (typeof s.showStageInList === 'boolean') ? s.showStageInList : true;

        if(state.classOrder.length){
          renderClassOptions(state.classOrder);
          elSelect.disabled=false;
          elSelect.value = (s.selectedClass && state.classOrder.includes(s.selectedClass))
            ? s.selectedClass : state.classOrder[0];
          elSearch.disabled=false; state.filter='';
          if(elAddStudent) elAddStudent.disabled=false;
          if(elDelStudent) elDelStudent.disabled=false;

          // ä¾ç…§ä¸Šæ¬¡æ¨¡å¼æ¢å¾©ç•«é¢
          if(state.mode==='seat') setMode('seat');
          else if(state.mode==='hw') setMode('hw');
          else if(state.mode==='draw') setMode('draw'); // â˜…
          else setMode('list');


          renderStudents(elSelect.value);
          renderLeaderboard(elSelect.value);
          renderHW(elSelect.value);
          setStatus('å·²å¾æœ¬æ©Ÿæš«å­˜é‚„åŸã€‚');
          return true;
        }
      }catch(e){
        console.warn('é‚„åŸæš«å­˜å¤±æ•—', e);
      }
      return false;
    }

    /* ====== åº§ä½æ¬„ä½å¸¸æ•¸ï¼ˆçµ±ä¸€ï¼‰ ====== */
    const COL = Object.freeze({ R:'åº§ä½åˆ—', C:'åº§ä½æ¬„' });

    /* ====== DOM åƒç…§ ====== */
    const elFile=document.getElementById('file-input');
    const elSelect=document.getElementById('class-select');
    const elStudents=document.getElementById('students');
    const elStatus=document.getElementById('status');
    const elBoard=document.getElementById('leaderboard');
    const elBoardClass=document.getElementById('board-class');
    const elExport=document.getElementById('btn-export');
    const elSearch=document.getElementById('search-input');
    const elAddStudent=document.getElementById('btn-add-student');
    const elDelStudent=document.getElementById('btn-del-student');
    const elModeList=document.getElementById('mode-list');
    const elModeSeat=document.getElementById('mode-seat');
    const elModeHW=document.getElementById('mode-hw');
    const elModeProgress=document.getElementById('mode-progress');
    const elModeTimer=document.getElementById('mode-timer');
    const elSeatControls=document.getElementById('seat-controls');
    const elSeatboard=document.getElementById('seatboard');
    const elUnassigned=document.getElementById('unassigned');
    const elUnassignedList=document.getElementById('unassigned-list');
    const elSeatHint=document.getElementById('seat-hint');
    const elRows=document.getElementById('rows-input');
    const elCols=document.getElementById('cols-input');
    const elApplySize=document.getElementById('btn-apply-size');
    const elBtnDrawUndo = document.getElementById('btn-draw-undo');
    const elDrawAuto    = document.getElementById('draw-auto');
    const elDrawRem     = document.getElementById('draw-rem');
    const elDrawTotal   = document.getElementById('draw-total');
    const elDrawNext    = document.getElementById('draw-next');
    const elToggleStage = document.getElementById('btn-toggle-stage');
    const elToggleStageWrap = document.getElementById('toggle-stage-wrap');
    const elChkShowStage    = document.getElementById('chk-show-stage');




    /* â˜… ä½œæ¥­æˆç¸¾ DOM */
    const elProgressPane=document.getElementById('progress-pane');
    const elProgTable=document.getElementById('prog-table');
    const elProgPill=document.getElementById('prog-pill');
    const elProgPageSel=document.getElementById('prog-page-select');
    const elProgPageMenuBtn=document.getElementById('btn-prog-page-menu');
    const elProgPageMenu=document.getElementById('prog-page-menu');
    const elProgAdd=document.getElementById('btn-prog-add');
    const elProgDel=document.getElementById('btn-prog-del');
    const elProgAddClass=document.getElementById('btn-prog-addclass');
    const elProgDelClass=document.getElementById('btn-prog-delclass');

    const elTimerPane=document.getElementById('timer-pane');
    const elTimerDisplay=document.getElementById('timer-display');
    const elTimerMin=document.getElementById('timer-min');
    const elTimerSec=document.getElementById('timer-sec');
    const elTimerSet=document.getElementById('btn-timer-set');
    const elTimerStart=document.getElementById('btn-timer-start');
    const elTimerPause=document.getElementById('btn-timer-pause');
    const elTimerReset=document.getElementById('btn-timer-reset');
    const elTimerHint=document.getElementById('timer-hint');

    const elHWPane=document.getElementById('hw-pane');
    const elHWClassPill=document.getElementById('hw-class-pill');
    const elHWTable=document.getElementById('hw-table');
    const elHWAdd=document.getElementById('btn-hw-add');
    const elHWDel=document.getElementById('btn-hw-del');

    /* â˜… æŠ½è™Ÿ DOM */
    const elModeDraw = document.getElementById('mode-draw');
    const elDrawPane = document.getElementById('draw-pane');
    const elDrawClassPill = document.getElementById('draw-class-pill');
    const elDrawCount = document.getElementById('draw-count');
    const elDrawSeq = document.getElementById('draw-seq');
    const elDrawUnique = document.getElementById('draw-unique');
    const elBtnDraw = document.getElementById('btn-draw');
    const elBtnDrawReset = document.getElementById('btn-draw-reset');
    const elDrawResult = document.getElementById('draw-result');
    const elDrawHistory = document.getElementById('draw-history');
    const elDrawHint = document.getElementById('draw-hint');

    /* èªªæ˜å½ˆçª— DOM */
    const helpBtn = document.getElementById('btn-help');
    
    /* â˜… æ—¥æœŸæ™‚é–“ï¼ˆæ°‘åœ‹å¹´ + 24 å°æ™‚ï¼‰ */
    const dtDateEl = document.getElementById('dt-date');
    const dtTimeEl = document.getElementById('dt-time');
    function pad2(n){ return String(n).padStart(2,'0'); }
    function updateDateTime(){
      if(!dtDateEl || !dtTimeEl) return;
      const now = new Date();
      const rocYear = now.getFullYear() - 1911;
      const mm = pad2(now.getMonth()+1);
      const dd = pad2(now.getDate());
      const hh = pad2(now.getHours());
      const mi = pad2(now.getMinutes());
      const ss = pad2(now.getSeconds());
      dtDateEl.textContent = `${rocYear}å¹´${mm}æœˆ${dd}æ—¥`;
      dtTimeEl.textContent = `${hh}:${mi}:${ss}`;
    }
    updateDateTime();
    setInterval(updateDateTime, 1000);

const helpMask = document.getElementById('help-mask');
    const helpClose = document.getElementById('help-close');
    const helpContent = document.getElementById('help-content');
    const helpSrc = document.getElementById('help-src');

    /* â˜… æ‰¹æ¬¡è¼¸å…¥å½ˆçª— DOM */
    const bulkMask = document.getElementById('bulk-mask');
    const bulkClose = document.getElementById('bulk-close');
    const bulkColName = document.getElementById('bulk-colname');
    const bulkColName2 = document.getElementById('bulk-colname-2');
    const bulkClass = document.getElementById('bulk-class');
    const bulkSameVal = document.getElementById('bulk-same-value');
    const bulkOnlyEmpty1 = document.getElementById('bulk-only-empty-1');
    const bulkOnlyEmpty2 = document.getElementById('bulk-only-empty-2');
    const bulkApplySame = document.getElementById('bulk-apply-same');
    const bulkApplyPaste = document.getElementById('bulk-apply-paste');
    const bulkPaste = document.getElementById('bulk-paste');

    /* â˜… åˆªé™¤å­¸ç”Ÿå½ˆçª— DOM */
    const delMask = document.getElementById('del-mask');
    const delClose = document.getElementById('del-close');
    const delClass = document.getElementById('del-class');
    const delSelect = document.getElementById('del-stu-select');
    const delConfirm = document.getElementById('del-confirm');

    /* â˜… å­¸ç”Ÿå‚™è¨»å½ˆçª— DOM */
    const noteMask = document.getElementById('note-mask');
    const noteClose = document.getElementById('note-close');
    const noteClass = document.getElementById('note-class');
    const noteStudent = document.getElementById('note-student');
    const noteText = document.getElementById('note-text');
    const noteSave = document.getElementById('note-save');
    const noteDel = document.getElementById('note-del');

    
    const noteCancel = document.getElementById('note-cancel');
    const noteCount = document.getElementById('note-count');
/* ====== è¼•é‡æŒä¹…åŒ–ï¼ˆè®€å–ï¼‰ ====== */
    try{
      state.scores = JSON.parse(localStorage.getItem('scores_v2') || '{}') || {};
    }catch{ state.scores = {}; }

    // â˜… å­¸ç”Ÿå‚™è¨»ï¼ˆä½œæ¥­æˆç¸¾åº§è™Ÿå‰çš„ ğŸ“ï¼‰
    try{
      state.notes = JSON.parse(localStorage.getItem('stu_notes_v1') || '{}') || {};
    }catch{ state.notes = {}; }
    function saveNotes(){
      try{ localStorage.setItem('stu_notes_v1', JSON.stringify(state.notes||{})); }catch(e){}
    }
    function getNote(cls, id){
      if(!cls || !id) return '';
      return (state.notes && state.notes[cls] && state.notes[cls][id]) ? String(state.notes[cls][id]) : '';
    }
    function setNote(cls, id, note){
      if(!cls || !id) return;
      if(!state.notes) state.notes = {};
      if(!state.notes[cls]) state.notes[cls] = {};
      const v = String(note||'').trim();
      if(v===''){
        delete state.notes[cls][id];
        if(Object.keys(state.notes[cls]).length===0) delete state.notes[cls];
      }else{
        state.notes[cls][id] = v;
      }
      saveNotes();
    }

    function loadHWFromLS(cls){ try{ const raw=localStorage.getItem('hw_v1__'+cls); if(raw){ state.hw[cls]=JSON.parse(raw); } }catch{} }
    function saveHWToLS(cls){ try{ localStorage.setItem('hw_v1__'+cls, JSON.stringify(state.hw[cls]||{}));saveSession('hw change'); }catch{} }

    /* ====== æª”æ¡ˆä¸Šå‚³ (é»é¸/æ‹–æ”¾) ====== */
    elFile.addEventListener('change', async (e)=>{ const file=e.target.files?.[0]; if(file) await handleFile(file); e.target.value=''; });
    const dropmask=document.getElementById('dropmask'); let dragCounter=0;
    function isFileDrag(e){ const dt=e.dataTransfer; if(!dt) return false; const types=Array.from(dt.types||[]); return types.includes('Files')||types.includes('application/x-moz-file'); }
    ['dragenter','dragover'].forEach(evt=>{ window.addEventListener(evt, e=>{ if(!isFileDrag(e)) return; e.preventDefault(); dragCounter++; dropmask.classList.add('show'); }); });
    window.addEventListener('dragleave', e=>{ if(!isFileDrag(e)) return; e.preventDefault(); dragCounter=Math.max(0,dragCounter-1); if(dragCounter===0) dropmask.classList.remove('show'); });
    window.addEventListener('drop', async (e)=>{ const f=e.dataTransfer?.files?.[0]; dragCounter=0; dropmask.classList.remove('show'); if(f){ e.preventDefault(); await handleFile(f); } });

    /* ====== è§£æ Excel ====== */
    async function handleFile(file){
      try{
        setStatus(`æ­£åœ¨è§£æï¼š${file.name} ...`);
        const data=await file.arrayBuffer();
        const wb=XLSX.read(data,{type:'array'});
        const map={}; const order=[];
        wb.SheetNames.forEach((sheetName)=>{
          // â˜… æ•™å­¸é€²åº¦åˆ†é ï¼ˆç”¨ A1=æ•™å­¸é€²åº¦ åˆ¤å®šï¼Œä¸ä¾è³´å·¥ä½œè¡¨åç¨±ï¼‰
          const ws=wb.Sheets[sheetName]; if(!ws) return;

          const a1 = String((ws['A1'] && (ws['A1'].v ?? ws['A1'].w)) || '').trim();
          if(a1.replace(/\s+/g,'') === 'æ•™å­¸é€²åº¦'){
            try{ parseProgressSheet(ws, sheetName); }catch(e){ console.warn('æ•™å­¸é€²åº¦è§£æå¤±æ•—', e); }
            return;
          }

          const rows=XLSX.utils.sheet_to_json(ws,{header:1,raw:false});
          if(!rows||rows.length===0) return;
          const header=rows[0].map(v=>String(v||'').trim());

          const idIdx=findIdColumnIndex(header);
          const seatIdx=findSeatColumnIndex(header);
          const nameIdx=findNameColumnIndex(header);
          const scoreIdx=findScoreColumnIndex(header);
          const noteIdx=findNoteColumnIndex(header);

          const seatRIdx = header.findIndex(h => h === COL.R);
          const seatCIdx = header.findIndex(h => h === COL.C);

          const hwCols=[]; header.forEach((h,i)=>{ if(/^(ä½œæ¥­)\s*(\d+)$/i.test(h) || /^HW\s*(\d+)$/i.test(h)) hwCols.push({name:h, idx:i}); });

          const pendingCoords=[]; let maxR=0, maxC=0;
          const list=[];
          if(!state.hw[sheetName]) state.hw[sheetName]={ cols: hwCols.map(c=>c.name), data:{} };

          for(let r=1;r<rows.length;r++){
            const row=rows[r]; if(!row||row.length===0) continue;
            const name=String(row[nameIdx]??'').trim(); if(!name) continue;
            const seat=seatIdx>=0?String(row[seatIdx]??'').trim():'';
            const sid=(idIdx>=0?String(row[idIdx]??'').trim():'');
            const id = sid ? `SID__${sid}` : makeFallbackId(sheetName, seat, name);
            list.push({id,sid,name, seat, row:r+1, sheet:sheetName});

            // å‚™è¨»ï¼ˆå¯é¸ï¼‰
            if(noteIdx>=0){
              const note = String(row[noteIdx]??'').trim();
              if(note){
                if(!state.notes) state.notes = {};
                if(!state.notes[sheetName]) state.notes[sheetName] = {};
                state.notes[sheetName][id] = note;
              }
            }

            if(seatRIdx>=0 && seatCIdx>=0){
              const rr=Number(row[seatRIdx]); const cc=Number(row[seatCIdx]);
              if(Number.isFinite(rr)&&Number.isFinite(cc)&&rr>=1&&rr<=9&&cc>=1&&cc<=9){
                pendingCoords.push({rr,cc,id}); maxR=Math.max(maxR,rr); maxC=Math.max(maxC,cc);
              }
            }

            // â€”â€” åŸæœ¬æ‰¾åˆ° scoreIdx ä¹‹å¾Œçš„è™•ç†ï¼Œæ”¹æˆï¼š
            if (scoreIdx >= 0){
              const sc = Number(row[scoreIdx]);
              if (Number.isFinite(sc)){
                setScore(sheetName, id, sc);                // â˜… ç­ç´šå‘½åç©ºé–“
              }else if (!hasScore(sheetName, id)){
                const legacy = Number(state.legacyScores?.[id]);
                if (Number.isFinite(legacy)) setScore(sheetName, id, legacy); // å…¼å®¹èˆŠè³‡æ–™
                else setScore(sheetName, id, 0);
              }
            }else{
              if (!hasScore(sheetName, id)){
                const legacy = Number(state.legacyScores?.[id]);
                if (Number.isFinite(legacy)) setScore(sheetName, id, legacy);
                else setScore(sheetName, id, 0);
              }
            }

            if(sid) state.sidMap[id]={sid, sheet:sheetName, seat, name};

            if(hwCols.length){
              const arr=[]; hwCols.forEach((c,ci)=>{ const v=row[c.idx]; const n=(v===''||v==null)?'':Number(v); arr[ci]=(Number.isFinite(n)?n:''); });
              state.hw[sheetName].data[id]=arr;
            }
          }

          if(!hwCols.length){ loadHWFromLS(sheetName); }

          const rowsCnt=clampSize(maxR||6); const colsCnt=clampSize(maxC||6);
          const seatMapForSheet={};
          for(const {rr,cc,id} of pendingCoords){
            const rTop=rowsCnt-rr+1; const cLeft=colsCnt-cc+1; seatMapForSheet[rTop+'-'+cLeft]=id;
          }
          if(Object.keys(seatMapForSheet).length){ state.seating[sheetName]={rows:rowsCnt, cols:colsCnt, map:seatMapForSheet}; }

          if(list.length){ map[sheetName]=list; order.push(sheetName); }
        });

        if(order.length===0) throw new Error('æ²’æœ‰åµæ¸¬åˆ°ä»»ä½•ç­ç´šæˆ–å§“åè³‡æ–™');
        state.classMap=map; state.classOrder=order;
        renderClassOptions(order);
        elSelect.disabled=true; elSelect.disabled=false; elSelect.value=order[0];
        elSearch.disabled=false; elSearch.value=""; state.filter="";
        if(elAddStudent) elAddStudent.disabled=false;
        if(elDelStudent) elDelStudent.disabled=false;
        renderStudents(order[0]); renderLeaderboard(order[0]); renderHW(order[0]);
        saveNotes();
        setStatus(`å·²è¼‰å…¥ ${order.length} å€‹ç­ç´šã€‚`);
        saveSession('after import');   // â˜… æ–°å¢ï¼šåŒ¯å…¥å¾Œå³æš«å­˜æ•´ä»½ç‹€æ…‹
      }catch(err){ alert('è§£æå¤±æ•—ï¼š'+err.message); setStatus('è§£æå¤±æ•—'); }
    }

    elSelect.addEventListener('change',(e)=>{
      const cls=e.target.value; if(!cls) return;
      renderStudents(cls); renderLeaderboard(cls);
      if(state.mode==='seat') renderSeatUI(cls);
      if(state.mode==='hw') renderHW(cls);
      if(state.mode==='draw') renderDraw(cls);
      saveSession('class change');   // â˜… æ–°å¢
    });

    // â• æ–°å¢è½‰å­¸ç”Ÿ
    elAddStudent?.addEventListener('click', ()=>{
      const cls = elSelect.value;
      if(!cls){
        alert('è«‹å…ˆé¸æ“‡ç­ç´š');
        return;
      }

      const sid = (prompt('è«‹è¼¸å…¥ã€å­¸è™Ÿã€‘ï¼ˆä¾‹ï¼šA031ï¼‰ï¼š') || '').trim();
      if(!sid) return;

      const id = `SID__${sid}`;
      const list = state.classMap[cls] || [];

      if(list.some(s => s.id === id)){
        alert('é€™å€‹å­¸è™Ÿåœ¨æœ¬ç­å·²ç¶“å­˜åœ¨å›‰ï¼');
        return;
      }

      const name = (prompt('è«‹è¼¸å…¥ã€å§“åã€‘ï¼š') || '').trim() || sid;
      const seatRaw = (prompt('è«‹è¼¸å…¥ã€åº§è™Ÿã€‘ï¼ˆå¯ç•™ç©ºï¼‰ï¼š') || '').trim();
      const seat = seatRaw || '';

      const student = { id, sid, name, seat, row: null, sheet: cls };

      list.push(student);
      state.classMap[cls] = list;

      state.sidMap[id] = { sid, sheet: cls, seat, name };

      setScore(cls, id, 0);

      renderStudents(cls);
      renderLeaderboard(cls);
      if(state.mode==='seat') renderSeatUI(cls);
      if(state.mode==='hw') renderHW(cls);
      if(state.mode==='draw') renderDraw(cls);

      saveSession('add student');
    });

    // ğŸ—‘ åˆªé™¤å­¸ç”Ÿï¼ˆè½‰å­¸ç”Ÿï¼‰
    elDelStudent?.addEventListener('click', ()=>{
      const cls = elSelect.value;
      if(!cls){
        alert('è«‹å…ˆé¸æ“‡ç­ç´š');
        return;
      }
      openDelModal(cls);
    });

    // ğŸ” ä¾ç›®å‰æ¨¡å¼å³æ™‚æ¸²æŸ“ + Enter æ¸…é™¤
    elSearch.addEventListener('input', ()=>{
      state.filter=elSearch.value.trim();
      const cls=elSelect.value;
      if(state.mode==='list') renderStudents(cls);
      else if(state.mode==='seat') renderSeatUI(cls);
      else if(state.mode==='hw') renderHW(cls);
    });
    elSearch.addEventListener('keydown',(e)=>{
      if(e.key==='Enter'){
        elSearch.value=''; state.filter='';
        const cls=elSelect.value;
        if(state.mode==='list') renderStudents(cls);
        else if(state.mode==='seat') renderSeatUI(cls);
        else if(state.mode==='hw') renderHW(cls);
      }
    });

    /* ===== åŒ¯å‡º Excelï¼ˆå¯é¸è³‡æ–™å¤¾ï¼‹å¯æ”¹æª”åï¼›ä¸æ”¯æ´å‰‡é€€å›ä¸‹è¼‰ï¼‰ ===== */
    async function exportWorkbookWithPicker(wb, suggestedName){
      const mime = 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet';

      // èµ°åŸç”Ÿå¦å­˜å°è©±æ¡†ï¼ˆChrome / Edge ç­‰ï¼›éœ€ https æˆ– localhostï¼‰
      if (window.showSaveFilePicker && isSecureContext) {
        try {
          const handle = await window.showSaveFilePicker({
            suggestedName,
            types: [{
              description: 'Excel æ´»é ç°¿ (.xlsx)',
              accept: { [mime]: ['.xlsx'] }
            }],
            excludeAcceptAllOption: false
          });

          // ç”± xlsx ç”¢å‡ºä½å…ƒçµ„é™£åˆ— â†’ blob â†’ å¯«å…¥ä½¿ç”¨è€…é¸çš„è·¯å¾‘
          const data = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
          const blob = new Blob([data], { type: mime });
          const writable = await handle.createWritable();
          await writable.write(blob);
          await writable.close();

          setStatus(`å·²å„²å­˜ï¼š${handle.name}`);
          return;
        } catch (err) {
          if (err && err.name === 'AbortError') {
            setStatus('å·²å–æ¶ˆåŒ¯å‡ºã€‚');
            return;
          }
          console.warn('showSaveFilePicker å¤±æ•—ï¼Œæ”¹ç”¨ä¸‹è¼‰ï¼š', err);
          // å¤±æ•—å°±è½å›ä¸‹è¼‰
        }
      }

      // é€€å›åŸæœ¬ä¸‹è¼‰æ–¹å¼
      XLSX.writeFile(wb, suggestedName);
      setStatus(`å·²é–‹å§‹ä¸‹è¼‰ï¼š${suggestedName}`);
    }

    /* ===== åŒ¯å‡º Excel ===== */
    document.getElementById('btn-export').addEventListener('click', async ()=>{
      try{
        const wb = XLSX.utils.book_new();

        for(const cls of state.classOrder){
          const list = state.classMap[cls] || [];
          const seatSt = ensureSeatState(cls);
          const hwSt = ensureHWState(cls);

          // === å»ºè¡¨é ­ï¼ˆåœ¨ for(const cls of state.classOrder) å…§ï¼‰===
          const header = ['å­¸è™Ÿ','åº§è™Ÿ','å§“å','å‚™è¨»','åˆ†æ•¸', ...hwSt.cols, 'å°è¨ˆ', 'å¹³å‡', COL.R, COL.C];
          const aoa = [header];

          for (const s of list){
            const id = s.id, sc = getScore(cls, id);
            const sid = s.sid || (state.sidMap[id]?.sid) || '';

            // ç›®å‰åº§æ¨™ï¼ˆç…§ä½ åŸé‚è¼¯è½‰å›å³ä¸‹è§’ç‚º 1 çš„åº§æ¨™ï¼‰
            const pos = findSeatPos(cls, id);
            let rr='', cc='';
            if (pos){ rr = seatSt.rows - pos.r + 1; cc = seatSt.cols - pos.c + 1; }

            // ä½œæ¥­åˆ†æ•¸é™£åˆ—
            const arr = (hwSt.data[id] || []).slice(0, hwSt.cols.length);
            while (arr.length < hwSt.cols.length) arr.push('');

            // â˜… å°è¨ˆ / å¹³å‡ï¼ˆå¹³å‡åƒ…è¨ˆå…¥æœ‰å¡«å¯«çš„æ ¼ï¼‰
            const sum = arr.reduce((t,v)=> t + (Number.isFinite(Number(v)) ? Number(v) : 0), 0);
            const cnt = arr.filter(v => v!=='' && v!=null && Number.isFinite(Number(v))).length;
            const avg = cnt ? Math.round((sum / cnt) * 100) / 100 : 0;  // ä¿ç•™å…©ä½

            // â˜… ä¸€èµ·åŒ¯å‡ºï¼ˆå°è¨ˆã€å¹³å‡ æ¥åœ¨å„ä½œæ¥­å¾Œé¢ï¼‰
            aoa.push([sid, s.seat ?? '', s.name ?? '', getNote(cls, id), sc, ...arr, sum, avg, rr, cc]);
          }

          // æ¬„å¯¬ï¼ˆå¤šäº†ã€Œå°è¨ˆã€ã€Œå¹³å‡ã€å„ä¸€æ¬„ï¼‰
          const ws = XLSX.utils.aoa_to_sheet(aoa);
          const baseCols = [{wch:14},{wch:6},{wch:12},{wch:24},{wch:8}];       // å­¸è™Ÿ/åº§è™Ÿ/å§“å/å‚™è¨»/åˆ†æ•¸
          const hwColsW = Array.from({length: hwSt.cols.length}, ()=>({wch:8}));
          ws['!cols'] = [
            ...baseCols,
            ...hwColsW,
            {wch:8},                 // å°è¨ˆ
            {wch:8},                 // å¹³å‡
            {wch:8}, {wch:8}         // åº§ä½åˆ— / åº§ä½æ¬„
          ];
          XLSX.utils.book_append_sheet(wb, ws, safeSheetName(cls));
        }

                // â˜… å¦å¤–åŒ¯å‡ºï¼šæ•™å­¸é€²åº¦ï¼ˆæ–°è¡¨å–®ï¼‰
        appendProgressSheet(wb);

// é è¨­æª”åï¼šèˆ‡åŸæœ¬ä¸€è‡´
        const ts=new Date(), pad=n=>String(n).padStart(2,'0');
        const fname=`æˆç¸¾åŒ¯å‡º_${ts.getFullYear()}${pad(ts.getMonth()+1)}${pad(ts.getDate())}_${pad(ts.getHours())}${pad(ts.getMinutes())}.xlsx`;

        await exportWorkbookWithPicker(wb, fname);
      }catch(err){
        alert('åŒ¯å‡ºå¤±æ•—ï¼š'+err.message);
      }
    });

    // å–å¾—æŒ‰éˆ•
    const elReset = document.getElementById('btn-reset');

    // æ¸…é™¤æœ¬ç³»çµ±ä½¿ç”¨åˆ°çš„ localStorageï¼ˆä¸å½±éŸ¿ä¸»é¡Œ KEYï¼‰
    // âœ… å®Œå…¨æ¸…ç©ºæœ¬ç³»çµ±ä½¿ç”¨åˆ°çš„ localStorageï¼ˆä¿ç•™ä¸»é¡Œ KEYï¼‰
    function clearAllAppStorage(){
      try{
        localStorage.removeItem(SESSION_KEY);          // æ•´ä»½å¿«ç…§
        localStorage.removeItem('scores_v1');          // å¹³æ™‚åˆ†æ•¸
        localStorage.removeItem('scores_v2');   // â˜… æ–°ç‰ˆåˆ†æ•¸ä¹Ÿæ¸…æ‰
        localStorage.removeItem('stu_notes_v1'); // â˜… å­¸ç”Ÿå‚™è¨»

        // ä½œæ¥­ & åº§ä½éƒ½ä¸€ä½µæ¸…é™¤
        const toRemove = [];
        for(let i=0;i<localStorage.length;i++){
          const k = localStorage.key(i);
          if(!k) continue;
          if (k.startsWith('hw_v1__') || k.startsWith('seat_v1__')) toRemove.push(k);
        }
        toRemove.forEach(k => localStorage.removeItem(k));
      }catch(e){
        console.warn('æ¸…é™¤æš«å­˜æ™‚ç™¼ç”ŸéŒ¯èª¤', e);
      }
    }

    // âœ… å›åˆ°å‰›é–‹é æ™‚çš„ä¹¾æ·¨ UIï¼ˆåƒé‚„æ²’ä¸Šå‚³æª”æ¡ˆï¼‰
    function hardResetApp(){
      // 1) æ¸…ç©ºè¨˜æ†¶é«”ç‹€æ…‹
      state.classMap   = {};
      state.classOrder = [];
      state.sidMap     = {};
      state.seating    = {};
      state.scores     = {};
      state.legacyScores = {};
      state.hw         = {};
      state.savedHW    = {};
      state.filter     = '';
      state.mode       = 'list';
      state.progress   = { items: [] };
      state.timer = { setSec: 300, remainingSec: 300, running:false, endAt: 0, doneNotified:false };
      stopTimerInterval();

      // 2) é‚„åŸ UI æ§åˆ¶
      elSelect.innerHTML = '<option value="" selected>è«‹å…ˆä¸Šå‚³å­¸ç”Ÿåå–®</option>';
      elSelect.disabled = true;

      elSearch.value = '';
      elSearch.disabled = true;

      if(elAddStudent) elAddStudent.disabled = true;
      if(elDelStudent) elDelStudent.disabled = true;

      // åˆ—è¡¨ / æ’è¡Œæ¦œ
      document.getElementById('students').innerHTML = '';
      elBoard.innerHTML = '<div class="empty">æ­¤ç­ç´šå°šç„¡æˆå“¡</div>';
      elBoardClass.textContent = 'å°šæœªè¼‰å…¥';

      // åº§ä½é 
      elRows.value = 6; 
      elCols.value = 6;
      elSeatboard.innerHTML = '';
      elUnassignedList.innerHTML = '';
      elSeatHint.textContent = 'è«‹å…ˆä¸Šå‚³å­¸ç”Ÿåå–®';

      // ä½œæ¥­é 
      elHWTable.innerHTML = '';
      elHWClassPill.textContent = 'å°šæœªè¼‰å…¥';

      // æ•™å­¸é€²åº¦ / å€’æ•¸è¨ˆæ™‚
      if(elProgTable) elProgTable.innerHTML = '';
      if(elTimerDisplay) elTimerDisplay.textContent = '00:00';
      if(elTimerHint) elTimerHint.textContent = '';
      if(elTimerMin) elTimerMin.value = 5;
      if(elTimerSec) elTimerSec.value = 0;


      // é¡¯ç¤ºæ¨¡å¼å›åˆ—è¡¨ã€ç‹€æ…‹æç¤º
      setMode('list');
      setStatus('å·²æ¸…é™¤æ‰€æœ‰æœ¬æ©Ÿæš«å­˜èˆ‡åå–®ã€‚');
    }

    // âœ… æ¸…é™¤ â†’ å®Œå…¨å›åˆ°æœªä¸Šå‚³æª”æ¡ˆçš„ç‹€æ…‹
    elReset?.addEventListener('click', ()=>{
      if(!confirm('ç¢ºå®šæ¸…é™¤æ‰€æœ‰æœ¬æ©Ÿè³‡æ–™å—ï¼Ÿ\nå°‡ç§»é™¤ï¼šå­¸ç”Ÿåå–®ã€åˆ†æ•¸ã€ä½œæ¥­ã€åº§ä½ï¼ˆå«æ ¼æ•¸èˆ‡é…ä½ï¼‰èˆ‡å¿«é€Ÿé‚„åŸã€‚'))
        return;
      clearAllAppStorage();
      hardResetApp();
    });

    // è®“æ¸…é™¤æŒ‰éˆ•ä¹Ÿæœ‰ ripple æ•ˆæœï¼ˆå¯é¸ï¼‰
    if (typeof bindRipple === 'function' && elReset) bindRipple(elReset);


    function renderClassOptions(order){ elSelect.innerHTML=''; for(const cls of order){ const opt=document.createElement('option'); opt.value=cls; opt.textContent=cls; elSelect.appendChild(opt); } }

    const io = new IntersectionObserver((entries)=>{ entries.forEach(e=>{ if(e.isIntersecting){ e.target.classList.add('show'); io.unobserve(e.target); } }); }, { threshold:.2 });

    function applyStageToggleUI(){
      if(!elToggleStage) return;
      const on = !!state.showStageInList;
      elToggleStage.textContent = on ? 'ğŸ“£ éš±è—è¬›å°' : 'ğŸ“£ é¡¯ç¤ºè¬›å°';
      elToggleStage.setAttribute('aria-pressed', String(on));
      elToggleStage.title = 'åƒ…åº§ä½æ¨¡å¼æœ‰æ•ˆ';
    }

    elToggleStage?.addEventListener('click', ()=>{
      state.showStageInList = !state.showStageInList;
      applyStageToggleUI();

      // â˜… å´æ¬„/æ’è¡Œæ¦œï¼šåªåœ¨ã€ŒåŠ æ‰£åˆ†ã€æ¨¡å¼é¡¯ç¤ºï¼Œå…¶ä»–æ¨¡å¼è‡ªå‹•æ”¶åˆä¸¦éš±è—åˆ‡æ›éˆ•
      try{
        const layout = document.querySelector('.layout');
        const sbtn   = document.getElementById('btn-sidebar');
        if(m !== 'list'){
          layout?.classList.add('is-collapsed');
          sbtn?.classList.add('hidden');
        }else{
          sbtn?.classList.remove('hidden');
          const collapsed = localStorage.getItem('sidebar_collapsed_v1') === '1';
          layout?.classList.toggle('is-collapsed', collapsed);
          if(sbtn){
            sbtn.textContent = collapsed ? 'â€º' : 'â€¹';
            sbtn.setAttribute('aria-expanded', String(!collapsed));
            sbtn.setAttribute('title', collapsed ? 'å±•é–‹å´æ¬„' : 'æ”¶åˆå´æ¬„');
          }
        }
      }catch(_){}

      // â˜… æ•™å­¸é€²åº¦æ¨¡å¼ä¸é¡¯ç¤ºå·¥å…·åˆ—
      document.querySelector('.controls-row')?.classList.toggle('hidden', m==='progress');

      if(state.mode === 'list') renderStudents(elSelect.value); // åªå½±éŸ¿ã€Œåº§ä½ã€æ¨¡å¼
      saveSession('toggle stage in list');
    });


    /* ====== å…±ç”¨å·¥å…· ====== */
    // â˜… åˆ†æ•¸ç”¨çš„è¤‡åˆéµï¼šç­ç´š + idï¼Œé¿å…è·¨è¡¨ç›¸æ’
    function scoreKey(cls, id){
      return `C:${safeSheetName(cls)}::${id}`;
    }

    function hasScore(cls, id){
      return (scoreKey(cls, id) in state.scores);
    }

    function getScore(cls, id){
      const v = state.scores[scoreKey(cls, id)];
      const n = Number(v);
      return Number.isFinite(n) ? n : 0;
    }

    // å„²å­˜åˆ°æ–°ç‰ˆ localStorageï¼ˆscores_v2ï¼‰ä¸¦å¿«ç…§
    function setScore(cls, id, val){
      state.scores[scoreKey(cls, id)] = Number(val) || 0;
      try{
        localStorage.setItem('scores_v2', JSON.stringify(state.scores));
        saveSession('score change');
      }catch{}
    }


    function animateNumber(el, from, to, dur){ const start=performance.now(); const fmt=n=>Math.round(n); function frame(t){ const p=Math.min(1,(t-start)/dur); const v=from+(to-from)*(1-Math.pow(1-p,3)); el.textContent=fmt(v); if(p<1) requestAnimationFrame(frame); } requestAnimationFrame(frame); }
    function bindRipple(btn){ btn.addEventListener('click', (e)=>{ const r=document.createElement('span'); r.className='ripple'; const rect=btn.getBoundingClientRect(); r.style.left=(e.clientX-rect.left)+'px'; r.style.top=(e.clientY-rect.top)+'px'; btn.appendChild(r); setTimeout(()=>r.remove(), 480); }); }

    // âœ… åº§è™Ÿè£œé›¶ & æœå°‹ç›¸å®¹
    function padSeat(seat){
      const s = String(seat ?? '').trim();
      if(s==='') return '';
      const n = Number(s);
      if(Number.isFinite(n) && n>=0 && n<10) return '0' + n; // 0~9 è£œ 0
      return s;
    }
    function normalizeSeatForSearch(seat){
      const raw = String(seat ?? '').trim();
      const padded = padSeat(raw);
      return {
        raw: raw.toLowerCase(),
        pad: padded.toLowerCase(),
        hashRaw: ('#'+raw).toLowerCase(),
        hashPad: ('#'+padded).toLowerCase(),
      };
    }

    function matchFilter(s, q){
      if(!q) return true;
      q = q.toLowerCase();
      const nameHit = (s.name||'').toLowerCase().includes(q);
      const ns = normalizeSeatForSearch(s.seat);
      return nameHit || ns.raw.includes(q) || ns.pad.includes(q) || ns.hashRaw.includes(q) || ns.hashPad.includes(q);
    }
    function setStatus(text){ elStatus.textContent=text; }
    function escapeHTML(str){ return String(str).replace(/[&<>]/g, s=>({'&':'&amp;','<':'&lt;','>':'&gt;'}[s])); }

    // ğŸ” å°‡æ–‡å­—ä¸­ç¬¦åˆ q çš„éƒ¨åˆ†åŠ ä¸Š .hlï¼ˆä¸åˆ†å¤§å°å¯«ï¼‰
    function highlightHTML(text, q){
      const t = String(text ?? '');
      if(!q) return escapeHTML(t);
      const qi = String(q).toLowerCase();
      const idx = t.toLowerCase().indexOf(qi);
      if(idx === -1) return escapeHTML(t);
      return (
        escapeHTML(t.slice(0, idx)) +
        `<span class="hl">${escapeHTML(t.slice(idx, idx + q.length))}</span>` +
        escapeHTML(t.slice(idx + q.length))
      );
    }
    // ğŸ” åº§è™Ÿé¡¯ç¤ºæ°¸é å¸¶ # ä¸¦è£œé›¶ï¼›æœå°‹å¯åŒæ™‚å‘½ä¸­ã€Œ1ã€èˆ‡ã€Œ01ã€
    function highlightSeat(seat, q){
      const padded = padSeat(seat);
      const full = '#' + padded;
      if(!q) return escapeHTML(full);
      const ql = String(q).toLowerCase();
      const idx = full.toLowerCase().indexOf(ql);
      if(idx === -1) return escapeHTML(full);
      return (
        escapeHTML(full.slice(0, idx)) +
        `<span class="hl">${escapeHTML(full.slice(idx, idx + q.length))}</span>` +
        escapeHTML(full.slice(idx + q.length))
      );
    }

    function findIdColumnIndex(header){ const low=header.map(h=>String(h||'').toLowerCase()); const cand=['å­¸è™Ÿ','å­¸ç±è™Ÿ','student id','id','å­¸è™Ÿç¢¼']; for(let i=0;i<low.length;i++){ if(cand.includes(low[i])) return i; } for(let i=0;i<header.length;i++){ if(/å­¸è™Ÿ|student\s*id|^id$/i.test(header[i])) return i; } return -1; }
    function findNameColumnIndex(header){ const low=header.map(h=>String(h||'').toLowerCase()); const cand=['å§“å','å­¸ç”Ÿå§“å','å­¸ç”Ÿ','name','student']; for(let i=0;i<low.length;i++){ if(cand.includes(low[i])) return i; } for(let i=0;i<header.length;i++){ if(/name|å§“å|å­¸ç”Ÿ/i.test(header[i])) return i; } return 0; }
    function findSeatColumnIndex(header){
      const low = header.map(h=>String(h||'').trim().toLowerCase().replace(/\s+/g,''));
      const cand = [
        'åº§è™Ÿ','åº§ä½','åº§ä½è™Ÿ','åº§è™Ÿ(åº§ä½)','åº§ä½(åº§è™Ÿ)','è™Ÿç¢¼','è™Ÿ',
        'no','number','seat','seatno','seatnumber','seat_no','seat-number','#'
      ].map(s=>s.toLowerCase().replace(/\s+/g,''));
      for(let i=0;i<low.length;i++){
        if(cand.includes(low[i])) return i;
      }
      // å†æ”¾å¯¬ä¸€é»ï¼šåªè¦åƒã€Œåº§è™Ÿ/åº§ä½/seat/no/numberã€
      for(let i=0;i<header.length;i++){
        const h=String(header[i]||'');
        if(/åº§è™Ÿ|åº§ä½|seat|\bno\b|number|^#$/i.test(h)) return i;
      }
      return -1;
    }

    function findNoteColumnIndex(header){
      // åš´æ ¼åŒ¹é…ï¼ˆæœ€ç©©ï¼‰
      for(let i=0;i<header.length;i++){
        const h=String(header[i]||'').trim();
        if(/^(å‚™è¨»|è¨»è¨˜|å‚™è€ƒ|å‚™å¿˜|å‚™è¨»å…§å®¹|note|remark|comments?)$/i.test(h)) return i;
      }
      // æ”¾å¯¬åŒ¹é…ï¼ˆå…è¨±ã€Œå­¸ç”Ÿå‚™è¨»ã€ã€Œå‚™è¨»(å¯é¸)ã€ï¼‰
      for(let i=0;i<header.length;i++){
        const h=String(header[i]||'').trim();
        if(/å‚™è¨»|è¨»è¨˜|note|remark|comment/i.test(h)) return i;
      }
      return -1;
    }
    function findScoreColumnIndex(header){ const low=header.map(h=>String(h||'').toLowerCase()); const cand=['åˆ†æ•¸','æˆç¸¾','score','points']; for(let i=0;i<low.length;i++){ if(cand.includes(low[i])) return i; } for(let i=0;i<header.length;i++){ if(/åˆ†æ•¸|æˆç¸¾|score|points?/i.test(header[i])) return i; } return -1; }

    function makeFallbackId(sheet, seat, name){ const norm=(v)=>String(v??'').trim().replace(/\s+/g,'_').replace(/[^\w\u4e00-\u9fa5\-]/g,''); return `FALLBACK__${norm(sheet)}__${norm(seat)}__${norm(name)}`; }
    function safeSheetName(name){ return String(name).slice(0,31).replace(/[\\\/?*\[\]:]/g,'-') || 'Sheet'; }

    function clampSize(n){ n=Number(n); if(!Number.isFinite(n)) return 6; return Math.max(1, Math.min(9, Math.round(n))); }
    function ensureSeatState(cls){
      if(!cls) return {rows:6, cols:6, map:{}};
      if(!state.seating[cls]){
        const raw=localStorage.getItem('seat_v1__'+cls);
        if(raw){ try{ state.seating[cls]=JSON.parse(raw); }catch{ state.seating[cls]={rows:6,cols:6,map:{}}; } }
        if(!state.seating[cls]) state.seating[cls]={rows:6, cols:6, map:{}};
      }
      state.seating[cls].rows = clampSize(state.seating[cls].rows ?? 6);
      state.seating[cls].cols = clampSize(state.seating[cls].cols ?? 6);
      return state.seating[cls];
    }
    function saveSeatState(cls, st){ state.seating[cls]=st; try{ localStorage.setItem('seat_v1__'+cls, JSON.stringify(st));saveSession('seat change'); }catch{} }
    function getCurrentRowsCols(cls){ const st=ensureSeatState(cls); return {rows: st.rows||6, cols: st.cols||6}; }
    function findSeatPos(cls, id){ const st=state.seating[cls]; if(!st||!st.map) return null; for(const key in st.map){ if(st.map[key]===id){ const [r,c]=key.split('-').map(Number); return {r,c}; } } return null; }

    /* ====== åˆ—è¡¨æ¸²æŸ“ï¼šé¡åƒåº§ä½è¡¨ï¼ˆåº§ä½æ¨¡å¼ï¼‰ ====== */
    function renderStudents(cls){
      const elStudents = document.getElementById('students');

      // âœ… æ²’é¸ç­ç´š/å‰›æ¸…é™¤æš«å­˜ï¼šä¹Ÿç•«å‡ºä¸€ç›¤ç©ºæ ¼ï¼ˆä¸¦æŠŠå¡ç‰‡é¡¯ç¤ºå‡ºä¾†ï¼‰
      if(!cls){
        const defaultRows = clampSize((elRows && elRows.value) || 6);
        const defaultCols = clampSize((elCols && elCols.value) || 6);

        elStudents.style.setProperty('--list-cols', defaultCols);

        const frag = document.createDocumentFragment();
        for(let r=1; r<=defaultRows; r++){
          for(let c=1; c<=defaultCols; c++){
            frag.appendChild(
              buildPlaceholderCard(seatIndexLabel(r, c, defaultRows, defaultCols))
            );
          }
        }
        // è¬›å°
        // è¬›å°ï¼ˆåƒ…ç•¶éœ€è¦é¡¯ç¤ºæ™‚ï¼‰
        if(state.showStageInList){
          const stage = document.createElement('div');
          stage.className = 'stage';
          stage.setAttribute('role','presentation');
          stage.textContent = 'è¬›å°';
          frag.appendChild(stage);
        }


        elStudents.innerHTML = '';
        elStudents.appendChild(frag);

        // ğŸ”§ é—œéµï¼šè®“å¡ç‰‡é¡¯ç¤ºï¼ˆåŸæœ¬æ²’ç¶ observer æœƒä¿æŒ opacity:0ï¼‰
        elStudents.querySelectorAll('.card').forEach(c=>{
          io.observe(c);         // å’ŒåŸæœ¬ä¸€è‡´
          c.classList.add('show'); // ç«‹åˆ»é¡¯ç¤ºï¼Œé¿å… observer æ²’å³æ™‚è§¸ç™¼
        });
        requestAnimationFrame(()=> setupAutoFitForNames(elStudents));
        return;
      }

      // âœ… åŸæœ¬å·²æœ‰ç­ç´šæ™‚çš„æ—¢æœ‰é‚è¼¯
      const st = ensureSeatState(cls);
      const list = state.classMap[cls] || [];
      const {rows, cols} = getCurrentRowsCols(cls);
      elStudents.style.setProperty('--list-cols', cols);

      const byId = new Map(list.map(s=>[s.id, s]));
      const frag = document.createDocumentFragment();
      const q = state.filter.trim().toLowerCase();

      for(let r=1; r<=rows; r++){
        for(let c=1; c<=cols; c++){
          const key = r+'-'+c;
          const id = st.map?.[key] || null;
          const stu = id ? byId.get(id) || null : null;
          if(stu){
            const isHit = q && matchFilter(stu, q);
            if(q && !isHit){
              frag.appendChild(buildPlaceholderCard(seatIndexLabel(r,c,rows,cols)));
            }else{
              frag.appendChild(buildStudentCard(cls, stu, isHit ? q : ''));
            }
          }else{
            frag.appendChild(buildPlaceholderCard(seatIndexLabel(r,c,rows,cols)));
          }
        }
      }

      if(state.showStageInList){
        const stage = document.createElement('div');
        stage.className = 'stage';
        stage.setAttribute('role', 'presentation');
        stage.textContent = 'è¬›å°';
        frag.appendChild(stage);
      }


      elStudents.innerHTML = '';
      elStudents.appendChild(frag);
      elStudents.querySelectorAll('.card').forEach(c=> io.observe(c));
      requestAnimationFrame(()=> setupAutoFitForNames(elStudents));

      if(q){
        const first = elStudents.querySelector('.card.match');
        if(first){ first.scrollIntoView({ behavior:'smooth', block:'center', inline:'center' }); }
      }
    }


    function seatIndexLabel(r, c, rows, cols){ return (cols - c + 1) * rows - (r - 1); }

    function buildStudentCard(cls, s, qForHighlight=''){
      const isHighlight = !!qForHighlight;
      const card=document.createElement('div');
      card.className='card' + (isHighlight ? ' match' : '');

      const seatText = s.seat
        ? `<span class="seat-badge">${highlightSeat(s.seat, qForHighlight)}</span>`
        : '';

      const nameHTML = isHighlight ? highlightHTML(s.name, qForHighlight) : escapeHTML(s.name);
      const score = getScore(cls, s.id);   // â˜…


      card.innerHTML=`
        <div class="score-chip" id="score-${s.id}">${score}</div>
        <div class="name">${seatText}<span class="student-name">${nameHTML}</span></div>
        <div class="actions">
          <button class="btn add">+1åˆ†</button>
          <button class="btn sub">-1åˆ†</button>
        </div>
        <div class="float-mark" id="float-${s.id}"></div>
      `;
      const btnAdd=card.querySelector('.add');
      const btnSub=card.querySelector('.sub');
      const scoreEl=card.querySelector(`#score-${s.id}`);
      const floater=card.querySelector(`#float-${s.id}`);
      bindRipple(btnAdd); bindRipple(btnSub);
      btnAdd.addEventListener('click',()=>{ changeScore(cls, s.id, +1, scoreEl, floater); });
      btnSub.addEventListener('click',()=>{ changeScore(cls, s.id, -1, scoreEl, floater); });
      return card;
    }
    function buildPlaceholderCard(seatIdx){
      const card=document.createElement('div'); card.className='card placeholder'; card.setAttribute('aria-label', `ç©ºä½ #${seatIdx}`);
      card.innerHTML=`<div class="seat-ind">åº§ä½ #${seatIdx}</div><div class="empty-text">ç©ºä½</div>`;
      return card;
    }
    function changeScore(cls, id, delta, scoreEl, floater){
      const old  = getScore(cls, id);        // â˜…
      const next = old + delta;
      setScore(cls, id, next);               // â˜…

      animateNumber(scoreEl, old, next, 260);
      scoreEl.classList.add('bump'); setTimeout(()=>scoreEl.classList.remove('bump'), 360);
      showFloater(floater, delta);
      renderLeaderboard(cls);
    }

    function showFloater(el, delta){ el.textContent = delta>0? `+${delta}` : `${delta}`; el.style.color = delta>0? 'rgb(74,222,128)' : 'rgb(248,113,113)'; el.classList.remove('show'); void el.offsetWidth; el.classList.add('show'); }

    function renderLeaderboard(cls){
      elBoardClass.textContent=cls||'æœªé¸æ“‡';
      const list = (state.classMap[cls]||[]).map(s => ({
        id: s.id,
        name: s.name,
        seat: s.seat,
        score: getScore(cls, s.id)   // â˜…
      }));

      if(list.length===0){ elBoard.innerHTML='<div class="empty">æ­¤ç­ç´šå°šç„¡æˆå“¡</div>'; return; }
      list.sort((a,b)=>{ if(b.score!==a.score) return b.score-a.score; const na=Number(a.seat), nb=Number(b.seat); if(!Number.isNaN(na)&&!Number.isNaN(nb)&&na!==nb) return na-nb; return a.name.localeCompare(b.name,'zh-Hant'); });
      const rows = list.map((s,idx)=>{
        const rank = idx+1; const clsRank = rank<=5 ? `rank-${rank}` : ''; const medalText = rank<=5 ? rank : '';
        const seatDisp = padSeat(s.seat);
        return `
          <div class="row ${clsRank}">
            <div class="rank">${rank<=5 ? `<span class="medal">${medalText}</span>` : rank}</div>
            <div class="who">${s.seat?`<span class="seat-badge">#${escapeHTML(seatDisp)}</span> `:''}${escapeHTML(s.name)}</div>
            <div class="score">${s.score}</div>
          </div>`;
      }).join('');
      elBoard.innerHTML = rows;
    }

    /* ====== â˜… ä¸»é¡Œåˆ‡æ›ï¼ˆæ·±/æ·ºï¼‰ ====== */
    function initThemeToggle(){
      const KEY = 'theme_v1';
      const btn = document.getElementById('btn-theme');

      // è®€å–ä½¿ç”¨è€…æ›¾é¸æ“‡çš„ä¸»é¡Œï¼Œæˆ–ä»¥ç³»çµ±åå¥½ä½œç‚ºé è¨­
      function getInitialTheme(){
        const saved = localStorage.getItem(KEY);
        if(saved === 'light' || saved === 'dark') return saved;
        return window.matchMedia && window.matchMedia('(prefers-color-scheme: light)').matches ? 'light' : 'dark';
      }

    /* ===== â˜… å´æ¬„æ”¶åˆåˆ‡æ›ï¼ˆè¨˜æ†¶ç‹€æ…‹ï¼‰ ===== */
    (function initSidebarToggle(){
      const KEY = 'sidebar_collapsed_v1';
      const layout = document.querySelector('.layout');
      const btn = document.getElementById('btn-sidebar');

      function apply(collapsed){
        layout.classList.toggle('is-collapsed', collapsed);
        // å±•é–‹æ™‚é¡¯ç¤º â€¹ï¼›æ”¶åˆæ™‚é¡¯ç¤º â€º
        btn.textContent = collapsed ? 'â€º' : 'â€¹';
        btn.setAttribute('aria-expanded', String(!collapsed));
        btn.setAttribute('title', collapsed ? 'å±•é–‹å´æ¬„' : 'æ”¶åˆå´æ¬„');
        try{ localStorage.setItem(KEY, collapsed ? '1' : '0'); }catch{}
      }

      // é»æŒ‰åˆ‡æ›
      btn?.addEventListener('click', ()=>{
        const collapsed = layout.classList.contains('is-collapsed');
        apply(!collapsed);
      });

      // é–‹é é‚„åŸä¸Šæ¬¡ç‹€æ…‹
      const collapsed = localStorage.getItem(KEY) === '1';
      apply(collapsed);
    })();


    // å¥—ç”¨ä¸»é¡Œï¼ˆç”¨ <html data-theme="light"> ä½œç‚ºåˆ‡æ›ï¼‰
    function applyTheme(theme){
      if(theme === 'light'){
        document.documentElement.setAttribute('data-theme','light');
        if(btn){
          btn.innerHTML = 'ğŸŒ™ æ·±è‰²';
          btn.title = 'åˆ‡æ›ç‚ºæ·±è‰²ä¸»é¡Œ';
          btn.setAttribute('aria-pressed','true');
        }
      }else{
        document.documentElement.removeAttribute('data-theme'); // å›åˆ°é è¨­æ·±è‰²
        if(btn){
          btn.innerHTML = 'â˜€ï¸ æ·ºè‰²';
          btn.title = 'åˆ‡æ›ç‚ºæ·ºè‰²ä¸»é¡Œ';
          btn.setAttribute('aria-pressed','false');
        }
      }
      // å¯é¸ï¼šè®“æŒ‰éˆ•ä¹Ÿæœ‰ ripple
      if(typeof bindRipple === 'function' && btn) bindRipple(btn);
    }

    let theme = getInitialTheme();
    applyTheme(theme);

    // é»æ“Šåˆ‡æ› + æ°¸ä¹…åŒ–
    btn?.addEventListener('click', ()=>{
      theme = (document.documentElement.getAttribute('data-theme') === 'light') ? 'dark' : 'light';
      applyTheme(theme);
      try{ localStorage.setItem(KEY, theme); }catch{}
    });

    // è‹¥ä½¿ç”¨è€…æœªæ‰‹å‹•é¸æ“‡ï¼Œè·Ÿéš¨ç³»çµ±åå¥½è®ŠåŒ–
    try{
      const mq = window.matchMedia('(prefers-color-scheme: light)');
      mq.addEventListener?.('change', (e)=>{
        const saved = localStorage.getItem(KEY);
        if(saved) return; // æœ‰æ‰‹å‹•é¸æ“‡å°±ä¸è‡ªå‹•åˆ‡
        applyTheme(e.matches ? 'light' : 'dark');
      });
    }catch{}
    }
    initThemeToggle();

    /* ====== å®‰æ’åº§ä½æ¨¡å¼ ====== */
    function renderSeatUI(cls){
      // ğŸ‘‰ è‹¥å°šæœªé¸ç­ç´šï¼Œç›´æ¥æ¸…ç©ºåº§ä½å€èˆ‡æœªå®‰æ’åå–®ï¼Œä¸¦è¨­ç½®é è¨­æ¬„æ•¸
      if(!cls){
        const defaultRows = clampSize(elRows.value || 6);
        const defaultCols = clampSize(elCols.value || 6);

        // åŒæ­¥æ§åˆ¶åˆ—æ•¸å­—èˆ‡ CSS è®Šæ•¸
        elRows.value = defaultRows;
        elCols.value = defaultCols;
        elSeatboard.style.setProperty('--cols', defaultCols);
        elSeatboard.style.setProperty('--rows', defaultRows);
        if (defaultRows >= 8 || defaultCols >= 8) elSeatboard.setAttribute('data-dense','1');
        else elSeatboard.removeAttribute('data-dense');

        // å»ºä¸€ç›¤ç©ºæ ¼ï¼ˆåªé¡¯ç¤ºåº§ä½ç·¨è™Ÿï¼Œä¸æ”¾å­¸ç”Ÿç£ç£šï¼‰
        const frag = document.createDocumentFragment();
        for(let r=1; r<=defaultRows; r++){
          for(let c=1; c<=defaultCols; c++){
            const idx = seatIndexLabel(r, c, defaultRows, defaultCols);
            const cell = document.createElement('div');
            cell.className = 'seat-cell';
            const badge = document.createElement('div');
            badge.className = 'seat-no';
            badge.textContent = idx;
            cell.appendChild(badge);
            frag.appendChild(cell);
          }
        }
        // è¬›å°
        const stage = document.createElement('div');
        stage.className = 'stage';
        stage.setAttribute('role','presentation');
        stage.textContent = 'è¬›å°';
        stage.style.gridColumn = `1 / span ${defaultCols}`;
        frag.appendChild(stage);

        elSeatboard.innerHTML = '';
        elSeatboard.appendChild(frag);

        // å³å´æœªå®‰æ’åå–®æ¸…ç©ºå³å¯ï¼ˆæ²’æœ‰å­¸ç”Ÿï¼‰
        elUnassignedList.innerHTML = '';
        elSeatHint.textContent = 'è«‹å…ˆä¸Šå‚³å­¸ç”Ÿåå–®';
        return;
      }


      if(!cls) return;
      const st=ensureSeatState(cls);
      const list=state.classMap[cls]||[];
      const q = state.filter.trim().toLowerCase();
      const {rows, cols} = getCurrentRowsCols(cls);

      elRows.value = rows; elCols.value = cols;
      elSeatHint.textContent = ENABLE_TAP_PICK
        ? 'é»ä¸€ä¸‹å­¸ç”Ÿ â†’ é»åº§ä½æ”¾ç½®ï¼›å³å´ç©ºç™½å€å¯æ”¾å›æœªå®‰æ’ã€‚'
        : 'æ‹–æ›³å­¸ç”Ÿåˆ°åº§ä½ï¼›å³éµåº§ä½å¯æ¸…ç©ºï¼›ä¹Ÿå¯æ‹–å›å³å´ã€Œæœªå®‰æ’åå–®ã€ã€‚';

      elSeatboard.style.setProperty('--cols', cols);
      elSeatboard.style.setProperty('--rows', rows);                // æŠŠåˆ—æ•¸ä¹Ÿå‚³é€² CSS
      if (rows>=8 || cols>=8) elSeatboard.setAttribute('data-dense','1');
      else elSeatboard.removeAttribute('data-dense');
      for(const k of Object.keys(st.map)){ const [r,c]=k.split('-').map(Number); if(r>rows || c>cols) delete st.map[k]; }

      const frag=document.createDocumentFragment();
      for(let r=1;r<=rows;r++){
        for(let c=1;c<=cols;c++){
          const idx=seatIndexLabel(r,c,rows,cols);
          const cell=document.createElement('div');
          cell.className='seat-cell';
          cell.dataset.r=r; cell.dataset.c=c;
          const key=r+'-'+c; const id=st.map[key];

          const badge=document.createElement('div'); badge.className='seat-no'; badge.textContent=idx; cell.appendChild(badge);

          cell.addEventListener('dragover', e=>{ e.preventDefault(); cell.classList.add('dragover'); });
          cell.addEventListener('dragleave', ()=> cell.classList.remove('dragover'));
          cell.addEventListener('drop', e=>{ e.preventDefault(); cell.classList.remove('dragover'); const id=e.dataTransfer.getData('text/plain'); placeStudent(cls, r, c, id); });
          cell.addEventListener('contextmenu', e=>{ e.preventDefault(); if(st.map[key]){ delete st.map[key]; saveSeatState(cls, st); renderSeatUI(cls); renderStudents(cls); renderLeaderboard(cls); } });
          const onTapPlace = (e) => {
            if (!ENABLE_TAP_PICK || state.mode !== 'seat') return;
            e.preventDefault();
            e.stopPropagation();
            // å¾Œé¢é‚è¼¯åŒåŸæœ¬ï¼šæœ‰ pickedId å°±æ”¾ç½®ï¼›å¦å‰‡é»åˆ°æœ‰äººå°±é¸å–
            const key = r + '-' + c;
            const currentId = st.map[key];
            if (pickedId) {
              placeStudent(cls, r, c, pickedId);
            } else if (currentId) {
              pickTileById(currentId);
            }
          };


          // æ•ç²éšæ®µç¶å®šï¼Œè¡Œå‹•è£ç½®ä¸Šæ›´ç©©å®š
          cell.addEventListener('pointerup', onTapPlace, { capture: true });
          cell.addEventListener('click',      onTapPlace, { capture: true });

          if(id){ 
            const stu=list.find(x=>x.id===id); 
            if(stu){ 
              cell.classList.add('filled'); 
              const tile = createTile(cls, stu, q);
              cell.appendChild(tile);
              if (tile.dataset.hit === '1') cell.classList.add('hit');
            } 
          }
          frag.appendChild(cell);
        }
      }

      const stage=document.createElement('div'); stage.className='stage'; stage.setAttribute('role','presentation'); stage.innerHTML=`è¬›å°`; stage.style.gridColumn=`1 / span ${cols}`; frag.appendChild(stage);
      elSeatboard.innerHTML=''; elSeatboard.appendChild(frag);

      // æœªå®‰æ’åå–®
      elUnassignedList.innerHTML='';
      const assignedIds=new Set(Object.values(st.map||{}));
      const unassigned=list.filter(s=> !assignedIds.has(s.id));
      unassigned.forEach(s=>{ elUnassignedList.appendChild(createTile(cls, s, q)); });

      const onUnDragOver=(e)=>{ e.preventDefault(); elUnassigned.classList.add('dragover'); };
      const onUnDragLeave=()=> elUnassigned.classList.remove('dragover');
      const onUnDrop=(e)=>{ e.preventDefault(); elUnassigned.classList.remove('dragover'); const id=e.dataTransfer.getData('text/plain'); if(!id) return; for(const k in st.map){ if(st.map[k]===id) delete st.map[k]; } saveSeatState(cls, st); renderSeatUI(cls); renderStudents(cls); renderLeaderboard(cls); };
      elUnassigned.addEventListener('dragover', onUnDragOver);
      elUnassigned.addEventListener('dragleave', onUnDragLeave);
      elUnassigned.addEventListener('drop', onUnDrop);
      // è§¸æ§ï¼šé»æœªå®‰æ’åå–®çš„ç©ºç™½è™• â†’ æŠŠé¸å–çš„å­¸ç”Ÿæ”¾å›æœªå®‰æ’
      // âœ… è§¸æ§ï¼šé»æœªå®‰æ’åå–®çš„ç©ºç™½è™• â†’ æŠŠé¸å–çš„å­¸ç”Ÿæ”¾å›æœªå®‰æ’ï¼ˆpointerup ç‰ˆæœ¬ï¼‰
      const onUnassignedTap = (e)=>{
          if(!ENABLE_TAP_PICK || !pickedId) return;
          if (e.target.closest('.tile')) return;
        const st2 = ensureSeatState(cls);
        for (const k in st2.map){ if (st2.map[k] === pickedId) delete st2.map[k]; }
        saveSeatState(cls, st2);
        clearPicked();
        renderSeatUI(cls); renderStudents(cls); renderLeaderboard(cls);
      };
      elUnassigned.addEventListener('pointerup', onUnassignedTap);

      renderStudents(cls);

      // â¤µ æœå°‹æ™‚è‡ªå‹•æ²åˆ°ç¬¬ä¸€ç­†å‘½ä¸­çš„ç£ç£šï¼ˆå„ªå…ˆåº§ä½å€ï¼Œå¦å‰‡æœªå®‰æ’åå–®ï¼‰
      if(q){
        const first = elSeatboard.querySelector('.tile.match') || elUnassignedList.querySelector('.tile.match');
        if(first){ first.scrollIntoView({ behavior:'smooth', block:'center', inline:'center' }); }
      }
    }
    function createTile(cls, s, qForHighlight=''){
      const isHit = qForHighlight && matchFilter(s, qForHighlight);
      const tile=document.createElement('div'); 
      tile.className='tile' + (isHit ? ' match' : '');
      tile.draggable=true; tile.dataset.id=s.id;
      tile.dataset.hit = isHit ? '1' : '0';
      const seatNow=s.seat; 
      tile.innerHTML=`${seatNow?`<span class="seat-badge">${highlightSeat(seatNow, qForHighlight)}</span>`:''}<span class="student-name">${isHit?highlightHTML(s.name, qForHighlight):escapeHTML(s.name)}</span>`;
      tile.addEventListener('dragstart', e=>{ e.dataTransfer.setData('text/plain', s.id); }); 
      // è§¸æ§ï¼šé»ä¸€ä¸‹é¸å–ï¼Œå†é»åº§ä½æ”¾ç½®
      tile.addEventListener('click', (e)=>{
        if(!ENABLE_TAP_PICK || state.mode !== 'seat') return; // â† é€™è¡Œå–ä»£åŸæœ¬çš„ IS_COARSE
        e.preventDefault();
        if (pickedId === s.id) clearPicked();
        else pickTileById(s.id);
      });

      //ï¼ˆå¯é¸ï¼‰é¿å…æ»‘å‹•èª¤è§¸ï¼šæŒ‡æ¨™æ•æ‰
      tile.addEventListener('pointerdown', (e)=>{ try{ tile.setPointerCapture(e.pointerId); }catch{} });
      return tile;
    }

    function placeStudent(cls, r, c, id){
      if(!id) return;
      const st = ensureSeatState(cls);
      const dstKey = r + '-' + c;
      const dstOld = st.map[dstKey];          // ç›®æ¨™åº§ä½åŸæœ¬çš„äºº
      const srcPos = findSeatPos(cls, id);    // é€™ä½å­¸ç”Ÿç›®å‰æ˜¯å¦åœ¨åº§ä½ä¸Š

      if (dstOld && srcPos){                  // å…©é‚Šéƒ½æœ‰äºº â†’ äº¤æ›
        st.map[dstKey] = id;
        st.map[srcPos.r + '-' + srcPos.c] = dstOld;
      } else {
        // ä¸€èˆ¬æ”¾ç½®ï¼šå…ˆæŠŠæ­¤äººå¾èˆŠä½ç§»é™¤ï¼Œå†æ”¾åˆ°æ–°ä½ï¼ˆè‹¥æ–°ä½åŸæœ¬æœ‰äººæœƒè¢«è¦†è“‹â†’åˆ°æœªå®‰æ’åå–®ï¼‰
        for (const k in st.map){ if (st.map[k] === id) delete st.map[k]; }
        st.map[dstKey] = id;
      }

      saveSeatState(cls, st);
      clearPicked();                 // è‹¥æ˜¯é»é¸æµç¨‹ï¼Œæ”¾ä¸‹å¾Œæ¸…é™¤é¸å–
      renderSeatUI(cls); renderStudents(cls); renderLeaderboard(cls);
    }

    function autoArrange(cls){
      const st=ensureSeatState(cls); const list=(state.classMap[cls]||[]).slice();
      const {rows, cols} = getCurrentRowsCols(cls); const coords=[];
      for(let r=1;r<=rows;r++){ for(let c=1;c<=cols;c++){ coords.push({r,c,idx:seatIndexLabel(r,c,rows,cols)}); } }
      coords.sort((a,b)=>a.idx-b.idx); st.map={};
      for(let i=0;i<coords.length && i<list.length;i++){ const {r,c}=coords[i]; st.map[r+'-'+c]=list[i].id; }
      saveSeatState(cls, st); renderSeatUI(cls); renderStudents(cls); renderLeaderboard(cls);
    }

    function applyStageToggleUI(){
      if(!elChkShowStage) return;
      elChkShowStage.checked = !!state.showStageInList;
    }

    elChkShowStage?.addEventListener('change', ()=>{
      state.showStageInList = !!elChkShowStage.checked;
      applyStageToggleUI();
      if(state.mode === 'list') renderStudents(elSelect.value); // åªå½±éŸ¿ã€Œåº§ä½ã€æ¨¡å¼
      saveSession('toggle stage (checkbox)');
    });


    
    /* ====== ğŸ“š æ•™å­¸é€²åº¦ï¼ˆè·¨ç­å‹¾é¸ï¼‰ ====== */
    function ensureProgressState(){
      if(!state.progress || typeof state.progress!=='object') state.progress = { pages:{}, order:[], active:'' };
      if(!state.progress.pages || typeof state.progress.pages!=='object') state.progress.pages = {};
      if(!Array.isArray(state.progress.order)) state.progress.order = [];
      if(typeof state.progress.active!=='string') state.progress.active = '';

      // ç¢ºä¿è‡³å°‘æœ‰ä¸€å€‹åˆ†é 
      if(!state.progress.order.length){
        const def = 'é€²åº¦1';
        state.progress.order = [def];
        state.progress.active = def;
        state.progress.pages[def] = { items: [], classes: (state.classOrder||[]).slice() };
      }

      // ä¿®æ­£ active
      if(!state.progress.active || !state.progress.pages[state.progress.active]){
        state.progress.active = state.progress.order.find(n=>state.progress.pages[n]) || state.progress.order[0];
      }

      // æ­£è¦åŒ–æ¯å€‹åˆ†é è³‡æ–™
      state.progress.order = state.progress.order.map(v=>String(v||'').trim()).filter(Boolean);
      state.progress.order = Array.from(new Set(state.progress.order));
      for(const name of state.progress.order){
        if(!state.progress.pages[name] || typeof state.progress.pages[name]!=='object'){
          state.progress.pages[name] = { items: [], classes: (state.classOrder||[]).slice() };
        }
        const pg = state.progress.pages[name];
        if(!Array.isArray(pg.items)) pg.items = [];
        if(!Array.isArray(pg.classes)) pg.classes = (state.classOrder||[]).slice();

        // æ­£è¦åŒ–ç­ç´šæ¬„ä½ï¼ˆå»ç©ºç™½ã€å»é‡ï¼‰
        pg.classes = pg.classes.map(v=>String(v||'').trim()).filter(Boolean);
        pg.classes = Array.from(new Set(pg.classes));

        // ä¿®æ­£æ¯ä¸€åˆ—çš„æ ¼å¼
        pg.items = pg.items.map(it=>{
          if(!it || typeof it!=='object') return { title:'', checked:{} };
          if(typeof it.title!=='string') it.title = String(it.title ?? '');
          if(!it.checked || typeof it.checked!=='object') it.checked = {};
          return it;
        });
      }
      return state.progress;
    }

    function isCheckedCell(v){
      if(v===true) return true;
      if(v===1) return true;
      const s = String(v ?? '').trim().toLowerCase();
      return ['1','true','y','yes','æ˜¯','âœ“','v','ok','å®Œæˆ','å·²å®Œæˆ'].includes(s);
    }

    function parseProgressSheet(ws, sheetName){
      if(!ws) return false;
      const rows = XLSX.utils.sheet_to_json(ws,{header:1,raw:false});
      if(!rows || rows.length===0) return false;
      const header = (rows[0]||[]).map(v=>String(v||'').trim());
      if(!header.length) return false;
      if(String(header[0]||'').replace(/\s+/g,'') !== 'æ•™å­¸é€²åº¦') return false;

      const classes = header.slice(1).map(v=>String(v||'').trim()).filter(Boolean);
      const items = [];
      for(let r=1;r<rows.length;r++){
        const row = rows[r] || [];
        const title = String(row[0]||'').trim();
        const tail = row.slice(1).map(v=>String(v||'').trim());
        const hasAny = title || tail.some(v=>v);
        if(!hasAny) continue;

        const checked = {};
        classes.forEach((cls, i)=>{ checked[cls] = isCheckedCell(row[i+1]); });
        items.push({ title, checked });
      }

      const prog = ensureProgressState();
      const name = String(sheetName||'').trim() || `é€²åº¦${(prog.order?.length||0)+1}`;
      if(!prog.pages[name]){
        prog.order.push(name);
      }
      prog.pages[name] = { items, classes: classes.length ? classes : (state.classOrder||[]).slice() };
      if(!prog.active) prog.active = name;
      saveSession('import progress sheet');
      return true;
    }

    function buildProgressAOA(pageName){
      const prog = ensureProgressState();
      const name = pageName || prog.active;
      const pg = prog.pages[name] || { items: [], classes: (state.classOrder||[]).slice() };

      if(!pg.classes || !pg.classes.length){ pg.classes = (state.classOrder || []).slice(); }
      const classes = pg.classes;
      const header = ['æ•™å­¸é€²åº¦', ...classes];
      const aoa = [header];

      // è‹¥æ²’æœ‰ä»»ä½•é€²åº¦ï¼Œä»è¼¸å‡ºä¸€åˆ—ç©ºç™½ï¼Œé¿å…ç©ºè¡¨å–®ä¸å¥½ç·¨è¼¯
      if(!pg.items.length){
        aoa.push(['']);
        return aoa;
      }

      for(const it of pg.items){
        const title = String(it.title||'').trim();
        const checked = it.checked || {};
        const row = [title];
        for(const cls of classes){
          row.push(checked[cls] ? 1 : 0);
        }
        aoa.push(row);
      }
      return aoa;
    }

    function appendProgressSheet(wb){
      try{
        const prog = ensureProgressState();
        for(const pageName of (prog.order||[])){
          const aoa = buildProgressAOA(pageName);
          const ws = XLSX.utils.aoa_to_sheet(aoa);
          const pg = prog.pages[pageName] || {};
          const classes = (pg.classes && pg.classes.length) ? pg.classes : (state.classOrder||[]);
          ws['!cols'] = [{wch:28}, ...classes.map(()=>({wch:10}))];

          // ä»¥ã€Œåˆ†é åç¨±ã€ç•¶å·¥ä½œè¡¨åç¨±ï¼›è‹¥è¡çªå‰‡è‡ªå‹•åŠ å°¾ç¢¼é¿å…è¦†è“‹
          let name = safeSheetName(pageName || 'æ•™å­¸é€²åº¦');
          if(!name) name = 'æ•™å­¸é€²åº¦';
          if(wb.SheetNames.includes(name)){
            let i=2;
            while(wb.SheetNames.includes(`${name}_${i}`)) i++;
            name = `${name}_${i}`;
          }
          XLSX.utils.book_append_sheet(wb, ws, name);
        }
      }catch(e){
        console.warn('å»ºç«‹æ•™å­¸é€²åº¦è¡¨å–®å¤±æ•—', e);
      }
    }

    function renderProgress(){
      const prog = ensureProgressState();
      const pageName = prog.active;
      const pg = prog.pages[pageName] || (prog.pages[pageName] = { items:[], classes:(state.classOrder||[]).slice() });
      if(!elProgTable) return;

      // åˆ†é ä¸‹æ‹‰é¸å–®
      if(elProgPageSel){
        elProgPageSel.innerHTML = (prog.order||[]).map(n=>`<option value="${escapeHTML(n)}">${escapeHTML(n)}</option>`).join('');
        elProgPageSel.value = pageName;
      }

      // é€²åº¦æ¨¡å¼ä¹Ÿæä¾›ã€Œæ–°å¢/åˆªé™¤å­¸ç”Ÿã€å¿«æ·

      if(!pg.classes || !pg.classes.length){ pg.classes = (state.classOrder || []).slice(); }
      const classes = pg.classes;
      if(elProgPill){
        elProgPill.textContent = classes.length ? `åˆ†é ï¼š${pageName}ï½œå…± ${classes.length} ç­` : `åˆ†é ï¼š${pageName}ï½œè«‹å…ˆåŒ¯å…¥ç­ç´šåå–®`;
      }

      // è¡¨é ­
      elProgTable.innerHTML = '';
      const thead = document.createElement('thead');
      const trh = document.createElement('tr');
      const th0 = document.createElement('th');
      th0.textContent = 'æ•™å­¸é€²åº¦';
      trh.appendChild(th0);
      // å¯æ‹–ç§»æ’åºï¼ˆç­ç´šæ¬„ä½ï¼‰
let __dragClsIndex = null;
classes.forEach((cls, idx)=>{
  const th = document.createElement('th');
  th.textContent = cls;
  th.classList.add('prog-th-class');
  th.draggable = true;
  th.dataset.cls = cls;
  th.dataset.idx = String(idx);

  th.addEventListener('dragstart', (e)=>{
    __dragClsIndex = Number(th.dataset.idx);
    th.classList.add('dragging');
    try{ e.dataTransfer.setData('text/plain', th.dataset.idx); }catch(_){}
    try{ e.dataTransfer.effectAllowed = 'move'; }catch(_){}
  });
  th.addEventListener('dragend', ()=>{
    __dragClsIndex = null;
    th.classList.remove('dragging');
    // æ¸…é™¤æ‰€æœ‰æç¤ºæ¨£å¼
    elProgTable.querySelectorAll('th.prog-th-class').forEach(x=>x.classList.remove('drag-over'));
  });
  th.addEventListener('dragover', (e)=>{
    e.preventDefault();
    th.classList.add('drag-over');
    try{ e.dataTransfer.dropEffect = 'move'; }catch(_){}
  });
  th.addEventListener('dragleave', ()=> th.classList.remove('drag-over'));
  th.addEventListener('drop', (e)=>{
    e.preventDefault();
    th.classList.remove('drag-over');
    const from = (__dragClsIndex!==null && !Number.isNaN(__dragClsIndex))
      ? __dragClsIndex
      : Number((()=>{ try{return e.dataTransfer.getData('text/plain');}catch(_){return '';} })());
    const to = Number(th.dataset.idx);
    if(Number.isNaN(from) || Number.isNaN(to) || from===to) return;

    // ä»¥ pg.classes ç‚ºä¸»ç¶­æŒé †åº
    const prog = ensureProgressState();
      const p = prog.pages[prog.active];
    if(!p.classes || !p.classes.length){ p.classes = (state.classOrder || []).slice(); }
    const arr = p.classes.slice();
    const item = arr.splice(from, 1)[0];
    arr.splice(to, 0, item);
    p.classes = arr;
    saveSession('progress reorder classes');
    renderProgress();
  });

  trh.appendChild(th);
});
      thead.appendChild(trh);

      const tbody = document.createElement('tbody');

      // å¦‚æœå®Œå…¨æ²’æœ‰åˆ—ï¼Œå…ˆè£œä¸€åˆ—ç©ºç™½æ–¹ä¾¿è¼¸å…¥
      if(!pg.items.length){
        pg.items.push({ title:'', checked:{} });
      }

      pg.items.forEach((it, idx)=>{
        const tr = document.createElement('tr');

        // ç¬¬ä¸€æ¬„ï¼šé€²åº¦åç¨±
        const td0 = document.createElement('td');

        // å·¦å´ï¼šåˆªé™¤æœ¬åˆ—ï¼ˆç¢°åˆ°è¼¸å…¥åŒ¡æ™‚æ‰é¡¯ç¤ºï¼‰
        const wrap = document.createElement('div');
        wrap.className = 'prog-inputwrap';

        const del = document.createElement('span');
        del.className = 'prog-row-del';
        del.title = 'åˆªé™¤é€™ä¸€åˆ—';
        del.setAttribute('role','button');
        del.setAttribute('aria-label','åˆªé™¤é€™ä¸€åˆ—æ•™å­¸é€²åº¦');
        del.textContent = 'Ã—';
        del.addEventListener('click', (e)=>{
          e.preventDefault();
          e.stopPropagation();

          const progNow = ensureProgressState();
          const pNow = progNow.pages[progNow.active] || (progNow.pages[progNow.active] = { items:[], classes:(state.classOrder||[]).slice() });
          if(!Array.isArray(pNow.items)) pNow.items = [];

          pNow.items.splice(idx, 1);
          if(pNow.items.length===0){ pNow.items.push({ title:'', checked:{} }); }

          saveSession('progress del row');
          renderProgress();
        });

        // å³å´ï¼šé€²åº¦åç¨±
        const inp = document.createElement('input');
        inp.type = 'text';
        inp.className = 'prog-input';
        inp.placeholder = 'è¼¸å…¥é€²åº¦...';
        inp.value = it.title || '';
        inp.addEventListener('input', ()=>{
          it.title = inp.value;
          saveSession('progress title');
        });

        wrap.appendChild(del);
        wrap.appendChild(inp);
        td0.appendChild(wrap);
        tr.appendChild(td0);

        // å„ç­ç´šï¼šå‹¾é¸
        classes.forEach(cls=>{
          const td = document.createElement('td');
          const cb = document.createElement('input');
          cb.type = 'checkbox';
          cb.className = 'prog-check';
          cb.checked = !!(it.checked && it.checked[cls]);
          cb.addEventListener('change', ()=>{
            if(!it.checked) it.checked = {};
            it.checked[cls] = !!cb.checked;
            saveSession('progress tick');
          });
          td.appendChild(cb);
          tr.appendChild(td);
        });

        tbody.appendChild(tr);
      });

      elProgTable.appendChild(thead);
      elProgTable.appendChild(tbody);
    }

    /* ====== â³ å€’æ•¸è¨ˆæ™‚ ====== */
    let timerInterval = null;

    function ensureTimerState(){
      if(!state.timer || typeof state.timer!=='object'){
        state.timer = { setSec: 300, remainingSec: 300, running:false, endAt: 0 };
      }
      // ä¿®æ­£æ•¸å€¼
      state.timer.setSec = Math.max(0, Number(state.timer.setSec) || 0);
      state.timer.remainingSec = Math.max(0, Number(state.timer.remainingSec) || 0);
      state.timer.endAt = Number(state.timer.endAt) || 0;
      state.timer.running = !!state.timer.running;
      state.timer.doneNotified = !!state.timer.doneNotified;
      return state.timer;
    }

    function fmtTime(totalSec){
      totalSec = Math.max(0, Math.floor(totalSec || 0));
      const hh = Math.floor(totalSec / 3600);
      const mm = Math.floor((totalSec % 3600) / 60);
      const ss = totalSec % 60;
      const pad = n => String(n).padStart(2,'0');
      if(hh>0) return `${pad(hh)}:${pad(mm)}:${pad(ss)}`;
      return `${pad(mm)}:${pad(ss)}`;
    }

    function syncTimerFromEndAt(){
      const t = ensureTimerState();
      if(t.running && t.endAt){
        const rem = Math.max(0, Math.ceil((t.endAt - Date.now()) / 1000));
        t.remainingSec = rem;
        if(rem<=0){
          t.running = false;
      t.doneNotified = false;
          t.endAt = 0;
          t.remainingSec = 0;
          onTimerDone();
        }
      }
    }

    function updateTimerDisplay(){
      const t = ensureTimerState();
      syncTimerFromEndAt();
      if(elTimerDisplay) elTimerDisplay.textContent = fmtTime(t.remainingSec);
      if(elTimerHint){
        if(t.running) elTimerHint.textContent = 'å€’æ•¸ä¸­â€¦';
        else if(t.remainingSec===0) elTimerHint.textContent = 'æ™‚é–“åˆ°ï¼';
        else elTimerHint.textContent = 'å·²æš«åœ';
      }
    }

    function stopTimerInterval(){
      if(timerInterval){
        clearInterval(timerInterval);
        timerInterval = null;
      }
    }

    function startTimerInterval(){
      if(timerInterval) return;
      timerInterval = setInterval(()=>{
        const t = ensureTimerState();
        if(!t.running){
          stopTimerInterval();
          updateTimerDisplay();
          return;
        }
        updateTimerDisplay();
      }, 250);
    }

    function setTimerSeconds(sec){
      const t = ensureTimerState();
      sec = Math.max(0, Math.floor(Number(sec) || 0));
      t.setSec = sec;
      t.remainingSec = sec;
      t.running = false;
      t.endAt = 0;
      stopTimerInterval();
      updateTimerInputs();
      updateTimerDisplay();
      saveSession('timer set');
    }

    function updateTimerInputs(){
      if(!elTimerMin || !elTimerSec) return;
      const t = ensureTimerState();
      const sec = Math.max(0, Math.floor(t.remainingSec));
      elTimerMin.value = Math.floor(sec/60);
      elTimerSec.value = sec%60;
    }

    function startTimer(){
      const t = ensureTimerState();
      if(t.running) return;
      if(t.remainingSec<=0) t.remainingSec = t.setSec || 0;
      if(t.remainingSec<=0) return;

      t.running = true;
      t.doneNotified = false;
      t.endAt = Date.now() + t.remainingSec*1000;
      startTimerInterval();
      updateTimerDisplay();
      saveSession('timer start');
    }

    function pauseTimer(){
      const t = ensureTimerState();
      if(!t.running) return;
      syncTimerFromEndAt();
      t.running = false;
      t.endAt = 0;
      stopTimerInterval();
      updateTimerDisplay();
      saveSession('timer pause');
    }

    function resetTimer(){
      const t = ensureTimerState();
      t.running = false;
      t.doneNotified = false;
      t.endAt = 0;
      t.remainingSec = t.setSec || 0;
      stopTimerInterval();
      updateTimerInputs();
      updateTimerDisplay();
      saveSession('timer reset');
    }

    

// ===== In-app Modal (é¿å…ç€è¦½å™¨ alertã€Œé€™å€‹ç¶²ç«™ã€è¦–çª—) =====
let __inAppMask = null;
function ensureInAppModal(){
  if(__inAppMask) return;
  const mask = document.createElement('div');
  mask.id = 'inapp-mask';
  mask.className = 'modal-mask';
  mask.setAttribute('role','dialog');
  mask.setAttribute('aria-modal','true');

  mask.innerHTML = `
    <div class="modal" role="document">
      <header>
        <h3 id="inapp-title">æç¤º</h3>
        <button id="inapp-close" class="close" aria-label="é—œé–‰">âœ•</button>
      </header>
      <div class="content">
        <div id="inapp-body" class="hint" style="font-size:15px; line-height:1.6;"></div>
        <div class="divider"></div>
        <div style="display:flex; gap:10px; justify-content:flex-end; align-items:center;">
          <button id="inapp-ok" class="btn primary">åœæ­¢æé†’</button>
        </div>
      </div>
    </div>
  `;
  document.body.appendChild(mask);

  const close = ()=>{ try{ stopAlarmSound?.(); }catch(_){} hideInAppModal(); };
  mask.addEventListener('click', (e)=>{ if(e.target===mask) close(); });
  mask.querySelector('#inapp-close').addEventListener('click', close);
  mask.querySelector('#inapp-ok').addEventListener('click', ()=>{
    try{ stopAlarmSound?.(); }catch(_){}
    close();
  });

  __inAppMask = mask;
}
function showInAppModal(title, body){
  ensureInAppModal();
  __inAppMask.querySelector('#inapp-title').textContent = title || 'æç¤º';
  __inAppMask.querySelector('#inapp-body').textContent = body || '';
  __inAppMask.classList.add('show');
}
function hideInAppModal(){
  if(!__inAppMask) return;
  __inAppMask.classList.remove('show');
}


// ===== é¬§é˜å¼æé†’éŸ³æ•ˆï¼ˆå¯åœæ­¢ã€æœƒé€£çºŒéŸ¿ï¼‰ =====
let __alarmCtx = null;
let __alarmTimer = null;
let __alarmStopAt = 0;

function stopAlarmSound(){
  try{
    if(__alarmTimer){ clearInterval(__alarmTimer); __alarmTimer = null; }
  }catch(_){}
  try{
    if(__alarmCtx){
      // æœ‰äº›ç€è¦½å™¨ close æœƒå¤±æ•—ï¼Œä¿å®ˆè™•ç†
      __alarmCtx.close?.();
    }
  }catch(_){}
  __alarmCtx = null;
  __alarmStopAt = 0;
}

function playAlarmSound(){
  stopAlarmSound();

  // 1) èªéŸ³ï¼šå…ˆèªªã€ŒçµæŸã€ï¼ˆå¦‚æœä½¿ç”¨è€…å…è¨±ï¼‰
  try{
    if('speechSynthesis' in window){
      const u = new SpeechSynthesisUtterance('çµæŸ');
      u.lang = 'zh-TW';
      u.rate = 1.0;
      window.speechSynthesis.cancel();
      window.speechSynthesis.speak(u);
    }
  }catch(_){}

  // 2) WebAudioï¼šåšå‡ºã€Œé¬§é˜ã€é‚£ç¨®é€£çºŒå—¶å—¶å—¶ï¼ˆç¯€å¥ + é »ç‡è®ŠåŒ–ï¼‰
  try{
    const AC = window.AudioContext || window.webkitAudioContext;
    if(!AC) return;

    const ctx = new AC();
    __alarmCtx = ctx;

    const beepOnce = (t0)=>{
      const o = ctx.createOscillator();
      const g = ctx.createGain();
      o.type = 'square';                 // square æ¯”è¼ƒåƒé¬§é˜
      o.frequency.setValueAtTime(880, t0);
      o.frequency.exponentialRampToValueAtTime(1320, t0 + 0.12); // ä¸Šæ»‘é »ç‡
      g.gain.setValueAtTime(0.0001, t0);
      g.gain.exponentialRampToValueAtTime(0.18, t0 + 0.02);
      g.gain.exponentialRampToValueAtTime(0.0001, t0 + 0.18);    // å¿«é€Ÿæ”¶å°¾
      o.connect(g); g.connect(ctx.destination);
      o.start(t0);
      o.stop(t0 + 0.2);
    };

    const ringPattern = ()=>{
      // ä¸€çµ„ 3 ä¸‹ï¼Œåƒé¬§é˜ã€Œå—¶-å—¶-å—¶ã€
      const now = ctx.currentTime;
      beepOnce(now + 0.00);
      beepOnce(now + 0.28);
      beepOnce(now + 0.56);
    };

    // ç«‹å³éŸ¿ä¸€æ¬¡
    ringPattern();

    // æ¯ 1.2 ç§’é‡è¤‡ä¸€æ¬¡ï¼Œç›´åˆ°ä½¿ç”¨è€…æŒ‰ã€Œåœæ­¢æé†’ã€æˆ–è‡ªå‹•åœï¼ˆ30 ç§’ï¼‰
    __alarmStopAt = Date.now() + 30000;
    __alarmTimer = setInterval(()=>{
      if(Date.now() >= __alarmStopAt){
        stopAlarmSound();
        return;
      }
      // æŸäº›ç€è¦½å™¨æœƒæŠŠ AudioContext æš«åœï¼Œé€™è£¡å˜—è©¦å–šé†’
      try{ if(ctx.state === 'suspended') ctx.resume?.(); }catch(_){}
      ringPattern();
    }, 1200);

  }catch(_){}
}


function onTimerDone(){
      const t = ensureTimerState();
      if(t.doneNotified) return;
      t.doneNotified = true;
      try{ navigator.vibrate?.(250); }catch(_){ }
      stopTimerInterval();
      updateTimerDisplay();
      // è·³å‡ºæç¤º + éŸ³æ•ˆ
      showInAppModal('è¨ˆæ™‚çµæŸ','å€’æ•¸è¨ˆæ™‚');
      playAlarmSound();
      saveSession('timer done');
    }

    function renderTimerUI(){
      ensureTimerState();
      syncTimerFromEndAt();
      updateTimerInputs();
      updateTimerDisplay();
      if(state.timer.running) startTimerInterval();
    }


    /* ====== é¡¯ç¤ºæ¨¡å¼åˆ‡æ› ====== */
    function setMode(m){
      state.mode=m;
      document.body.dataset.mode = m;
      // â˜… åªæœ‰ã€Œlistï¼ˆåŠ æ‰£åˆ†ï¼‰ã€æ¨¡å¼é¡¯ç¤º sidebar
      document.querySelector('.layout')?.classList.toggle('sidebar-off', m!=='list');
      document.querySelector('.controls-row')?.classList.toggle('hidden', m==='progress');

      // æ¨¡å¼æŒ‰éˆ•ç‹€æ…‹
      elModeProgress?.classList.toggle('active', m==='progress');
      elModeList.classList.toggle('active', m==='list');
      elModeSeat.classList.toggle('active', m==='seat');
      elModeHW.classList.toggle('active', m==='hw');
      elModeDraw.classList.toggle('active', m==='draw');
      elModeTimer?.classList.toggle('active', m==='timer');

      // åªåœ¨ã€Œåº§ä½ã€æ¨¡å¼é¡¯ç¤ºã€Œé¡¯ç¤ºè¬›å°ã€å‹¾é¸
      elToggleStageWrap.classList.toggle('hidden', m!=='list');
      applyStageToggleUI();

      // å„é é¡¯ç¤º/éš±è—
      document.getElementById('students').classList.toggle('hidden', m!=='list');
      document.getElementById('seat-controls').classList.toggle('hidden', m!=='seat');
      document.getElementById('seatwrap').classList.toggle('hidden', m!=='seat');
      elProgressPane?.classList.toggle('hidden', m!=='progress');
      elHWPane.classList.toggle('hidden', m!=='hw');
      elDrawPane.classList.toggle('hidden', m!=='draw');
      elTimerPane?.classList.toggle('hidden', m!=='timer');

      const cls=elSelect.value;
      if(m==='seat'){ ensureSeatState(cls); renderSeatUI(cls); }
      else if(m==='list'){ renderStudents(cls); }
      else if(m==='progress'){ renderProgress(); }
      else if(m==='hw'){ renderHW(cls); }
      else if(m==='draw'){ renderDraw(cls); }
      else if(m==='timer'){ renderTimerUI(); }

      saveSession('mode change');
    }

    document.getElementById('mode-progress')?.addEventListener('click', ()=> setMode('progress'));
    document.getElementById('mode-list').addEventListener('click', ()=> setMode('list'));
    document.getElementById('mode-seat').addEventListener('click', ()=> setMode('seat'));
    document.getElementById('mode-hw').addEventListener('click', ()=> setMode('hw'));
    document.getElementById('mode-draw').addEventListener('click', ()=> setMode('draw'));
    document.getElementById('mode-timer')?.addEventListener('click', ()=> setMode('timer'));

    document.getElementById('btn-auto')?.addEventListener('click', ()=>{ autoArrange(elSelect.value); });
    document.getElementById('btn-clear')?.addEventListener('click', ()=>{ const cls=elSelect.value; const st=ensureSeatState(cls); st.map={}; saveSeatState(cls, st); renderSeatUI(cls); renderStudents(cls); renderLeaderboard(cls); });
    document.getElementById('btn-apply-size')?.addEventListener('click', ()=>{
      const cls=elSelect.value; 
      if(!cls){
        // å°šæœªè¼‰å…¥åå–®æ™‚ï¼Œåªéœ€è¦é‡ç•«ç©ºç›¤å³å¯
        renderSeatUI('');
        return;
      }
      const st=ensureSeatState(cls);
      st.rows = clampSize(elRows.value||6);
      st.cols = clampSize(elCols.value||6);
      saveSeatState(cls, st); 
      renderSeatUI(cls); 
      renderStudents(cls); 
      renderLeaderboard(cls);
    });

    /* ===== æ•™å­¸é€²åº¦ï¼šæ–°å¢/åˆªé™¤åˆ— ===== */
    
/* ===== æ•™å­¸é€²åº¦ï¼šç­ç´šæ¬„ä½æ‰‹å‹•å¢åˆª ===== */
let __progClassMask = null;
let __progClassOk = null;

function ensureProgClassModal(){
  if(__progClassMask) return;
  const mask = document.createElement('div');
  mask.id = 'progclass-mask';
  mask.className = 'modal-mask';
  mask.setAttribute('role','dialog');
  mask.setAttribute('aria-modal','true');

  mask.innerHTML = `
    <div class="modal" role="document">
      <header>
        <h3 id="progclass-title">ç­ç´š</h3>
        <button id="progclass-close" class="close" aria-label="é—œé–‰">âœ•</button>
      </header>
      <div class="content">
        <div id="progclass-content"></div>
        <div class="divider"></div>
        <div style="display:flex; gap:10px; justify-content:flex-end; align-items:center;">
          <button id="progclass-cancel" class="btn">å–æ¶ˆ</button>
          <button id="progclass-ok" class="btn primary">ç¢ºå®š</button>
        </div>
      </div>
    </div>
  `;
  document.body.appendChild(mask);

  const close = ()=>{ hideProgClassModal(); };
  mask.addEventListener('click', (e)=>{ if(e.target===mask) close(); });
  mask.querySelector('#progclass-close').addEventListener('click', close);
  mask.querySelector('#progclass-cancel').addEventListener('click', close);
  mask.querySelector('#progclass-ok').addEventListener('click', ()=>{
    try{ __progClassOk?.(__progClassMask); }catch(e){ console.warn(e); }
  });

  __progClassMask = mask;
}

function showProgClassModal({title, okText, html, body: bodyHtml, onOk, onOpen}){
  ensureProgClassModal();
  __progClassOk = onOk || null;
  __progClassMask.querySelector('#progclass-title').textContent = title || 'ç­ç´š';
  __progClassMask.querySelector('#progclass-ok').textContent = okText || 'ç¢ºå®š';
  const contentEl = __progClassMask.querySelector('#progclass-content');
  contentEl.innerHTML = (html || bodyHtml || '');
  __progClassMask.classList.add('show');
  try{ if(typeof onOpen==='function') onOpen(__progClassMask); }catch(e){ console.warn(e); }
}

function hideProgClassModal(){
  if(!__progClassMask) return;
  __progClassMask.classList.remove('show');
  __progClassOk = null;
}

function openAddProgressClass(){
  const prog = ensureProgressState();
      const p = prog.pages[prog.active];
  const all = (state.classOrder || []).slice().map(v=>String(v||'').trim()).filter(Boolean);
  const cur = (p.classes || []).slice().map(v=>String(v||'').trim()).filter(Boolean);
  const options = all.filter(cls => !cur.includes(cls));
  if(!options.length){
    showInAppModal('åŠ å…¥ç­ç´š', 'æ²’æœ‰å¯åŠ å…¥çš„ç­ç´šï¼ˆå¯èƒ½å·²å…¨éƒ¨åŠ å…¥æ•™å­¸é€²åº¦ï¼‰ã€‚');
    return;
  }

  const listHtml = options.map((c,i)=>`
    <label style="display:flex; gap:10px; align-items:center; padding:8px 0; border-bottom:1px dashed var(--line);">
      <input type="checkbox" class="progclass-addchk" value="${escapeHTML(c)}">
      <span>${escapeHTML(c)}</span>
    </label>
  `).join('');

  showProgClassModal({
    title: 'åŠ å…¥ç­ç´šåˆ°æ•™å­¸é€²åº¦',
    body: `
      <div style="display:flex; justify-content:space-between; align-items:center; gap:10px; margin-bottom:8px;">
        <div style="font-size:13px; opacity:.85;">å¯ä¸€æ¬¡å‹¾é¸å¤šå€‹ç­ç´šåŠ å…¥ã€‚</div>
        <div style="display:flex; gap:8px;">
          <button id="progclass-selall" class="btn" style="height:34px; padding:0 10px;">å…¨é¸</button>
          <button id="progclass-unsel" class="btn" style="height:34px; padding:0 10px;">å…¨ä¸é¸</button>
        </div>
      </div>
      <div style="max-height:42vh; overflow:auto; border:1px solid var(--line); border-radius:12px; padding:10px;">
        ${listHtml}
      </div>
    `,
    okText: 'åŠ å…¥',
    onOpen: (mask)=>{
      const selAll = mask.querySelector('#progclass-selall');
      const unsel  = mask.querySelector('#progclass-unsel');
      selAll?.addEventListener('click', ()=>{
        mask.querySelectorAll('.progclass-addchk').forEach(x=>{ x.checked = true; });
      });
      unsel?.addEventListener('click', ()=>{
        mask.querySelectorAll('.progclass-addchk').forEach(x=>{ x.checked = false; });
      });
    },
    onOk: (mask)=>{
      const picked = Array.from(mask.querySelectorAll('.progclass-addchk:checked'))
        .map(x=>String(x.value||'').trim())
        .filter(Boolean);

      if(!picked.length){ hideProgClassModal(); return; }

      if(!p.classes) p.classes = [];
      picked.forEach(v=>{ if(!p.classes.includes(v)) p.classes.push(v); });
      p.classes = Array.from(new Set(p.classes.map(x=>String(x||'').trim()).filter(Boolean)));

      hideProgClassModal();
      renderProgress();
      saveSession('progress add class multi');
    }
  });
}

function openDelProgressClass(){
  const prog = ensureProgressState();
      const p = prog.pages[prog.active];
  const cur = (p.classes || []).slice().map(v=>String(v||'').trim()).filter(Boolean);
  if(!cur.length){
    showInAppModal('åˆªé™¤ç­ç´š', 'ç›®å‰æ•™å­¸é€²åº¦è¡¨æ²’æœ‰ä»»ä½•ç­ç´šæ¬„ä½ã€‚');
    return;
  }

  const listHtml = cur.map(c=>`
    <label style="display:flex; gap:10px; align-items:center; padding:8px 0; border-bottom:1px dashed var(--line);">
      <input type="checkbox" class="progclass-chk" value="${escapeHTML(c)}">
      <span>${escapeHTML(c)}</span>
    </label>
  `).join('');

  showProgClassModal({
    title: 'åˆªé™¤æ•™å­¸é€²åº¦ä¸Šçš„ç­ç´šæ¬„ä½',
    body: `
      <div style="display:flex; justify-content:space-between; align-items:center; gap:10px; margin-bottom:8px;">
        <div class="hint" style="margin:0;">å¯ä¸€æ¬¡å‹¾é¸å¤šå€‹ç­ç´šåˆªé™¤ï¼ˆåªæœƒç§»é™¤æ•™å­¸é€²åº¦æ¬„ä½ï¼‰ã€‚</div>
        <div style="display:flex; gap:8px;">
          <button id="progclass-selall" class="btn" style="height:34px; padding:0 10px;">å…¨é¸</button>
          <button id="progclass-unsel" class="btn" style="height:34px; padding:0 10px;">å…¨ä¸é¸</button>
        </div>
      </div>
      <div style="max-height:42vh; overflow:auto; border:1px solid var(--line); border-radius:12px; padding:10px;">
        ${listHtml}
      </div>
    `,
    okText: 'åˆªé™¤',
    onOpen: (mask)=>{
      const selAll = mask.querySelector('#progclass-selall');
      const unsel  = mask.querySelector('#progclass-unsel');
      selAll?.addEventListener('click', ()=>{
        mask.querySelectorAll('.progclass-chk').forEach(x=>{ x.checked = true; });
      });
      unsel?.addEventListener('click', ()=>{
        mask.querySelectorAll('.progclass-chk').forEach(x=>{ x.checked = false; });
      });
    },
    onOk: (mask)=>{
      const chks = Array.from(mask.querySelectorAll('.progclass-chk:checked'))
        .map(x=>String(x.value||'').trim())
        .filter(Boolean);

      if(!chks.length){ hideProgClassModal(); return; }

      p.classes = cur.filter(c=>!chks.includes(c));

      // æ¸…æ‰æ¯åˆ— checked è£¡å°æ‡‰çš„ç­ç´š key
      p.items = (p.items||[]).map(it=>{
        if(!it || typeof it!=='object') return it;
        if(!it.checked || typeof it.checked!=='object') it.checked = {};
        chks.forEach(c=>{ try{ delete it.checked[c]; }catch(_){} });
        return it;
      });

      hideProgClassModal();
      renderProgress();
      saveSession('progress del class multi');
    }
  });
}
    function openAddProgressPage(){
      const prog = ensureProgressState();
      showProgClassModal({
        title: 'æ–°å¢åˆ†é ',
        okText: 'æ–°å¢',
        html: `
          <div style="display:flex; flex-direction:column; gap:10px;">
            <div style="font-size:13px; opacity:.85;">è«‹è¼¸å…¥åˆ†é åç¨±ï¼ˆæœƒç”¨é€™å€‹åç¨±å»ºç«‹æ–°çš„å·¥ä½œè¡¨ï¼‰ã€‚</div>
            <input id="progpage-name" class="input" type="text" placeholder="ä¾‹å¦‚ï¼šç¬¬1å–®å…ƒ / 12æœˆé€²åº¦" style="height:38px;">
            <div class="hint" style="font-size:12px; opacity:.75;">æé†’ï¼šé¿å…èˆ‡ç­ç´šå·¥ä½œè¡¨åŒåï¼Œå¯æ¸›å°‘åŒ¯å…¥æ™‚èª¤åˆ¤ã€‚</div>
          </div>
        `,
        onOpen:(mask)=>{
          const ip = mask.querySelector('#progpage-name');
          setTimeout(()=> ip?.focus(), 0);
          ip?.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ mask.querySelector('#progclass-ok')?.click(); } });
        },
        onOk:(mask)=>{
          const ip = mask.querySelector('#progpage-name');
          const name = String(ip?.value||'').trim();
          if(!name){ showInAppModal('æ–°å¢åˆ†é ', 'è«‹å…ˆè¼¸å…¥åˆ†é åç¨±ã€‚'); return false; }

          // å»é‡ï¼ˆåŒåå°±è‡ªå‹•åŠ å°¾ç¢¼ï¼‰
          let finalName = name;
          if(prog.pages[finalName]){
            let i=2;
            while(prog.pages[`${finalName}_${i}`]) i++;
            finalName = `${finalName}_${i}`;
          }

          prog.order.push(finalName);
          prog.pages[finalName] = { items: [], classes: (state.classOrder||[]).slice() };
          prog.active = finalName;
          hideProgClassModal();
          renderProgress();
          saveSession('progress add page');
        }
      });
    }

    function openDelProgressPage(){
      const prog = ensureProgressState();
      const name = prog.active;
      if((prog.order||[]).length<=1){
        showInAppModal('åˆªé™¤åˆ†é ', 'è‡³å°‘éœ€è¦ä¿ç•™ä¸€å€‹åˆ†é ã€‚');
        return;
      }

      showProgClassModal({
        title: 'åˆªé™¤åˆ†é ',
        okText: 'åˆªé™¤',
        html: `
          <div style="display:flex; flex-direction:column; gap:10px;">
            <div>ç¢ºå®šè¦åˆªé™¤åˆ†é ã€Œ<b>${escapeHTML(name)}</b>ã€å—ï¼Ÿ</div>
            <div class="hint" style="font-size:12px; opacity:.75;">åˆªé™¤å¾Œç„¡æ³•å¾©åŸï¼ˆé™¤éä½ å°šæœªé—œé–‰é é¢ä¸”å¯ç”¨ç€è¦½å™¨è¿”å›ï¼‰ã€‚</div>
          </div>
        `,
        onOk:()=>{
          // ç§»é™¤
          delete prog.pages[name];
          prog.order = (prog.order||[]).filter(n=>n!==name);
          prog.active = prog.order[0];
          hideProgClassModal();
          renderProgress();
          saveSession('progress del page');
        }
      });
    }

    
    function openRenameProgressPage(){
      const prog = ensureProgressState();
      const oldName = String(prog.active||'').trim();
      if(!oldName || !prog.pages[oldName]) return;

      showProgClassModal({
        title: 'é‡æ–°å‘½ååˆ†é ',
        okText: 'å„²å­˜',
        html: `
          <div style="display:flex; flex-direction:column; gap:10px;">
            <div>ç›®å‰åˆ†é ï¼š<b>${escapeHTML(oldName)}</b></div>
            <input id="progpage-rename" class="input" type="text" value="${escapeHTML(oldName)}" style="height:38px;">
            <div class="hint" style="font-size:12px; opacity:.75;">æç¤ºï¼šé›™æ“Šåˆ†é ä¸‹æ‹‰é¸å–®æˆ–åˆ†é è³‡è¨Šï¼Œä¹Ÿå¯ä»¥å¿«é€Ÿé‡æ–°å‘½åã€‚</div>
          </div>
        `,
        onOpen:(mask)=>{
          const ip = mask.querySelector('#progpage-rename');
          setTimeout(()=>{ ip?.focus(); try{ ip?.select(); }catch(_){} }, 0);
          ip?.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ mask.querySelector('#progclass-ok')?.click(); } });
        },
        onOk:(mask)=>{
          const ip = mask.querySelector('#progpage-rename');
          const newName0 = String(ip?.value||'').trim();
          if(!newName0){ showInAppModal('é‡æ–°å‘½ååˆ†é ', 'è«‹è¼¸å…¥æ–°çš„åˆ†é åç¨±ã€‚'); return false; }

          const newName = newName0;
          if(newName === oldName){
            hideProgClassModal();
            return;
          }
          if(prog.pages[newName]){
            showInAppModal('é‡æ–°å‘½ååˆ†é ', 'æ­¤åç¨±å·²å­˜åœ¨ï¼Œè«‹æ›ä¸€å€‹ã€‚');
            return false;
          }

          // 1) pages key è½‰ç§»
          prog.pages[newName] = prog.pages[oldName];
          delete prog.pages[oldName];

          // 2) order èˆ‡ active æ›´æ–°
          prog.order = (prog.order||[]).map(n=> n===oldName ? newName : n);
          prog.active = newName;

          hideProgClassModal();
          renderProgress();
          saveSession('progress rename page');
        }
      });
    }
function bindProgressPageUI(){
      elProgPageSel?.addEventListener('change', ()=>{
        const prog = ensureProgressState();
        const v = String(elProgPageSel.value||'').trim();
        if(v && prog.pages[v]){
          prog.active = v;
          renderProgress();
          saveSession('progress switch page');
        }
      });
      // é›™æ“Šåˆ†é åç¨±ï¼šå¿«é€Ÿé‡æ–°å‘½å
      elProgPageSel?.addEventListener('dblclick', ()=>{ openRenameProgressPage(); });
      elProgPill?.addEventListener('dblclick', ()=>{
        if(document.body?.dataset?.mode==='progress') openRenameProgressPage();
      });

      // åˆ†é é¸å–®ï¼šæŠŠã€Œæ–°å¢/åˆªé™¤åˆ†é ã€æ¿ƒç¸®åˆ°åŒä¸€å€‹é¸å–®å…§
      function closeProgPageMenu(){
        elProgPageMenu?.classList.add('hidden');
        if(elProgPageMenuBtn) elProgPageMenuBtn.setAttribute('aria-expanded','false');
      }
      function toggleProgPageMenu(){
        if(!elProgPageMenu) return;
        const willOpen = elProgPageMenu.classList.contains('hidden');
        if(willOpen){
          elProgPageMenu.classList.remove('hidden');
          elProgPageMenuBtn?.setAttribute('aria-expanded','true');
        }else{
          closeProgPageMenu();
        }
      }
      elProgPageMenuBtn?.addEventListener('click', (e)=>{ e.stopPropagation(); toggleProgPageMenu(); });
      elProgPageMenu?.addEventListener('click', (e)=>{
        const btn = e.target?.closest?.('[data-action]');
        if(!btn) return;
        const act = btn.getAttribute('data-action');
        closeProgPageMenu();
        if(act==='add') openAddProgressPage();
        if(act==='ren') openRenameProgressPage();
        if(act==='del') openDelProgressPage();
      });
      document.addEventListener('click', (e)=>{
        if(!elProgPageMenu || elProgPageMenu.classList.contains('hidden')) return;
        // é»é¸é¸å–®å¤–éƒ¨å°±é—œé–‰
        if(elProgPageMenu.contains(e.target) || elProgPageMenuBtn?.contains(e.target)) return;
        closeProgPageMenu();
      });
      window.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeProgPageMenu(); });

      // é€²åº¦æ¨¡å¼ä¸Šçš„å­¸ç”ŸæŒ‰éˆ•ï¼šç›´æ¥å‘¼å«åŸæœ¬ sidebar çš„è¡Œç‚º
    }

elProgAdd?.addEventListener('click', ()=>{
      const prog = ensureProgressState();
      const pg = prog.pages[prog.active];
      pg.items.push({ title:'', checked:{} });
      renderProgress();
      saveSession('progress add');
      setTimeout(()=>{ elProgTable?.querySelector('tbody tr:last-child .prog-input')?.focus(); }, 0);
    });
    elProgDel?.addEventListener('click', ()=>{
      const prog = ensureProgressState();
      const pg = prog.pages[prog.active];
      if(pg.items.length>1) pg.items.pop();
      else if(pg.items.length===1) pg.items[0] = { title:'', checked:{} };
      renderProgress();
      saveSession('progress del');
    });

    elProgAddClass?.addEventListener('click', openAddProgressClass);
    elProgDelClass?.addEventListener('click', openDelProgressClass);

    bindProgressPageUI();

    /* ===== å€’æ•¸è¨ˆæ™‚ï¼šæŒ‰éˆ• ===== */
    elTimerSet?.addEventListener('click', ()=>{
      const mm = Math.max(0, Number(elTimerMin?.value||0) || 0);
      const ss = Math.min(59, Math.max(0, Number(elTimerSec?.value||0) || 0));
      setTimerSeconds(mm*60 + ss);
    });
    elTimerStart?.addEventListener('click', startTimer);
    elTimerPause?.addEventListener('click', pauseTimer);
    elTimerReset?.addEventListener('click', resetTimer);
    document.querySelectorAll('#timer-pane .timer-presets .btn[data-preset]').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const sec = Number(btn.dataset.preset)||0;
        setTimerSeconds(sec);
      });
    });

    // rippleï¼ˆå¯é¸ï¼‰
    if (typeof bindRipple === 'function'){
      [elProgAdd, elProgDel, elTimerSet, elTimerStart, elTimerPause, elTimerReset]
        .filter(Boolean)
        .forEach(b=> bindRipple(b));
      document.querySelectorAll('#timer-pane .timer-presets .btn[data-preset]').forEach(b=> bindRipple(b));
    }




    // å•Ÿå‹•ï¼šå…ˆå˜—è©¦å¾æœ¬æ©Ÿæš«å­˜é‚„åŸï¼›å¤±æ•—æ‰é¡¯ç¤ºç©ºç•«é¢
    if (!tryRestoreSession()) {
      setMode('list');
    }


    /* ===== èªªæ˜å½ˆçª— ===== */
    function openHelp(){ if(helpSrc&&helpContent){ helpContent.innerHTML=helpSrc.innerHTML; const dlBtn = helpContent.querySelector('#btn-dl-sample'); dlBtn?.addEventListener('click', (e)=>{ e.preventDefault(); downloadSampleWorkbook(); });} helpMask.classList.add('show'); helpClose?.focus(); const onKey=(e)=>{ if(e.key==='Escape'){ closeHelp(); } }; window.addEventListener('keydown', onKey, { once:true }); helpMask.addEventListener('click', (e)=>{ if(e.target===helpMask){ closeHelp(); } }, { once:true }); }
    function closeHelp(){ helpMask.classList.remove('show'); }
    helpBtn?.addEventListener('click', ()=>{ bindRipple(helpBtn); openHelp(); });
    document.getElementById('help-close')?.addEventListener('click', closeHelp);

    /* ===== â˜… ç”¢ç”Ÿç¯„ä¾‹ Excelï¼š2 å€‹ç­ç´š Ã— å„ 30 ä½ ===== */
    function buildSampleSheet(classKey, sheetName){
      // ä½¿ç”¨ç³»çµ±æ—¢æœ‰çš„æ¬„ä½åç¨±å¸¸æ•¸ï¼Œé¿å…æ‰“éŒ¯
      const header = ['å­¸è™Ÿ','åº§è™Ÿ','å§“å','åˆ†æ•¸','åº§ä½åˆ—','åº§ä½æ¬„','ä½œæ¥­1','å‚™è¨»'];
      const aoa = [header];

      for(let i=1;i<=30;i++){
        const seat = i;                                    // åº§è™Ÿ 1~30
        const sid  = `${classKey}${String(i).padStart(3,'0')}`; // å­¸è™Ÿï¼šA001/B001...ï¼Œè·¨ç­ä¸æœƒé‡è¤‡
        const name = `å­¸ç”Ÿ${String(i).padStart(2,'0')}`;        // å§“åï¼šå­¸ç”Ÿ01 ~ å­¸ç”Ÿ30
        // åˆ†æ•¸/ä½œæ¥­/åº§ä½åˆ—/åº§ä½æ¬„ å…ˆç•™ç©ºï¼Œä½¿ç”¨è€…å¯è‡ªè¡Œå¡«
        aoa.push([sid, seat, name, '', '', '', '', '']);
      }

      const ws = XLSX.utils.aoa_to_sheet(aoa);
      ws['!cols'] = [{wch:12},{wch:6},{wch:12},{wch:8},{wch:8},{wch:8},{wch:8},{wch:8}];
      return { ws, sheetName };
    }

    function buildSampleWorkbook(){
      const wb = XLSX.utils.book_new();
      const s1 = buildSampleSheet('A', 'ç­ç´šA');
      const s2 = buildSampleSheet('B', 'ç­ç´šB');
      XLSX.utils.book_append_sheet(wb, s1.ws, s1.sheetName);
      XLSX.utils.book_append_sheet(wb, s2.ws, s2.sheetName);
      return wb;
    }

    function downloadSampleWorkbook(){
      const wb = buildSampleWorkbook();
      XLSX.writeFile(wb, 'å¹³æ™‚æˆç¸¾_ç¯„ä¾‹.xlsx');
    }

    /* ===== å§“åè‡ªå‹•ç¸®å­— ===== */
    let nameResizeObserver=null;
    function setupAutoFitForNames(root){
      if(nameResizeObserver){ nameResizeObserver.disconnect(); }
      nameResizeObserver = new ResizeObserver(entries=>{ for(const e of entries){ fitName(e.target); }});
      const targets=root.querySelectorAll('.card .name');
      targets.forEach(t=>{ nameResizeObserver.observe(t); fitName(t); });
      window.addEventListener('resize', onWindowResizeFit, { passive:true });
    }
    let fitTimer=null;
    function onWindowResizeFit(){ clearTimeout(fitTimer); fitTimer=setTimeout(()=>{ document.querySelectorAll('.card .name').forEach(fitName); }, 60); }
    function fitName(nameEl){
      const textEl=nameEl.querySelector('.student-name'); if(!textEl) return;
      const MAX=14, MIN=11; textEl.style.fontSize=MAX+'px';
      const canFit=()=> nameEl.scrollWidth <= nameEl.clientWidth + 0.5;
      if(canFit()) return;
      let size=MAX; while(size>MIN){ size-=0.5; textEl.style.fontSize=size+'px'; if(canFit()) break; }
    }

    /* ===== â˜… ä½œæ¥­æˆç¸¾ï¼šç‹€æ…‹ + UI ===== */
    function ensureHWState(cls){
      if(!cls) return { cols:[], data:{} };
      if(!state.hw[cls]){ loadHWFromLS(cls); if(!state.hw[cls]) state.hw[cls]={ cols:[], data:{} }; }
      return state.hw[cls];
    }
    function nextHWName(cols){
      const nums=cols.map(n=>{ const m=n.match(/(\d+)/); return m?Number(m[1]):0; }).filter(Number.isFinite);
      const next=(nums.length?Math.max(...nums):0)+1;
      return `ä½œæ¥­${next}`;
    }
    function getSortedList(cls){
      const list=(state.classMap[cls]||[]).slice();
      list.sort((a,b)=>{ const na=Number(a.seat), nb=Number(b.seat); if(!Number.isNaN(na)&&!Number.isNaN(nb)&&na!==nb) return na-nb; return a.name.localeCompare(b.name,'zh-Hant'); });
      return list;
    }

    function renderHW(cls){
      if(!cls){ elHWTable.innerHTML=''; elHWClassPill.textContent='æœªé¸æ“‡'; return; }
      const hw=ensureHWState(cls);
      const list=getSortedList(cls);
      const q = state.filter.trim().toLowerCase();
      elHWClassPill.textContent=cls;

      list.forEach(s=>{ if(!hw.data[s.id]) hw.data[s.id]=[]; const arr=hw.data[s.id]; while(arr.length<hw.cols.length) arr.push(''); });

      const th = `
        <thead>
          <tr>
            <th style="min-width:64px">åº§è™Ÿ</th>
            <th style="min-width:120px">å§“å</th>
            ${hw.cols.map((c,i)=>`<th class="num hw-col"><span class="hw-col-name">${escapeHTML(c)}</span> <button class="mini-btn" data-col="${i}" title="æ‰¹æ¬¡è¼¸å…¥é€™ä¸€æ¬„">âš¡</button></th>`).join('')}
            <th class="num">å°è¨ˆ</th>
            <th class="num">å¹³å‡</th>
          </tr>
        </thead>`;

      const rows = list.map(s=>{
        const arr=(hw.data[s.id]||[]).slice(0, hw.cols.length);
        while(arr.length<hw.cols.length) arr.push('');
        const sum=arr.reduce((t,v)=> t + (Number.isFinite(Number(v))?Number(v):0), 0);
        const cnt=arr.filter(v=> v!=='' && v!=null).length;
        const avg=cnt? (sum/cnt) : 0;
        const isHit = q && matchFilter(s, q);
        return `
          <tr data-id="${s.id}" class="${isHit?'match':''}">
            <td><div class="hw-seatcell"><button class="note-btn" data-note-id="${s.id}" title="å‚™è¨»">${getNote(cls, s.id)?'ğŸ—’ï¸':'ğŸ“'}</button><span class="hw-seattext">${highlightSeat(s.seat||'', isHit ? q : '')}</span></div></td>
            <td>${isHit ? highlightHTML(s.name||'', q) : escapeHTML(s.name||'')}</td>
            ${arr.map((v,ci)=>`<td class="num"><input type="number" step="1" inputmode="numeric" value="${v!==''?String(v):''}" data-col="${ci}" /></td>`).join('')}
            <td class="num" data-sum>${sum}</td>
            <td class="num" data-avg>${avg.toFixed(2)}</td>
          </tr>`;
      }).join('');

      elHWTable.innerHTML = th + `<tbody>${rows || '<tr><td colspan="999" class="hint">å°šç„¡å­¸ç”Ÿè³‡æ–™</td></tr>'}</tbody>`;

      // æ¬„ä½è¼¸å…¥å³æ™‚æ›´æ–°
      elHWTable.querySelectorAll('tbody tr').forEach(tr=>{
        const id=tr.getAttribute('data-id');
        tr.querySelectorAll('input[type="number"]').forEach(inp=>{
          inp.addEventListener('input', ()=>{
            const col=Number(inp.getAttribute('data-col'));
            const raw=inp.value.trim(); const val=raw===''? '' : Number(raw);
            const arr=hw.data[id] || (hw.data[id]=[]);
            arr[col]= (raw==='' ? '' : (Number.isFinite(val)?val:''));
            const sum = (arr.slice(0, hw.cols.length)).reduce((t,v)=> t + (Number.isFinite(Number(v))? Number(v):0), 0);
            const cnt = arr.slice(0, hw.cols.length).filter(v=> v!=='' && v!=null).length;
            tr.querySelector('[data-sum]').textContent = sum;
            tr.querySelector('[data-avg]').textContent = (cnt? (sum/cnt):0).toFixed(2);
            saveHWToLS(cls);
          });
        });
      });


      // ç¶å®šã€Œå­¸ç”Ÿå‚™è¨»ã€æŒ‰éˆ•
      elHWTable.querySelectorAll('.note-btn[data-note-id]').forEach(btn=>{
        btn.addEventListener('click', (e)=>{
          e.preventDefault(); e.stopPropagation();
          const id = btn.getAttribute('data-note-id');
          const stu = (state.classMap[cls]||[]).find(x=>x.id===id);
          const label = stu ? `${(stu.seat||'').toString().trim()?('åº§è™Ÿ '+stu.seat+' '):''}${stu.name||''}${(stu.sid||'')?(' ('+stu.sid+')'):''}` : id;
          openNoteModal(cls, id, label);
        });
      });


      // ç¶å®šæ¯å€‹ä½œæ¥­æ¬„çš„âš¡æ‰¹æ¬¡è¼¸å…¥
      elHWTable.querySelectorAll('.mini-btn[data-col]').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          openBulkModal(cls, Number(btn.getAttribute('data-col')));
        });
      });

      // æ§åˆ¶éˆ•ï¼ˆæ–°å¢/åˆªé™¤ä½œæ¥­ï¼‰
      elHWAdd.onclick = ()=>{
        const name=nextHWName(hw.cols); hw.cols.push(name);
        list.forEach(s=>{ const arr=hw.data[s.id]||(hw.data[s.id]=[]); while(arr.length<hw.cols.length) arr.push(''); });
        saveHWToLS(cls); renderHW(cls);
        saveSession('hw cols change'); // â˜… æ–°å¢
      };
      elHWDel.onclick = ()=>{
        if(hw.cols.length===0) return; hw.cols.pop();
        Object.keys(hw.data).forEach(id=>{ const arr=hw.data[id]; if(Array.isArray(arr) && arr.length>hw.cols.length) arr.length=hw.cols.length; });
        saveHWToLS(cls); renderHW(cls);
        saveSession('hw cols change'); // â˜… æ–°å¢
      };

      // â¤µ æœå°‹æ™‚è‡ªå‹•æ²åˆ°ç¬¬ä¸€å€‹å‘½ä¸­çš„åˆ—
      if(q){
        const wrap = document.querySelector('.hwtbl-wrap');
        const first = elHWTable.querySelector('tbody tr.match');
        if(first){ first.scrollIntoView({ behavior:'smooth', block:'center' }); }
      }
    }

    /* ===== ğŸ² æŠ½è™Ÿ â€” ç‹€æ…‹ã€å·¥å…·ã€UIï¼ˆæ–°ç‰ˆï¼‰ ===== */
    function ensureDrawState(cls){
      if(!cls) return { unique:true, seqText:'', seqPos:0, lastCount:1, autoScore:false, history:[], drawn:[] };
      if(!state.draw) state.draw = {};
      if(!state.draw[cls]){
        try{
          const raw = localStorage.getItem('draw_v1__' + cls);
          state.draw[cls] = raw ? JSON.parse(raw) : {};
        }catch{ state.draw[cls] = {}; }
      }
      const d = state.draw[cls];
      d.unique    = !!d.unique;
      d.seqText   = String(d.seqText ?? '');
      d.seqPos    = Number(d.seqPos ?? 0) || 0;
      d.lastCount = Math.max(1, Number(d.lastCount ?? 1) || 1);
      d.autoScore = !!d.autoScore;
      d.history   = Array.isArray(d.history) ? d.history : [];
      d.drawn     = Array.isArray(d.drawn) ? d.drawn : [];
      return d;
    }
    function saveDrawToLS(cls){
      try{ localStorage.setItem('draw_v1__' + cls, JSON.stringify(state.draw[cls]||{})); saveSession('draw change'); }catch{}
    }

    function parseSeq(text){
      return String(text||'')
        .split(/[ï¼Œã€,\s]+/)
        .map(s=>Number(s))
        .filter(n=>Number.isFinite(n) && n>=1)
        .map(n=>Math.floor(n));
    }
    function pickN(arr, n){
      n = Math.max(0, Math.min(n, arr.length));
      const a = arr.slice();
      const rnd = (max)=> {
        if(window.crypto?.getRandomValues){
          const u32 = new Uint32Array(1); window.crypto.getRandomValues(u32);
          return u32[0] % max;
        }else{
          return Math.floor(Math.random()*max);
        }
      };
      for(let i=a.length-1;i>0;i--){
        const j = rnd(i+1);
        [a[i], a[j]] = [a[j], a[i]];
      }
      return a.slice(0, n);
    }
    function fmtDateTime(ts){
      const d = new Date(ts);
      const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,'0'), dd=String(d.getDate()).padStart(2,'0');
      const hh=String(d.getHours()).padStart(2,'0'), mm=String(d.getMinutes()).padStart(2,'0'), ss=String(d.getSeconds()).padStart(2,'0');
      return `${y}/${m}/${dd} ${hh}:${mm}:${ss}`;
    }

    function renderDraw(cls){
      elDrawClassPill.textContent = cls || 'æœªé¸æ“‡';

      if(!cls){
        elDrawHint.textContent = 'è«‹å…ˆä¸Šå‚³å­¸ç”Ÿåå–®';
        elDrawResult.innerHTML = '';
        elDrawHistory.classList.add('empty');
        elDrawHistory.innerHTML = 'å°šç„¡ç´€éŒ„';
        elDrawRem.textContent='--'; elDrawTotal.textContent='--'; elDrawNext.textContent='--';
        return;
      }

      const d = ensureDrawState(cls);
      // åŒæ­¥ UI æ§åˆ¶
      elDrawCount.value = d.lastCount;
      elDrawSeq.value   = d.seqText;
      elDrawUnique.checked = d.unique;
      elDrawAuto.checked   = d.autoScore;

      // åå–® & å€™é¸
      const list = (state.classMap[cls]||[]).slice();
      const drawnSet = new Set(d.drawn);
      const candidates = d.unique ? list.filter(s=>!drawnSet.has(s.id)) : list;

      // çµ±è¨ˆ
      elDrawTotal.textContent = String(list.length);
      elDrawRem.textContent   = String(candidates.length);

      const seq = parseSeq(d.seqText);
      const nextN = seq.length ? seq[d.seqPos % seq.length] : d.lastCount;
      elDrawNext.textContent = String(nextN);

      const tips = d.unique
        ? `å¯æŠ½åé¡ï¼š${candidates.length}/${list.length}ï¼ˆä¸é‡è¦†ï¼‰`
        : `å¯æŠ½åé¡ï¼š${candidates.length}ï¼ˆå¯é‡è¦†ï¼‰`;
      elDrawHint.textContent = tips;

      // æ­·å²
      if(!d.history.length){
        elDrawHistory.classList.add('empty');
        elDrawHistory.textContent = 'å°šç„¡ç´€éŒ„';
      }else{
        elDrawHistory.classList.remove('empty');
        const byId = new Map(list.map(s=>[s.id, s]));
        elDrawHistory.innerHTML = d.history.map(h=>{
          const chips = (h.ids||[]).map(id=>{
            const s = byId.get(id);
            if(!s) return '';
            const seat = s.seat ? `#${padSeat(s.seat)}` : '--';
            return `<span class="chip"><span class="seat-badge">${seat}</span><span class="student-name">${escapeHTML(s.name||'')}</span></span>`;
          }).join('');
          return `<div class="draw-row"><div class="time">(${h.count}äºº) ${fmtDateTime(h.ts||Date.now())}</div><div class="chips">${chips||'<span class="hint">ï¼ˆå·²ä¸åœ¨åå–®ï¼‰</span>'}</div></div>`;
        }).join('');
      }
    }

    // === äº‹ä»¶ï¼šæŠ½ï¼ ===
    elBtnDraw?.addEventListener('click', ()=>{
      const cls = elSelect.value;
      if(!cls) return alert('è«‹å…ˆé¸æ“‡ç­ç´š');
      const d = ensureDrawState(cls);

      const list = (state.classMap[cls]||[]).slice();
      if(!list.length) return alert('æ­¤ç­ç´šæ²’æœ‰åå–®');

      // æ±ºå®šæœ¬æ¬¡äººæ•¸
      const seq = parseSeq(elDrawSeq.value);
      let count;
      if(seq.length){
        count = seq[d.seqPos % seq.length];
        d.seqPos++;
      }else{
        count = Math.max(1, Number(elDrawCount.value)||1);
      }
      d.lastCount = count;

      // å€™é¸
      const drawnSet = new Set(d.drawn);
      const candidates = d.unique ? list.filter(s=>!drawnSet.has(s.id)) : list;
      if(candidates.length===0){
        alert('å·²ç„¡å¯æŠ½çš„äººé¸ï¼ˆä¸é‡è¦†æ¨¡å¼ï¼‰ã€‚è«‹æŒ‰ã€Œé‡ç½®ã€æˆ–å–æ¶ˆã€Œä¸é‡è¦†æŠ½å–ã€ã€‚');
        return;
      }
      if(count>candidates.length) count = candidates.length;

      const picks = pickN(candidates, count);

      // è¦–è¦ºï¼šæœ¬æ¬¡çµæœï¼ˆå¤§ç±Œç¢¼ï¼‰
      elDrawResult.innerHTML = picks.map(s=>{
        const seat = s.seat ? `#${padSeat(s.seat)}` : '--';
        return `<span class="chip big pop"><span class="seat-badge">${seat}</span><span class="student-name">${escapeHTML(s.name||'')}</span></span>`;
      }).join('');

      // æ­·å² + å·²æŠ½
      const ids = picks.map(s=>s.id);
      d.history.unshift({ ts: Date.now(), count, ids });
      if(d.history.length > 200) d.history.length = 200;

      if(d.unique){
        for(const id of ids) drawnSet.add(id);
        d.drawn = Array.from(drawnSet);
      }

      // æŠ½åˆ°å³ +1 åˆ†ï¼ˆå¯é¸ï¼‰
      if(d.autoScore && Array.isArray(last.ids)){
        last.ids.forEach(id => setScore(cls, id, Math.max(0, getScore(cls, id) - 1)));  // â˜…
        renderLeaderboard(cls);
        if(state.mode==='list') renderStudents(cls);
      }


      saveDrawToLS(cls);
      renderDraw(cls); // æ›´æ–°çµ±è¨ˆ/æ­·å²
    });

    // === äº‹ä»¶ï¼šæ’¤éŠ·æœ€è¿‘ä¸€æ¬¡ ===
    elBtnDrawUndo?.addEventListener('click', ()=>{
      const cls = elSelect.value; if(!cls) return;
      const d = ensureDrawState(cls);
      const last = d.history.shift();
      if(!last){ alert('æ²’æœ‰å¯æ’¤éŠ·çš„ç´€éŒ„'); return; }
      if(d.unique && Array.isArray(last.ids)){
        const set = new Set(d.drawn);
        last.ids.forEach(id=> set.delete(id));
        d.drawn = Array.from(set);
      }
      // å¦‚æœæœ‰è‡ªå‹•åŠ åˆ†ï¼Œä¹Ÿä¸€èµ·å›é€€
      if(d.autoScore && Array.isArray(last.ids)){
        last.ids.forEach(id=>{
          state.scores[id] = Math.max(0, Number(state.scores[id]||0) - 1);
        });
        try{ localStorage.setItem('scores_v1', JSON.stringify(state.scores)); saveSession('score undo by draw'); }catch{}
        renderLeaderboard(cls);
        if(state.mode==='list') renderStudents(cls);
      }
      saveDrawToLS(cls);
      elDrawResult.innerHTML = '';
      renderDraw(cls);
    });

    // === äº‹ä»¶ï¼šé‡ç½® ===
    elBtnDrawReset?.addEventListener('click', ()=>{
      const cls = elSelect.value; if(!cls) return;
      const d = ensureDrawState(cls);
      d.drawn = []; d.history = []; d.seqPos = 0;
      saveDrawToLS(cls);
      elDrawResult.innerHTML = '';
      renderDraw(cls);
    });

    // === äº‹ä»¶ï¼šæ§åˆ¶è®Šæ›´ï¼ˆå³å­˜å³ç”¨ï¼‰ ===
    elDrawUnique?.addEventListener('change', ()=>{
      const cls = elSelect.value; if(!cls) return;
      const d = ensureDrawState(cls); d.unique = !!elDrawUnique.checked;
      saveDrawToLS(cls); renderDraw(cls);
    });
    elDrawAuto?.addEventListener('change', ()=>{
      const cls = elSelect.value; if(!cls) return;
      const d = ensureDrawState(cls); d.autoScore = !!elDrawAuto.checked;
      saveDrawToLS(cls); renderDraw(cls);
    });
    elDrawSeq?.addEventListener('input', ()=>{
      const cls = elSelect.value; if(!cls) return;
      const d = ensureDrawState(cls); d.seqText = String(elDrawSeq.value||''); d.seqPos = 0;
      saveDrawToLS(cls); renderDraw(cls);
    });
    elDrawCount?.addEventListener('change', ()=>{
      const cls = elSelect.value; if(!cls) return;
      const d = ensureDrawState(cls);
      const n = Math.max(1, Number(elDrawCount.value)||1);
      d.lastCount = n; elDrawCount.value = n;
      saveDrawToLS(cls); renderDraw(cls);
    });

    // === äº‹ä»¶ï¼šå¿«é€Ÿé è¨­äººæ•¸ ===
    document.querySelectorAll('.presets .btn[data-preset]').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const n = Number(btn.getAttribute('data-preset'))||1;
        elDrawCount.value = n;
        const evt = new Event('change'); elDrawCount.dispatchEvent(evt);
      });
    });


    /* ===== â˜… æ‰¹æ¬¡è¼¸å…¥å½ˆçª—é‚è¼¯ ===== */
    function openBulkModal(cls, colIndex){
      const hw=ensureHWState(cls); if(colIndex<0 || colIndex>=hw.cols.length) return;
      bulkMask.dataset.cls=cls; bulkMask.dataset.col=String(colIndex);
      const colName=hw.cols[colIndex] || `ä½œæ¥­${colIndex+1}`;
      bulkColName.textContent = colName;
      bulkColName2.textContent = colName;
      bulkClass.textContent = cls;
      bulkSameVal.value = '';
      bulkOnlyEmpty1.checked = false;
      bulkOnlyEmpty2.checked = false;
      bulkPaste.value = '';
      bulkMask.classList.add('show');
      bulkSameVal.focus();

      const onKey=(e)=>{ if(e.key==='Escape'){ closeBulkModal(); } };
      window.addEventListener('keydown', onKey, { once:true });
      bulkMask.addEventListener('click', (e)=>{ if(e.target===bulkMask){ closeBulkModal(); } }, { once:true });
    }
    function closeBulkModal(){ bulkMask.classList.remove('show'); }
    bulkClose.addEventListener('click', closeBulkModal);


    // å­¸ç”Ÿå‚™è¨»å½ˆçª—ï¼ˆä½œæ¥­æˆç¸¾ï¼‰
    let _noteCtx = { cls:'', id:'', label:'' };

    
    function _noteCountText(v){
      const s = (v||'').toString();
      // ä»¥ code points è¨ˆç®—ï¼Œä¸­æ–‡/emoji ä¹Ÿæ¯”è¼ƒæº–
      try{ return Array.from(s).length; }catch{ return s.length; }
    }
    function _updateNoteCount(){
      if(!noteCount) return;
      noteCount.textContent = String(_noteCountText(noteText?.value || ''));
    }
    function _autoSizeNote(){
      if(!noteText) return;
      // è‡ªå‹•é•·åˆ°å…§å®¹é«˜åº¦ï¼ˆä½†ä¸è¶…éè¦–çª—é«˜åº¦çš„ä¸€åŠå·¦å³ï¼‰
      noteText.style.height = 'auto';
      const cap = Math.max(220, Math.floor(window.innerHeight * 0.55));
      noteText.style.height = Math.min(noteText.scrollHeight + 2, cap) + 'px';
    }
function openNoteModal(cls, id, label){
      if(!noteMask) return;
      _noteCtx = { cls: cls||'', id: id||'', label: label||'' };

      noteClass.textContent = _noteCtx.cls || '';
      noteStudent.textContent = _noteCtx.label || _noteCtx.id || '';
      noteText.value = getNote(_noteCtx.cls, _noteCtx.id);
      _updateNoteCount();
      // é–‹å•Ÿæ™‚å…ˆæŠŠé«˜åº¦æ‹‰åˆ°èˆ’æœçš„å¤§å°
      _autoSizeNote();

      noteMask.classList.add('show');
      noteText.focus();

      // Ctrl/âŒ˜ + Enter å¿«é€Ÿå„²å­˜
      noteText.onkeydown = (e)=>{
        if((e.ctrlKey || e.metaKey) && e.key === 'Enter'){
          e.preventDefault();
          noteSave?.click();
        }
      };

      const onKey=(e)=>{ if(e.key==='Escape'){ closeNoteModal(); } };
      window.addEventListener('keydown', onKey, { once:true });
      noteMask.addEventListener('click', (e)=>{ if(e.target===noteMask){ closeNoteModal(); } }, { once:true });
    }
    function closeNoteModal(){
      if(noteMask) noteMask.classList.remove('show');
    }
    noteClose?.addEventListener('click', closeNoteModal);

    

    noteCancel?.addEventListener('click', closeNoteModal);
    noteText?.addEventListener('input', ()=>{ _updateNoteCount(); _autoSizeNote(); });
noteSave?.addEventListener('click', ()=>{
      if(!_noteCtx.cls || !_noteCtx.id) return;
      setNote(_noteCtx.cls, _noteCtx.id, noteText.value);
      // ç«‹å³åˆ·æ–°ä½œæ¥­è¡¨ï¼šæ›´æ–°åœ–ç¤ºç‹€æ…‹
      if(state.mode==='hw') renderHW(_noteCtx.cls);
      saveSession('note save');
      closeNoteModal();
    });
    noteDel?.addEventListener('click', ()=>{
      if(!_noteCtx.cls || !_noteCtx.id) return;
      noteText.value = '';
      setNote(_noteCtx.cls, _noteCtx.id, '');
      if(state.mode==='hw') renderHW(_noteCtx.cls);
      saveSession('note clear');
      closeNoteModal();
    });

    // åˆªé™¤å­¸ç”Ÿå½ˆçª—
    function openDelModal(cls){
      if(!delMask || !delSelect){
        alert('ä»‹é¢å°šæœªæº–å‚™å®Œæˆ');
        return;
      }
      if(!cls){
        alert('è«‹å…ˆé¸æ“‡ç­ç´š');
        return;
      }
      const list = getSortedList(cls);
      if(!list || list.length===0){
        alert('æœ¬ç­ç›®å‰æ²’æœ‰å­¸ç”Ÿå¯ä»¥åˆªé™¤');
        return;
      }

      delClass.textContent = cls;
      delSelect.innerHTML = '';

      // â˜… å°é½Šï¼šåº§è™Ÿç”¨ 0 è£œé½Šä½æ•¸ï¼Œæ­é…ç­‰å¯¬å­—/è¡¨æ ¼æ•¸å­—
      const seatNums = list
        .map(x => parseInt(String(x.seat||'').trim(), 10))
        .filter(n => Number.isFinite(n));
      const seatW = seatNums.length ? String(Math.max(...seatNums)).length : 2;

      const nameLens = list.map(x => {
        const nm = String(x.name||'').trim();
        return (nm ? nm : '(æœªå‘½å)').length;
      });
      const nameW = nameLens.length ? Math.max(2, ...nameLens) : 2;

      list.forEach(s=>{
        const opt = document.createElement('option');
        const seatRaw = String(s.seat||'').trim();
        const sid  = String(s.sid||'').trim();
        const name = String(s.name||'').trim();

        const seatNum = parseInt(seatRaw, 10);
        const seatPad = Number.isFinite(seatNum)
          ? String(seatNum).padStart(seatW, '0')
          : (seatRaw || '--');

        const displayName = name || '(æœªå‘½å)';
        const namePad = displayName.padEnd(nameW, 'ã€€'); // ç”¨å…¨å½¢ç©ºç™½è£œé½Šï¼Œå…©å­—/ä¸‰å­—éƒ½æœƒå°é½Š

        // é¡¯ç¤ºæ ¼å¼ï¼š<åº§è™Ÿ>  <å§“å>  (<å­¸è™Ÿ>)
        let line = `${seatPad}  ${namePad}`;
        if(sid) line += `  (${sid})`;

        opt.textContent = line;
        opt.value = s.id;
        delSelect.appendChild(opt);
      });

      delMask.classList.add('show');
      if(delSelect.options.length>0) delSelect.selectedIndex = 0;
      delSelect.focus();

      const onKey=(e)=>{ if(e.key==='Escape'){ closeDelModal(); } };
      window.addEventListener('keydown', onKey, { once:true });
      delMask.addEventListener('click', (e)=>{ if(e.target===delMask){ closeDelModal(); } }, { once:true });
    }
    function closeDelModal(){ if(delMask) delMask.classList.remove('show'); }
    delClose?.addEventListener('click', closeDelModal);
    delConfirm?.addEventListener('click', ()=>{
      const cls = elSelect.value || delClass.textContent || '';
      if(!cls){
        alert('è«‹å…ˆé¸æ“‡ç­ç´š');
        return;
      }
      if(!delSelect || !delSelect.value){
        alert('è«‹å…ˆé¸æ“‡è¦åˆªé™¤çš„å­¸ç”Ÿ');
        return;
      }
      const id = delSelect.value;
      const list = state.classMap[cls] || [];
      const idx = list.findIndex(s=>s.id===id);
      if(idx<0){
        alert('æ‰¾ä¸åˆ°é€™ä½å­¸ç”Ÿï¼ˆå¯èƒ½å·²è¢«åˆªé™¤ï¼‰');
        closeDelModal();
        return;
      }
      if(!confirm('ç¢ºå®šè¦åˆªé™¤é€™ä½å­¸ç”Ÿå—ï¼Ÿæ­¤å‹•ä½œç„¡æ³•å¾©åŸã€‚')) return;

      // å¾ç­ç´šåå–®ç§»é™¤
      list.splice(idx,1);
      state.classMap[cls] = list;

      // sidMap
      if(state.sidMap) delete state.sidMap[id];

      // å‚™è¨»
      if(state.notes && state.notes[cls] && (id in state.notes[cls])){
        delete state.notes[cls][id];
        if(Object.keys(state.notes[cls]).length===0) delete state.notes[cls];
        saveNotes();
      }

      // åº§ä½è¡¨
      const st = ensureSeatState(cls);
      if(st && st.map){
        Object.keys(st.map).forEach(key=>{ if(st.map[key]===id) delete st.map[key]; });
        saveSeatState(cls, st);
      }

      // åŠ åˆ†æˆç¸¾
      const k = scoreKey(cls, id);
      if(k in state.scores){
        delete state.scores[k];
        try{
          localStorage.setItem('scores_v2', JSON.stringify(state.scores));
          saveSession('score delete');
        }catch{}
      }

      // ä½œæ¥­æˆç¸¾
      const hw = ensureHWState(cls);
      if(hw && hw.data && hw.data[id]){
        delete hw.data[id];
        saveHWToLS(cls);
      }

      // æŠ½è™Ÿç´€éŒ„
      if(state.draw && state.draw[cls]){
        const d = ensureDrawState(cls);
        if(Array.isArray(d.drawn)) d.drawn = d.drawn.filter(x=>x!==id);
        if(Array.isArray(d.history)) d.history = d.history.map(arr=>Array.isArray(arr)?arr.filter(x=>x!==id):arr);
        saveDrawToLS(cls);
      }

      // èˆŠç‰ˆæˆç¸¾å¿«å–
      if(state.legacyScores && (id in state.legacyScores)){
        delete state.legacyScores[id];
      }

      // æ›´æ–°ç•«é¢
      renderStudents(cls);
      renderLeaderboard(cls);
      renderSeatUI(cls);
      renderHW(cls);
      renderDraw(cls);

      saveSession('delete student');
      closeDelModal();

      if(!state.classMap[cls] || state.classMap[cls].length===0){
        alert('æ­¤ç­ç´šç›®å‰å·²æ²’æœ‰å­¸ç”Ÿã€‚');
      }
    });

    // æ•´æ¬„åŒåˆ†
    bulkApplySame.addEventListener('click', ()=>{
      const cls=bulkMask.dataset.cls; const col=Number(bulkMask.dataset.col);
      const hw=ensureHWState(cls); const list=getSortedList(cls);
      const raw=bulkSameVal.value.trim();
      if(raw===''){ alert('è«‹è¼¸å…¥åˆ†æ•¸'); return; }
      const val=Number(raw);
      if(!Number.isFinite(val)){ alert('åˆ†æ•¸éœ€ç‚ºæ•¸å­—'); return; }
      const onlyEmpty=bulkOnlyEmpty1.checked;
      list.forEach(s=>{
        const arr=hw.data[s.id] || (hw.data[s.id]=[]);
        if(onlyEmpty && arr[col]!=='' && arr[col]!=null) return;
        arr[col]=val;
      });
      saveHWToLS(cls); renderHW(cls); closeBulkModal();
    });

    // è²¼ä¸Šå¤šç­†
    bulkApplyPaste.addEventListener('click', ()=>{
      const cls=bulkMask.dataset.cls; const col=Number(bulkMask.dataset.col);
      const hw=ensureHWState(cls); const list=getSortedList(cls);
      const text=bulkPaste.value || '';
      const mode = (document.querySelector('input[name="bulk-mode"]:checked')?.value)||'order';
      const onlyEmpty=bulkOnlyEmpty2.checked;

      if(mode==='order'){
        const lines=text.split(/\r?\n/).map(s=>s.trim()).filter(s=>s.length>0);
        if(lines.length===0){ alert('æ²’æœ‰åµæ¸¬åˆ°å¯ç”¨è³‡æ–™'); return; }
        for(let i=0;i<list.length;i++){
          const s=list[i]; const token=lines[i];
          if(token==null) break;
          const n=parseNumber(token);
          if(Number.isFinite(n)){
            const arr=hw.data[s.id] || (hw.data[s.id]=[]);
            if(onlyEmpty && arr[col]!=='' && arr[col]!=null) continue;
            arr[col]=n;
          }
        }
      }else{ // seat mode
        const map=new Map(); // seat -> score
        const lines=text.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
        lines.forEach(line=>{
          const m=line.match(/^(\d+)\D+(-?\d+(?:\.\d+)?)/);
          if(m){ const seatNum=Number(m[1]); const sc=Number(m[2]); if(Number.isFinite(seatNum)&&Number.isFinite(sc)) map.set(seatNum, sc); }
        });
        if(map.size===0){ alert('æ²’æœ‰åµæ¸¬åˆ°ã€Œåº§è™Ÿ åˆ†æ•¸ã€æ ¼å¼çš„è³‡æ–™'); return; }
        list.forEach(s=>{
          const seatNum=Number(s.seat);
          if(!Number.isFinite(seatNum)) return;
          if(map.has(seatNum)){
            const arr=hw.data[s.id] || (hw.data[s.id]=[]);
            if(onlyEmpty && arr[col]!=='' && arr[col]!=null) return;
            arr[col]=map.get(seatNum);
          }
        });
      }
      saveHWToLS(cls); renderHW(cls); closeBulkModal();
    });

    function parseNumber(str){ const m=String(str).match(/-?\d+(?:\.\d+)?/); return m? Number(m[0]) : NaN; }

    /* ===== âœ… æˆç¸¾è¡¨æ ¼ï¼šæ»‘é¼ æ»¾è¼ªã€Œæ©«å‘ã€æ²å‹• + æ‹–æ›³æ²å‹• ===== */
    (function enableHorizontalScroll(){
      const wrap=document.querySelector('.hwtbl-wrap'); if(!wrap) return;

      function onWheel(e){
        if(e.ctrlKey) return;
        const hasH = wrap.scrollWidth > wrap.clientWidth + 1;
        if(!hasH) return;

        const hasV = wrap.scrollHeight > wrap.clientHeight + 1;

        let consume = false;
        let delta = 0;

        if (Math.abs(e.deltaX) > Math.abs(e.deltaY)) { delta = e.deltaX; consume = true; }
        else if (!hasV && e.deltaY !== 0) { delta = e.deltaY; consume = true; }
        else if (e.shiftKey && e.deltaY !== 0) { delta = e.deltaY; consume = true; }

        if(consume && delta !== 0){
          const maxLeft = wrap.scrollWidth - wrap.clientWidth;
          const prev = wrap.scrollLeft;
          wrap.scrollLeft = Math.max(0, Math.min(maxLeft, wrap.scrollLeft + delta));
          if (wrap.scrollLeft !== prev) {
            e.preventDefault();
            e.stopPropagation();
          }
        }
      }
      wrap.addEventListener('wheel', onWheel, { passive:false, capture:true });

      let dragging=false, startX=0, startLeft=0;
      wrap.addEventListener('mousedown', (e)=>{
        if(e.button!==0) return;
        if(e.target.closest('input,textarea,select,button')) return;
        dragging=true; startX=e.clientX; startLeft=wrap.scrollLeft;
        wrap.classList.add('grabbing');
        e.preventDefault();
      });
      window.addEventListener('mousemove', (e)=>{
        if(!dragging) return;
        wrap.scrollLeft = startLeft - (e.clientX - startX);
      });
      window.addEventListener('mouseup', ()=>{
        dragging=false; wrap.classList.remove('grabbing');
      });
    })();

    /* ===== â˜… é›¢é–‹å‰è‡ªå‹•æš«å­˜ç‹€æ…‹ ===== */
    document.addEventListener('visibilitychange', () => {
      if (document.visibilityState === 'hidden') saveSession('visibilitychange');
    });
    window.addEventListener('pagehide', () => saveSession('pagehide'));
    window.addEventListener('beforeunload', ()=> saveSession('beforeunload'));
  </script>

  <!-- In-app Modal (é¿å…ç€è¦½å™¨ alertã€Œé€™å€‹ç¶²ç«™ã€è¦–çª—) -->
  <div id="uiModal" class="ui-modal hidden" role="dialog" aria-modal="true" aria-labelledby="uiModalTitle">
    <div class="ui-modal__backdrop" data-close="1"></div>
    <div class="ui-modal__panel" role="document">
      <div class="ui-modal__title" id="uiModalTitle">æç¤º</div>
      <div class="ui-modal__msg" id="uiModalMsg"></div>
      <div class="ui-modal__actions">
        <button id="uiModalOk" class="btn primary" type="button">ç¢ºå®š</button>
      </div>
    </div>
  </div>

</body>
</html>
